# 🗄️ 数据库架构优化计划

## 📋 当前问题分析

### 1. **重复表结构问题**

#### 🏫 班级管理重复
- **`classes`表** (UUID主键) ← 被5个文件使用
- **`class_info`表** (class_name主键) ← 被3个文件使用
- **问题**: 两套班级管理系统并存，可能导致数据不一致

#### 📊 成绩存储重复  
- **`grades`表** (单科目记录) ← 被5个文件使用
- **`grade_data`表** (宽表格式) ← 被5个文件使用  
- **问题**: 两种成绩存储模式，数据同步困难

#### 🧠 知识点掌握记录重复
- **`student_knowledge_mastery`表**
- **`submission_knowledge_points`表**
- **问题**: 功能重叠，增加维护复杂度

## 🎯 优化策略

### 阶段一：数据调研与映射 (优先级: 🔥高)

1. **评估数据使用模式**
   ```sql
   -- 检查表数据量和使用频率
   SELECT 'classes' as table_name, COUNT(*) as record_count FROM classes
   UNION ALL
   SELECT 'class_info', COUNT(*) FROM class_info
   UNION ALL  
   SELECT 'grades', COUNT(*) FROM grades
   UNION ALL
   SELECT 'grade_data', COUNT(*) FROM grade_data;
   ```

2. **分析数据关联性**
   - 检查是否存在孤立数据
   - 识别外键依赖关系
   - 评估数据迁移的复杂度

### 阶段二：统一班级管理 (优先级: 🔥高)

**建议方案**: 统一使用 `class_info` 表
- ✅ 使用业务友好的 `class_name` 作为主键
- ✅ 字段更完整 (grade_level, academic_year等)
- ✅ 与实际业务逻辑更匹配

**迁移步骤**:
1. 创建数据映射脚本
2. 更新所有引用 `classes` 的代码
3. 数据迁移验证
4. 逐步废弃 `classes` 表

### 阶段三：成绩存储优化 (优先级: 🔶中)

**现状分析**:
- `grade_data`: 宽表，适合快速查询和分析
- `grades`: 窄表，适合灵活的单科目操作

**推荐方案**: 双表协同
- **主表**: `grade_data` (用于分析和报表)
- **辅助表**: `grades` (用于预警和单科目操作)  
- **同步机制**: 通过触发器或ETL保持数据一致性

### 阶段四：知识点系统整合 (优先级: 🔶中)

**统一为**: `student_knowledge_mastery`
- 更完整的字段定义
- 更好的业务语义
- 支持历史记录追踪

## 🛠️ 实施建议

### 立即可执行 (本周)

1. **创建数据检查脚本**
   ```bash
   # 使用已恢复的检查脚本
   node check-database.js
   node check-tables.ts
   ```

2. **备份关键数据**
   ```sql
   -- 备份班级数据
   CREATE TABLE classes_backup AS SELECT * FROM classes;
   CREATE TABLE class_info_backup AS SELECT * FROM class_info;
   ```

### 中期规划 (本月)

1. **代码重构准备**
   - 创建统一的数据访问层
   - 实现适配器模式处理双表兼容

2. **渐进式迁移**
   - 首先统一班级管理系统
   - 然后优化成绩存储结构

### 长期目标 (下个月)

1. **性能优化**
   - 添加必要的索引
   - 实施分区策略
   - 优化查询性能

2. **监控和维护**
   - 建立数据质量监控
   - 定期清理冗余数据

## ⚠️ 风险评估

### 🔴 高风险项
- **数据丢失**: 迁移过程中的数据安全
- **服务中断**: 系统升级期间的可用性
- **业务影响**: 预警系统和分析功能的稳定性

### 🛡️ 缓解措施
- 完整的数据备份策略
- 分阶段渐进式迁移
- 充分的测试验证
- 回滚预案准备

## 📊 成功指标

- [ ] 消除表结构重复
- [ ] 数据一致性检查通过  
- [ ] 查询性能提升 >20%
- [ ] 代码复杂度降低
- [ ] 维护成本减少

## 🎯 下一步行动

1. **评估现有数据**: 运行数据检查脚本
2. **制定详细迁移计划**: 基于数据评估结果
3. **代码适配**: 创建兼容层
4. **测试验证**: 在开发环境测试
5. **生产部署**: 分阶段执行迁移

---
**文档版本**: v1.0  
**创建日期**: 2025年8月27日  
**负责人**: Claude Code Assistant
**状态**: 📋 计划中