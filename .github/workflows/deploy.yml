name: ðŸš€ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    name: ðŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ðŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ðŸ“ æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ SSH è¿žæŽ¥å¹¶éƒ¨ç½²
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            echo "========================================"
            echo "ðŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
            echo "========================================"

            # ç¡®ä¿æœ‰æœ€æ–°çš„éƒ¨ç½²è„šæœ¬
            if [ ! -f ~/deploy.sh ]; then
              echo "ðŸ“¥ ä¸‹è½½éƒ¨ç½²è„šæœ¬..."
              wget -O ~/deploy.sh https://raw.githubusercontent.com/PIGU-PPPgu/edu-analysis/main/deploy-server.sh
              chmod +x ~/deploy.sh
            fi

            # è¿è¡Œéƒ¨ç½²è„šæœ¬
            ~/deploy.sh

            echo "========================================"
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ðŸŒ è®¿é—®ï¼šhttps://intelliclass.online"
            echo "========================================"
          ENDSSH

      - name: ðŸ“Š éƒ¨ç½²çŠ¶æ€é€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          fi
