name: ğŸš€ CI/CD Pipeline

# è§¦å‘æ¡ä»¶ï¼šä»»ä½•åˆ†æ”¯pushã€PRã€æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: ['**']  # æ‰€æœ‰åˆ†æ”¯
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - skip

jobs:
  # ============================================
  # é˜¶æ®µ 1: ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆéé˜»å¡ï¼‰
  # ============================================
  quality-check:
    name: ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ’… æ£€æŸ¥ä»£ç æ ¼å¼
        run: |
          echo "::group::Prettier æ ¼å¼æ£€æŸ¥"
          npm run format:check || {
            echo "::warning::ä»£ç æ ¼å¼ä¸ç¬¦åˆè§„èŒƒï¼Œå»ºè®®è¿è¡Œ 'npm run format' ä¿®å¤"
            echo "âœ… å…è®¸ç»§ç»­ï¼ˆéé˜»å¡ï¼‰"
          }
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ” ESLint æ£€æŸ¥
        run: |
          echo "::group::ESLint ä»£ç æ£€æŸ¥"
          npm run lint:errors-only || {
            echo "::warning::å‘ç° ESLint é”™è¯¯ï¼Œå»ºè®®ä¿®å¤"
            echo "âœ… å…è®¸ç»§ç»­ï¼ˆéé˜»å¡ï¼‰"
          }
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ”§ TypeScript ç±»å‹æ£€æŸ¥
        run: |
          echo "::group::TypeScript ç±»å‹æ£€æŸ¥"
          npm run typecheck || {
            echo "::warning::å‘ç° TypeScript ç±»å‹é”™è¯¯ï¼ˆæŠ€æœ¯å€ºåŠ¡ï¼‰"
            echo "âœ… å…è®¸ç»§ç»­ï¼ˆéé˜»å¡ï¼‰"
          }
          echo "::endgroup::"
        continue-on-error: true

  # ============================================
  # é˜¶æ®µ 2: æ„å»ºåº”ç”¨ï¼ˆé˜»å¡ - å¿…é¡»æˆåŠŸï¼‰
  # ============================================
  build:
    name: ğŸ—ï¸ æ„å»ºåº”ç”¨
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”¨ æ„å»ºåº”ç”¨ â­
        run: |
          echo "::group::Vite æ„å»º"
          npm run build
          echo "::endgroup::"

      - name: ğŸ“ åˆ†ææ„å»ºäº§ç‰©
        run: |
          echo "::group::æ„å»ºäº§ç‰©å¤§å°"
          du -sh dist/
          echo ""
          echo "ä¸»è¦æ–‡ä»¶ï¼š"
          find dist/ -type f -name "*.js" -o -name "*.css" | head -20 | xargs ls -lh
          echo "::endgroup::"

      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7

  # ============================================
  # é˜¶æ®µ 3: æµ‹è¯•å¥—ä»¶ï¼ˆéé˜»å¡ï¼‰
  # ============================================
  test:
    name: ğŸ§ª æµ‹è¯•å¥—ä»¶
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          echo "::group::å•å…ƒæµ‹è¯•"
          npm run test:run || {
            echo "::warning::éƒ¨åˆ†æµ‹è¯•å¤±è´¥æˆ–æµ‹è¯•è¦†ç›–ç‡ä¸è¶³ï¼ˆæŠ€æœ¯å€ºåŠ¡ï¼‰"
            echo "âœ… å…è®¸ç»§ç»­ï¼ˆéé˜»å¡ï¼‰"
          }
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
        if: always()
        uses: codecov/codecov-action@v3
        continue-on-error: true
        with:
          files: ./coverage/lcov.info
          flags: unittests
          fail_ci_if_error: false

  # ============================================
  # é˜¶æ®µ 4: æ•™è‚²é¡¹ç›®ç‰¹å®šæ£€æŸ¥ï¼ˆéé˜»å¡ï¼‰
  # ============================================
  education-checks:
    name: ğŸ“ æ•™è‚²é¡¹ç›®ç‰¹å®šæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ—„ï¸ Supabaseæ•°æ®åº“è¿æ¥æµ‹è¯•
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://giluhqotfjpmofowvogn.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder' }}
        run: |
          echo "::group::Supabaseè¿æ¥æµ‹è¯•"
          echo "âœ… æ£€æŸ¥Supabaseé…ç½®..."

          # æ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦é…ç½®
          if [ "$VITE_SUPABASE_URL" == "placeholder" ]; then
            echo "::warning::Supabase URLæœªé…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼"
          else
            echo "âœ… Supabase URLå·²é…ç½®"
          fi

          # æ£€æŸ¥ä»£ç ä¸­æ˜¯å¦æœ‰ç¡¬ç¼–ç çš„credentials
          echo "ğŸ” æ£€æŸ¥ç¡¬ç¼–ç å‡­è¯..."
          if grep -r "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9" src/ --exclude-dir=node_modules 2>/dev/null; then
            echo "::error::å‘ç°ç¡¬ç¼–ç çš„Supabaseå¯†é’¥ï¼"
            exit 1
          else
            echo "âœ… æœªå‘ç°ç¡¬ç¼–ç å‡­è¯"
          fi

          echo "::endgroup::"
        continue-on-error: false  # ç¡¬ç¼–ç å‡­è¯æ£€æŸ¥å¿…é¡»é€šè¿‡

      - name: ğŸ“Š å…³é”®æ•°æ®è¡¨ç»“æ„éªŒè¯
        run: |
          echo "::group::æ•°æ®è¡¨ç»“æ„æ£€æŸ¥"
          echo "ğŸ” éªŒè¯æ ¸å¿ƒæ•°æ®è¡¨å¼•ç”¨..."

          # æ£€æŸ¥å…³é”®è¡¨åæ˜¯å¦åœ¨ä»£ç ä¸­è¢«æ­£ç¡®å¼•ç”¨
          TABLES=("students" "grade_data" "classes" "class_info" "exams" "homework" "user_roles")

          for table in "${TABLES[@]}"; do
            if grep -r "\"$table\"" src/ --include="*.ts" --include="*.tsx" > /dev/null; then
              echo "âœ… è¡¨ '$table' è¢«æ­£ç¡®å¼•ç”¨"
            else
              echo "::warning::è¡¨ '$table' å¯èƒ½æœªè¢«ä½¿ç”¨"
            fi
          done

          # æ£€æŸ¥æ˜¯å¦åŒæ—¶ä½¿ç”¨äº†classeså’Œclass_infoï¼ˆé‡å¤è¡¨é—®é¢˜ï¼‰
          if grep -r "\"classes\"" src/ --include="*.ts" --include="*.tsx" > /dev/null && \
             grep -r "\"class_info\"" src/ --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "::warning::åŒæ—¶ä½¿ç”¨äº†'classes'å’Œ'class_info'è¡¨ï¼Œå»ºè®®ç»Ÿä¸€ä½¿ç”¨class_info"
          fi

          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ¯ æˆç»©è®¡ç®—é€»è¾‘éªŒè¯
        run: |
          echo "::group::æˆç»©è®¡ç®—é€»è¾‘æ£€æŸ¥"
          echo "ğŸ” éªŒè¯æˆç»©ç›¸å…³æœåŠ¡..."

          # æ£€æŸ¥å…³é”®æˆç»©è®¡ç®—æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          FILES=(
            "src/services/gradeAnalysisService.ts"
            "src/services/examScoreCalculationService.ts"
            "src/utils/calculationUtils.ts"
          )

          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file å­˜åœ¨"

              # æ£€æŸ¥æ˜¯å¦æœ‰åŸºæœ¬çš„é”™è¯¯å¤„ç†
              if grep -q "try\|catch" "$file"; then
                echo "   âœ… åŒ…å«é”™è¯¯å¤„ç†"
              else
                echo "   ::warning::ç¼ºå°‘é”™è¯¯å¤„ç†"
              fi
            else
              echo "::warning::$file ä¸å­˜åœ¨"
            fi
          done

          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ”’ å­¦ç”Ÿéšç§æ•°æ®å®‰å…¨æ£€æŸ¥
        run: |
          echo "::group::éšç§æ•°æ®å®‰å…¨æ£€æŸ¥"
          echo "ğŸ” æ£€æŸ¥æ•æ„Ÿæ•°æ®å¤„ç†..."

          # æ£€æŸ¥æ˜¯å¦æœ‰console.logæ³„éœ²å­¦ç”Ÿæ•°æ®çš„é£é™©
          echo "æ£€æŸ¥console.logä½¿ç”¨..."
          CONSOLE_COUNT=$(grep -r "console\.log.*student" src/ --include="*.ts" --include="*.tsx" | wc -l | tr -d ' ')

          if [ "$CONSOLE_COUNT" -gt 0 ]; then
            echo "::warning::å‘ç° $CONSOLE_COUNT å¤„console.logå¯èƒ½è¾“å‡ºå­¦ç”Ÿæ•°æ®ï¼Œå»ºè®®ç”Ÿäº§ç¯å¢ƒç§»é™¤"
          else
            echo "âœ… æœªå‘ç°æ˜æ˜¾çš„æ•°æ®æ³„éœ²é£é™©"
          fi

          # æ£€æŸ¥RLSç­–ç•¥å¼•ç”¨
          if grep -r "rls\|RLS\|Row Level Security" src/ --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "âœ… ä»£ç ä¸­æœ‰RLSç­–ç•¥ç›¸å…³å¼•ç”¨"
          else
            echo "::warning::æœªå‘ç°RLSç­–ç•¥å¼•ç”¨ï¼Œç¡®ä¿æ•°æ®åº“å±‚é¢å·²é…ç½®"
          fi

          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ‘¥ æƒé™ç³»ç»ŸéªŒè¯
        run: |
          echo "::group::æƒé™ç³»ç»Ÿæ£€æŸ¥"
          echo "ğŸ” éªŒè¯è§’è‰²æƒé™å®ç°..."

          # æ£€æŸ¥è§’è‰²å®šä¹‰
          ROLES=("admin" "teacher" "student")
          for role in "${ROLES[@]}"; do
            if grep -r "\"$role\"" src/ --include="*.ts" --include="*.tsx" > /dev/null; then
              echo "âœ… è§’è‰² '$role' å·²å®šä¹‰"
            else
              echo "::warning::è§’è‰² '$role' å¯èƒ½æœªä½¿ç”¨"
            fi
          done

          # æ£€æŸ¥æƒé™æ§åˆ¶ç»„ä»¶
          if [ -f "src/contexts/AuthContext.tsx" ] || [ -f "src/contexts/UnifiedAppContext.tsx" ]; then
            echo "âœ… è®¤è¯ä¸Šä¸‹æ–‡å­˜åœ¨"
          else
            echo "::warning::æœªæ‰¾åˆ°è®¤è¯ä¸Šä¸‹æ–‡"
          fi

          echo "::endgroup::"
        continue-on-error: true

      - name: âš¡ æ•°æ®æŸ¥è¯¢æ€§èƒ½æ£€æŸ¥
        run: |
          echo "::group::æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥"
          echo "ğŸ” æ£€æŸ¥æ½œåœ¨æ€§èƒ½é—®é¢˜..."

          # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ•°æ®ç¼“å­˜
          if grep -r "cache\|Cache\|useMemo\|useCallback" src/ --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "âœ… å‘ç°ç¼“å­˜ä¼˜åŒ–å®ç°"
          else
            echo "::warning::å»ºè®®æ·»åŠ æ•°æ®ç¼“å­˜ä¼˜åŒ–"
          fi

          # æ£€æŸ¥å¤§æ•°æ®é‡å¤„ç†
          if grep -r "pagination\|Pagination\|limit\|offset" src/ --include="*.ts" --include="*.tsx" > /dev/null; then
            echo "âœ… å‘ç°åˆ†é¡µå®ç°"
          else
            echo "::warning::å»ºè®®ä¸ºå¤§æ•°æ®æŸ¥è¯¢æ·»åŠ åˆ†é¡µ"
          fi

          # æ£€æŸ¥è·¯ç”±é¢„åŠ è½½
          if [ -f "src/utils/routePreloader.ts" ]; then
            echo "âœ… è·¯ç”±é¢„åŠ è½½å·²å®ç°"
          fi

          echo "::endgroup::"
        continue-on-error: true

  # ============================================
  # é˜¶æ®µ 5: Docker æ„å»ºéªŒè¯ï¼ˆéé˜»å¡ï¼‰
  # ============================================
  docker:
    name: ğŸ³ Docker æ„å»ºéªŒè¯
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ³ è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ æµ‹è¯•å‰ç«¯ Docker æ„å»º
        run: |
          echo "::group::æ„å»ºå‰ç«¯ Docker é•œåƒ"
          docker build -f Dockerfile.dev -t edu-frontend:test . || {
            echo "::warning::å‰ç«¯ Docker æ„å»ºå¤±è´¥ï¼ˆéé˜»å¡ï¼‰"
          }
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ—ï¸ æµ‹è¯•åç«¯ Docker æ„å»º
        run: |
          echo "::group::æ„å»ºåç«¯ Docker é•œåƒ"
          if [ -d "server" ]; then
            cd server
            docker build -t edu-backend:test . || {
              echo "::warning::åç«¯ Docker æ„å»ºå¤±è´¥ï¼ˆéé˜»å¡ï¼‰"
            }
          else
            echo "âš ï¸ åç«¯ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ æµ‹è¯• Python æœåŠ¡ Docker æ„å»º
        run: |
          echo "::group::æ„å»º Python æœåŠ¡ Docker é•œåƒ"
          if [ -d "python-data-processor" ]; then
            cd python-data-processor
            docker build -t edu-python:test . || {
              echo "::warning::Python æœåŠ¡ Docker æ„å»ºå¤±è´¥ï¼ˆéé˜»å¡ï¼‰"
            }
          else
            echo "âš ï¸ Python æœåŠ¡ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi
          echo "::endgroup::"
        continue-on-error: true

  # ============================================
  # é˜¶æ®µ 6: å®‰å…¨æ‰«æï¼ˆéé˜»å¡ï¼‰
  # ============================================
  security:
    name: ğŸ›¡ï¸ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: quality-check

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“š å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”’ npm å®‰å…¨å®¡è®¡
        run: |
          echo "::group::npm audit"
          npm audit --audit-level=critical || {
            echo ""
            echo "::warning::å‘ç°å·²çŸ¥æ¼æ´ï¼š"
            echo "  â€¢ xlsx: é«˜å±æ¼æ´ï¼ˆæ— ä¿®å¤ç‰ˆæœ¬å¯ç”¨ï¼‰"
            echo "  â€¢ axios: DoS æ¼æ´ï¼ˆå·²é€šè¿‡é™æµç¼“è§£ï¼‰"
            echo "  â€¢ @playwright/test: å¼€å‘ä¾èµ–ï¼ˆä¸å½±å“ç”Ÿäº§ï¼‰"
            echo "  â€¢ electron: æ¡Œé¢æ„å»ºä¸“ç”¨ï¼ˆæœªéƒ¨ç½²åˆ°ç”Ÿäº§ï¼‰"
            echo ""
            echo "âœ… å·²å®æ–½ç¼“è§£æªæ–½ï¼šè¾“å…¥éªŒè¯ã€æ–‡ä»¶å¤§å°é™åˆ¶ã€è¯·æ±‚é™æµ"
          }
          echo "::endgroup::"
        continue-on-error: true

  # ============================================
  # é˜¶æ®µ 7: éƒ¨ç½²çŠ¶æ€æ£€æŸ¥
  # ============================================
  deployment-check:
    name: ğŸ“Š éƒ¨ç½²å‡†å¤‡æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [build, test, education-checks, docker, security]
    if: always()
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}

    steps:
      - name: ğŸ” æ£€æŸ¥éƒ¨ç½²æ¡ä»¶
        id: check
        run: |
          echo "::group::éƒ¨ç½²æ¡ä»¶åˆ†æ"

          # æ£€æŸ¥æ˜¯å¦æ˜¯ main åˆ†æ”¯
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "âœ… å½“å‰åˆ†æ”¯: main - ç¬¦åˆè‡ªåŠ¨éƒ¨ç½²æ¡ä»¶"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" != "" ] && [ "${{ github.event.inputs.environment }}" != "skip" ]; then
            echo "âœ… æ‰‹åŠ¨è§¦å‘éƒ¨ç½²åˆ°: ${{ github.event.inputs.environment }}"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ å½“å‰åˆ†æ”¯: ${{ github.ref }} - è·³è¿‡è‡ªåŠ¨éƒ¨ç½²"
            echo "ğŸ’¡ éƒ¨ç½²ç­–ç•¥ï¼š"
            echo "   â€¢ main åˆ†æ”¯ï¼šè‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
            echo "   â€¢ å…¶ä»–åˆ†æ”¯ï¼šä»…æ„å»ºéªŒè¯ï¼Œä¸éƒ¨ç½²"
            echo "   â€¢ æ‰‹åŠ¨è§¦å‘ï¼šå¯æŒ‡å®šéƒ¨ç½²ç¯å¢ƒ"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

          # æ£€æŸ¥æ„å»ºçŠ¶æ€
          echo ""
          echo "ğŸ“Š Pipeline çŠ¶æ€ï¼š"
          echo "   â€¢ æ„å»º: ${{ needs.build.result }}"
          echo "   â€¢ æµ‹è¯•: ${{ needs.test.result }}"
          echo "   â€¢ Docker: ${{ needs.docker.result }}"
          echo "   â€¢ å®‰å…¨: ${{ needs.security.result }}"

          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œæ— æ³•éƒ¨ç½²"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "::endgroup::"

  # ============================================
  # é˜¶æ®µ 8: è‡ªåŠ¨éƒ¨ç½²ï¼ˆä»… main åˆ†æ”¯ï¼‰
  # ============================================
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: deployment-check
    if: needs.deployment-check.outputs.should_deploy == 'true'
    environment:
      name: production
      url: https://intelliclass.online

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” é…ç½® SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ“ æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸš€ SSH éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          echo "::group::SSH éƒ¨ç½²"
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            echo "========================================"
            echo "ğŸš€ å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
            echo "========================================"

            # ç¡®ä¿æœ‰æœ€æ–°çš„éƒ¨ç½²è„šæœ¬
            if [ ! -f ~/deploy.sh ]; then
              echo "ğŸ“¥ ä¸‹è½½éƒ¨ç½²è„šæœ¬..."
              wget -O ~/deploy.sh https://raw.githubusercontent.com/PIGU-PPPgu/edu-analysis/main/deploy-server.sh
              chmod +x ~/deploy.sh
            fi

            # è¿è¡Œéƒ¨ç½²è„šæœ¬
            ~/deploy.sh

            echo "========================================"
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "ğŸŒ è®¿é—®ï¼šhttps://intelliclass.online"
            echo "========================================"
          ENDSSH
          echo "::endgroup::"

      - name: ğŸ“Š éƒ¨ç½²çŠ¶æ€é€šçŸ¥
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "::notice::âœ… éƒ¨ç½²æˆåŠŸï¼è®¿é—® https://intelliclass.online"
          else
            echo "::error::âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
            exit 1
          fi

  # ============================================
  # é˜¶æ®µ 9: Pipeline çŠ¶æ€æ±‡æ€»
  # ============================================
  status:
    name: âœ… Pipeline çŠ¶æ€æ±‡æ€»
    runs-on: ubuntu-latest
    needs: [quality-check, build, test, education-checks, docker, security, deployment-check]
    if: always()

    steps:
      - name: ğŸ“Š ç”ŸæˆçŠ¶æ€æŠ¥å‘Š
        run: |
          echo "========================================"
          echo "ğŸ¯ CI/CD Pipeline æ‰§è¡ŒæŠ¥å‘Š"
          echo "========================================"
          echo ""
          echo "ğŸ“‹ å„é˜¶æ®µçŠ¶æ€ï¼š"
          echo "  â€¢ ä»£ç è´¨é‡: ${{ needs.quality-check.result }}"
          echo "  â€¢ åº”ç”¨æ„å»º: ${{ needs.build.result }} â­"
          echo "  â€¢ æµ‹è¯•å¥—ä»¶: ${{ needs.test.result }}"
          echo "  â€¢ æ•™è‚²æ£€æŸ¥: ${{ needs.education-checks.result }} ğŸ“"
          echo "  â€¢ DockeréªŒè¯: ${{ needs.docker.result }}"
          echo "  â€¢ å®‰å…¨æ‰«æ: ${{ needs.security.result }}"
          echo "  â€¢ éƒ¨ç½²æ£€æŸ¥: ${{ needs.deployment-check.result }}"
          echo ""

          # æ£€æŸ¥å…³é”®é˜¶æ®µ
          if [ "${{ needs.build.result }}" != "success" ]; then
            echo "âŒ Pipeline å¤±è´¥ï¼šæ„å»ºé˜¶æ®µæœªé€šè¿‡"
            echo ""
            echo "ğŸ’¡ æç¤ºï¼šè¿™æ˜¯å”¯ä¸€é˜»å¡çš„å…³é”®æ­¥éª¤"
            exit 1
          fi

          # è­¦å‘Šéå…³é”®å¤±è´¥
          echo "â„¹ï¸  éå…³é”®é˜¶æ®µçŠ¶æ€ï¼ˆä»…ä¾›å‚è€ƒï¼‰ï¼š"

          if [ "${{ needs.quality-check.result }}" != "success" ]; then
            echo "  âš ï¸ ä»£ç è´¨é‡æ£€æŸ¥æœ‰è­¦å‘Šï¼ˆå·²çŸ¥æŠ€æœ¯å€ºåŠ¡ï¼‰"
          fi

          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "  âš ï¸ æµ‹è¯•å¥—ä»¶æœ‰é—®é¢˜ï¼ˆæµ‹è¯•è¦†ç›–ç‡å¾…æå‡ï¼‰"
          fi

          if [ "${{ needs.education-checks.result }}" != "success" ]; then
            echo "  âš ï¸ æ•™è‚²é¡¹ç›®ç‰¹å®šæ£€æŸ¥æœ‰è­¦å‘Šï¼ˆå»ºè®®å…³æ³¨ï¼‰"
          fi

          if [ "${{ needs.docker.result }}" != "success" ]; then
            echo "  âš ï¸ Docker æ„å»ºæœ‰è­¦å‘Š"
          fi

          if [ "${{ needs.security.result }}" != "success" ]; then
            echo "  âš ï¸ å®‰å…¨æ‰«ææœ‰å·²çŸ¥æ¼æ´ï¼ˆå·²ç¼“è§£ï¼‰"
          fi

          echo ""
          echo "========================================"
          echo "âœ… Pipeline æ‰§è¡Œå®Œæˆ"
          echo "========================================"
          echo ""
          echo "ğŸ“Œ åˆ†æ”¯: ${{ github.ref }}"
          echo "ğŸ“ æäº¤: ${{ github.sha }}"
          echo "ğŸ‘¤ ä½œè€…: ${{ github.actor }}"
          echo ""

          if [ "${{ needs.deployment-check.outputs.should_deploy }}" == "true" ]; then
            echo "ğŸš€ éƒ¨ç½²çŠ¶æ€: å·²è§¦å‘è‡ªåŠ¨éƒ¨ç½²"
          else
            echo "â„¹ï¸  éƒ¨ç½²çŠ¶æ€: è·³è¿‡ï¼ˆé main åˆ†æ”¯ï¼‰"
          fi
