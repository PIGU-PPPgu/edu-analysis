<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è‡ªå®šä¹‰æä¾›å•†å­˜å‚¨æµ‹è¯•</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
    }
    .success { background-color: #d4edda; border-color: #c3e6cb; }
    .error { background-color: #f8d7da; border-color: #f5c6cb; }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      border: 2px solid #B9FF66;
      background: #B9FF66;
      border-radius: 4px;
      font-weight: bold;
    }
    pre {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª è‡ªå®šä¹‰æä¾›å•†å­˜å‚¨æµ‹è¯•</h1>

  <div class="test-section">
    <h2>æµ‹è¯•1: ä¿å­˜è‡ªå®šä¹‰æä¾›å•†</h2>
    <button onclick="testSave()">ä¿å­˜æµ‹è¯•æä¾›å•†</button>
    <div id="save-result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•2: è¯»å–è‡ªå®šä¹‰æä¾›å•†</h2>
    <button onclick="testLoad()">è¯»å–æä¾›å•†åˆ—è¡¨</button>
    <div id="load-result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•3: åˆ é™¤è‡ªå®šä¹‰æä¾›å•†</h2>
    <button onclick="testDelete()">åˆ é™¤æµ‹è¯•æä¾›å•†</button>
    <div id="delete-result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•4: æŸ¥çœ‹localStorage</h2>
    <button onclick="inspectStorage()">æ£€æŸ¥å­˜å‚¨å†…å®¹</button>
    <div id="storage-result"></div>
  </div>

  <div class="test-section">
    <h2>æµ‹è¯•5: æ¸…ç©ºæ‰€æœ‰</h2>
    <button onclick="clearAll()" style="background: #ff6b6b; border-color: #ff6b6b;">æ¸…ç©ºlocalStorage</button>
    <div id="clear-result"></div>
  </div>

  <script>
    // ä½¿ç”¨v2ç‰ˆæœ¬çš„key,ä¸æ–°çš„æ ¼å¼é¢„è®¾ç³»ç»Ÿä¿æŒä¸€è‡´
    const CUSTOM_PROVIDERS_KEY = "custom_ai_providers_v2";

    // æµ‹è¯•æ•°æ®
    const testProvider = {
      id: "test-provider",
      name: "Test Provider",
      displayName: "æµ‹è¯•æä¾›å•†",
      baseURL: "https://api.test.com/v1",
      formatPresetId: "openai",
      customEndpoint: "/chat/completions",
      apiKeyFormat: "test-...",
      models: [
        {
          id: "test-model-1",
          name: "Test Model 1",
          contextWindow: 8000,
          maxOutputTokens: 4096
        },
        {
          id: "test-model-2",
          name: "Test Model 2",
          contextWindow: 16000,
          maxOutputTokens: 8192
        }
      ]
    };

    function testSave() {
      const resultDiv = document.getElementById('save-result');
      try {
        // è·å–ç°æœ‰æä¾›å•†
        const stored = localStorage.getItem(CUSTOM_PROVIDERS_KEY);
        let providers = stored ? JSON.parse(stored) : [];

        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existingIndex = providers.findIndex(p => p.id === testProvider.id);
        if (existingIndex >= 0) {
          providers[existingIndex] = testProvider;
        } else {
          providers.push(testProvider);
        }

        // ä¿å­˜
        localStorage.setItem(CUSTOM_PROVIDERS_KEY, JSON.stringify(providers));

        resultDiv.innerHTML = `
          <div class="success">
            <p>âœ… ä¿å­˜æˆåŠŸï¼</p>
            <pre>${JSON.stringify(testProvider, null, 2)}</pre>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <p>âŒ ä¿å­˜å¤±è´¥: ${error.message}</p>
          </div>
        `;
      }
    }

    function testLoad() {
      const resultDiv = document.getElementById('load-result');
      try {
        const stored = localStorage.getItem(CUSTOM_PROVIDERS_KEY);

        if (!stored) {
          resultDiv.innerHTML = `
            <div class="error">
              <p>âš ï¸ localStorageä¸­æ²¡æœ‰æ•°æ®</p>
            </div>
          `;
          return;
        }

        const providers = JSON.parse(stored);

        resultDiv.innerHTML = `
          <div class="success">
            <p>âœ… è¯»å–æˆåŠŸï¼å…± ${providers.length} ä¸ªæä¾›å•†</p>
            <pre>${JSON.stringify(providers, null, 2)}</pre>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <p>âŒ è¯»å–å¤±è´¥: ${error.message}</p>
          </div>
        `;
      }
    }

    function testDelete() {
      const resultDiv = document.getElementById('delete-result');
      try {
        const stored = localStorage.getItem(CUSTOM_PROVIDERS_KEY);
        if (!stored) {
          resultDiv.innerHTML = `<div class="error"><p>âš ï¸ æ²¡æœ‰æ•°æ®å¯åˆ é™¤</p></div>`;
          return;
        }

        let providers = JSON.parse(stored);
        const beforeCount = providers.length;

        providers = providers.filter(p => p.id !== testProvider.id);

        localStorage.setItem(CUSTOM_PROVIDERS_KEY, JSON.stringify(providers));

        resultDiv.innerHTML = `
          <div class="success">
            <p>âœ… åˆ é™¤æˆåŠŸï¼</p>
            <p>åˆ é™¤å‰: ${beforeCount} ä¸ªæä¾›å•†</p>
            <p>åˆ é™¤å: ${providers.length} ä¸ªæä¾›å•†</p>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <p>âŒ åˆ é™¤å¤±è´¥: ${error.message}</p>
          </div>
        `;
      }
    }

    function inspectStorage() {
      const resultDiv = document.getElementById('storage-result');
      try {
        const allKeys = Object.keys(localStorage);
        const aiRelatedKeys = allKeys.filter(k =>
          k.includes('ai') || k.includes('provider') || k.includes('model')
        );

        let html = '<div class="success">';
        html += `<p>âœ… localStorageæ€»å…±æœ‰ ${allKeys.length} ä¸ªé”®</p>`;
        html += `<p>AIç›¸å…³çš„é”®: ${aiRelatedKeys.length} ä¸ª</p>`;

        if (aiRelatedKeys.length > 0) {
          html += '<h3>AIç›¸å…³å­˜å‚¨å†…å®¹ï¼š</h3>';
          aiRelatedKeys.forEach(key => {
            const value = localStorage.getItem(key);
            html += `<h4>${key}</h4>`;
            html += `<pre>${value}</pre>`;
          });
        }

        html += '</div>';
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <p>âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</p>
          </div>
        `;
      }
    }

    function clearAll() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©ºlocalStorageä¸­çš„æ‰€æœ‰AIé…ç½®å—ï¼Ÿ')) {
        return;
      }

      const resultDiv = document.getElementById('clear-result');
      try {
        const keysToRemove = ['custom_ai_providers', 'custom_ai_providers_v2', 'custom_ai_models', 'user_api_keys', 'global_ai_config'];
        let removedCount = 0;

        keysToRemove.forEach(key => {
          if (localStorage.getItem(key)) {
            localStorage.removeItem(key);
            removedCount++;
          }
        });

        resultDiv.innerHTML = `
          <div class="success">
            <p>âœ… æ¸…ç©ºæˆåŠŸï¼å…±æ¸…é™¤ ${removedCount} ä¸ªé”®</p>
          </div>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <p>âŒ æ¸…ç©ºå¤±è´¥: ${error.message}</p>
          </div>
        `;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = function() {
      console.log('ğŸ§ª è‡ªå®šä¹‰æä¾›å•†å­˜å‚¨æµ‹è¯•é¡µé¢å·²åŠ è½½');
      console.log('localStorageå¯ç”¨:', typeof(Storage) !== "undefined");
    };
  </script>
</body>
</html>
