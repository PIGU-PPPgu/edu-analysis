# æˆç»©åˆ†æç³»ç»Ÿæ•°æ®åº“è¿ç§»æ‰§è¡ŒæŒ‡å—

## ğŸ¯ è¿ç§»ç›®æ ‡

æœ¬æ¬¡è¿ç§»å°†ä¸ºæˆç»©åˆ†æç³»ç»Ÿæ·»åŠ ä»¥ä¸‹å¢å¼ºåŠŸèƒ½ï¼š

### æ–°å¢å­—æ®µ
- `grade_level` - å¹´çº§å­—æ®µ
- `subject_total_score` - ç§‘ç›®æ»¡åˆ†å­—æ®µ  
- `original_grade` - åŸå§‹ç­‰çº§å­—æ®µ(æ¥è‡ªCSV)
- `computed_grade` - ç³»ç»Ÿè®¡ç®—ç­‰çº§å­—æ®µ
- `exam_scope` - è€ƒè¯•èŒƒå›´å­—æ®µ
- `percentile` - ç™¾åˆ†ä½æ•°å­—æ®µ
- `z_score` - æ ‡å‡†åˆ†å­—æ®µ

### æ–°å¢åŠŸèƒ½
- ç­‰çº§é…ç½®ç³»ç»Ÿ (`grade_level_config` è¡¨)
- è‡ªåŠ¨ç­‰çº§è®¡ç®—å‡½æ•°
- æœ‰æ•ˆåˆ†æ•°/ç­‰çº§è·å–å‡½æ•°
- æˆç»©åˆ†æè§†å›¾

## ğŸ“‹ è¿ç§»å‰å‡†å¤‡

### 1. å¤‡ä»½ç°æœ‰æ•°æ®
```sql
-- å¤‡ä»½grade_dataè¡¨
CREATE TABLE grade_data_backup AS SELECT * FROM grade_data;

-- å¤‡ä»½studentsè¡¨
CREATE TABLE students_backup AS SELECT * FROM students;

-- å¤‡ä»½examsè¡¨  
CREATE TABLE exams_backup AS SELECT * FROM exams;
```

### 2. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
```sql
-- æ£€æŸ¥grade_dataè¡¨è®°å½•æ•°
SELECT COUNT(*) as total_records FROM grade_data;

-- æ£€æŸ¥æ˜¯å¦æœ‰ç©ºå€¼
SELECT 
  COUNT(*) as total,
  COUNT(student_id) as has_student_id,
  COUNT(subject) as has_subject,
  COUNT(score) as has_score
FROM grade_data;
```

## ğŸš€ æ‰§è¡Œè¿ç§»

### æ–¹æ³•ä¸€ï¼šé€šè¿‡Supabase Dashboard

1. **ç™»å½•Supabase Dashboard**
   - è®¿é—® [https://supabase.com/dashboard](https://supabase.com/dashboard)
   - é€‰æ‹©æ‚¨çš„é¡¹ç›®

2. **æ‰“å¼€SQLç¼–è¾‘å™¨**
   - ç‚¹å‡»å·¦ä¾§èœå•çš„ "SQL Editor"
   - ç‚¹å‡» "New query"

3. **æ‰§è¡Œè¿ç§»è„šæœ¬**
   - å¤åˆ¶ `supabase/migrations/20240604000000_fix_grade_analysis_issues.sql` æ–‡ä»¶å†…å®¹
   - ç²˜è´´åˆ°SQLç¼–è¾‘å™¨ä¸­
   - ç‚¹å‡» "Run" æ‰§è¡Œ

4. **éªŒè¯è¿ç§»ç»“æœ**
   ```sql
   -- æ£€æŸ¥æ–°å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸ
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'grade_data';
   
   -- æ£€æŸ¥æ–°è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ
   SELECT table_name 
   FROM information_schema.tables 
   WHERE table_name = 'grade_level_config';
   
   -- æ£€æŸ¥æ–°å‡½æ•°æ˜¯å¦åˆ›å»ºæˆåŠŸ
   SELECT routine_name 
   FROM information_schema.routines 
   WHERE routine_name IN ('calculate_grade_level', 'get_effective_score', 'get_effective_grade');
   ```

### æ–¹æ³•äºŒï¼šé€šè¿‡Supabase CLI (å¦‚æœå¯ç”¨)

1. **å®‰è£…Supabase CLI**
   ```bash
   npm install -g supabase
   ```

2. **ç™»å½•å¹¶è¿æ¥é¡¹ç›®**
   ```bash
   supabase login
   supabase link --project-ref YOUR_PROJECT_REF
   ```

3. **æ‰§è¡Œè¿ç§»**
   ```bash
   supabase migration up
   ```

### æ–¹æ³•ä¸‰ï¼šé€šè¿‡psql (å¦‚æœæœ‰ç›´æ¥æ•°æ®åº“è®¿é—®æƒé™)

1. **è¿æ¥æ•°æ®åº“**
   ```bash
   psql "postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres"
   ```

2. **æ‰§è¡Œè¿ç§»è„šæœ¬**
   ```bash
   \i supabase/migrations/20240604000000_fix_grade_analysis_issues.sql
   ```

## âœ… è¿ç§»åéªŒè¯

### 1. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```sql
-- æ£€æŸ¥æ•°æ®æ˜¯å¦å®Œæ•´
SELECT COUNT(*) FROM grade_data;
SELECT COUNT(*) FROM grade_data_backup;

-- æ£€æŸ¥æ–°å­—æ®µé»˜è®¤å€¼
SELECT 
  grade_level,
  subject_total_score,
  original_grade,
  computed_grade,
  exam_scope
FROM grade_data 
LIMIT 5;
```

### 2. åŠŸèƒ½æµ‹è¯•
```sql
-- æµ‹è¯•ç­‰çº§è®¡ç®—å‡½æ•°
SELECT calculate_grade_level(85, 100) as calculated_grade;

-- æµ‹è¯•æœ‰æ•ˆåˆ†æ•°è·å–
SELECT get_effective_score(85, 90) as effective_score;

-- æµ‹è¯•æœ‰æ•ˆç­‰çº§è·å–
SELECT get_effective_grade('B', 'A') as effective_grade;

-- æµ‹è¯•åˆ†æè§†å›¾
SELECT * FROM grade_analysis_view LIMIT 5;
```

### 3. ç­‰çº§é…ç½®æµ‹è¯•
```sql
-- æ£€æŸ¥é»˜è®¤ç­‰çº§é…ç½®
SELECT * FROM grade_level_config WHERE is_default = true;

-- æµ‹è¯•ç­‰çº§é…ç½®åº”ç”¨
SELECT 
  score,
  total_score,
  calculate_grade_level(score, total_score) as computed_grade
FROM grade_data 
WHERE score IS NOT NULL 
LIMIT 10;
```

## ğŸ”§ å¸¸è§é—®é¢˜è§£å†³

### é—®é¢˜1ï¼šå­—æ®µå·²å­˜åœ¨é”™è¯¯
```sql
-- å¦‚æœæŸäº›å­—æ®µå·²å­˜åœ¨ï¼Œå¯ä»¥è·³è¿‡ç›¸å…³çš„ALTER TABLEè¯­å¥
-- æˆ–è€…å…ˆæ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨
SELECT column_name 
FROM information_schema.columns 
WHERE table_name = 'grade_data' 
AND column_name = 'grade_level';
```

### é—®é¢˜2ï¼šå‡½æ•°åˆ›å»ºå¤±è´¥
```sql
-- åˆ é™¤å·²å­˜åœ¨çš„å‡½æ•°åé‡æ–°åˆ›å»º
DROP FUNCTION IF EXISTS calculate_grade_level(numeric, numeric);
DROP FUNCTION IF EXISTS get_effective_score(numeric, numeric);
DROP FUNCTION IF EXISTS get_effective_grade(text, text);
```

### é—®é¢˜3ï¼šæƒé™ä¸è¶³
- ç¡®ä¿ä½¿ç”¨çš„æ•°æ®åº“ç”¨æˆ·å…·æœ‰è¶³å¤Ÿçš„æƒé™
- å¯èƒ½éœ€è¦ä½¿ç”¨ `postgres` ç”¨æˆ·æˆ–å…·æœ‰ `SUPERUSER` æƒé™çš„ç”¨æˆ·

### é—®é¢˜4ï¼šæ•°æ®ç±»å‹å†²çª
```sql
-- å¦‚æœé‡åˆ°æ•°æ®ç±»å‹å†²çªï¼Œå¯ä»¥å…ˆæ¸…ç†æ•°æ®
UPDATE grade_data SET score = NULL WHERE score = '';
UPDATE grade_data SET total_score = NULL WHERE total_score = '';
```

## ğŸ“Š è¿ç§»åçš„æ–°åŠŸèƒ½ä½¿ç”¨

### 1. ç­‰çº§é…ç½®ç®¡ç†
- åœ¨å‰ç«¯ç•Œé¢ä¸­å¯ä»¥é€šè¿‡ "ç­‰çº§é…ç½®" å¯¹è¯æ¡†ç®¡ç†ç­‰çº§è§„åˆ™
- æ”¯æŒå¤šç§é¢„è®¾ç­‰çº§ç³»ç»Ÿï¼ˆ5çº§åˆ¶ã€4çº§åˆ¶ã€ç™¾åˆ†åˆ¶ç­‰ï¼‰
- å¯ä»¥è‡ªå®šä¹‰ç­‰çº§èŒƒå›´å’Œåç§°

### 2. å¢å¼ºçš„æ•°æ®å¯¼å…¥
- æ”¯æŒå¹´çº§å­—æ®µå¯¼å…¥
- æ”¯æŒç§‘ç›®æ»¡åˆ†å­—æ®µ
- æ”¯æŒåŸå§‹ç­‰çº§å­—æ®µ
- è‡ªåŠ¨è®¡ç®—ç­‰çº§åŠŸèƒ½

### 3. æ”¹è¿›çš„æˆç»©åˆ†æ
- ä½¿ç”¨æœ‰æ•ˆåˆ†æ•°è¿›è¡Œåˆ†æï¼ˆä¼˜å…ˆä½¿ç”¨scoreå­—æ®µï¼‰
- æ”¯æŒä¸åŒç§‘ç›®çš„ä¸åŒæ»¡åˆ†
- ç­‰çº§åˆ†å¸ƒç»Ÿè®¡
- æ›´å‡†ç¡®çš„æ’åè®¡ç®—

## ğŸ‰ å®Œæˆç¡®è®¤

è¿ç§»å®Œæˆåï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… åœ¨æˆç»©å¯¼å…¥ç•Œé¢çœ‹åˆ°æ–°çš„å­—æ®µé€‰é¡¹
2. âœ… ä½¿ç”¨ç­‰çº§é…ç½®å¯¹è¯æ¡†è®¾ç½®ç­‰çº§è§„åˆ™
3. âœ… å¯¼å…¥åŒ…å«å¹´çº§ã€æ»¡åˆ†ã€ç­‰çº§çš„CSVæ–‡ä»¶
4. âœ… åœ¨æˆç»©åˆ†æä¸­çœ‹åˆ°æ›´è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
5. âœ… ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—å’Œæ˜¾ç¤ºç­‰çº§ä¿¡æ¯

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥Supabaseé¡¹ç›®çš„æ—¥å¿—
2. ç¡®è®¤æ•°æ®åº“è¿æ¥æ­£å¸¸
3. éªŒè¯ç”¨æˆ·æƒé™è®¾ç½®
4. æŸ¥çœ‹å…·ä½“çš„é”™è¯¯ä¿¡æ¯

è¿ç§»è„šæœ¬ä½ç½®ï¼š`supabase/migrations/20240604000000_fix_grade_analysis_issues.sql`

---

**æ³¨æ„**ï¼šå»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒæ‰§è¡Œè¿ç§»å‰ï¼Œå…ˆåœ¨æµ‹è¯•ç¯å¢ƒä¸­éªŒè¯è¿ç§»è„šæœ¬çš„æ­£ç¡®æ€§ã€‚ 