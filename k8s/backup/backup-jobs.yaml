# â° å®šæ—¶å¤‡ä»½ä»»åŠ¡é…ç½®
# ä½¿ç”¨Kubernetes CronJobè‡ªåŠ¨æ‰§è¡Œå„ç§ç±»å‹çš„å¤‡ä»½

# ğŸ“Š æ•°æ®åº“å¤‡ä»½ä»»åŠ¡
apiVersion: batch/v1
kind: CronJob
metadata:
  name: database-backup
  namespace: backup
  labels:
    app: backup-system
    backup-type: database
spec:
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # ç¦æ­¢å¹¶å‘æ‰§è¡Œ
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600  # 1å°æ—¶è¶…æ—¶
      template:
        metadata:
          labels:
            app: backup-system
            backup-type: database
        spec:
          serviceAccountName: backup-service
          restartPolicy: OnFailure
          containers:
          - name: database-backup
            image: ubuntu:22.04
            command:
            - /bin/bash
            - -c
            - |
              # å®‰è£…å¿…è¦å·¥å…·
              apt-get update && apt-get install -y \
                curl wget unzip awscli postgresql-client-14
              
              # å®‰è£…Supabase CLI
              curl -fsSL https://github.com/supabase/cli/releases/latest/download/supabase_linux_amd64.tar.gz | \
                tar -xz --strip-components=1 -C /usr/local/bin
              
              # åŠ è½½é…ç½®
              source /etc/backup/backup.conf
              
              # è®¾ç½®AWSå‡­è¯
              export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
              export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
              export AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION"
              
              # æ‰§è¡Œå¤‡ä»½è„šæœ¬
              /scripts/backup-supabase.sh
              
              # å‘é€é€šçŸ¥
              if [[ "$?" -eq 0 ]]; then
                /scripts/send-notification.sh "âœ… æ•°æ®åº“å¤‡ä»½æˆåŠŸ" "success"
              else
                /scripts/send-notification.sh "âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥" "error"
                exit 1
              fi
            env:
            - name: SUPABASE_ACCESS_TOKEN
              valueFrom:
                secretKeyRef:
                  name: supabase-credentials
                  key: access-token
                  optional: true
            - name: SUPABASE_DB_URL
              valueFrom:
                secretKeyRef:
                  name: supabase-credentials  
                  key: database-url
                  optional: true
            envFrom:
            - secretRef:
                name: aws-credentials
            - configMapRef:
                name: backup-config
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
              readOnly: true
            - name: backup-config-vol
              mountPath: /etc/backup
              readOnly: true
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-config
              defaultMode: 0755
              items:
              - key: backup-supabase.sh
                path: backup-supabase.sh
              - key: send-notification.sh
                path: send-notification.sh
          - name: backup-config-vol
            configMap:
              name: backup-config
              items:
              - key: backup.conf
                path: backup.conf

---
# âš™ï¸ Kubernetesé…ç½®å¤‡ä»½ä»»åŠ¡
apiVersion: batch/v1
kind: CronJob
metadata:
  name: k8s-config-backup
  namespace: backup
  labels:
    app: backup-system
    backup-type: kubernetes-config
spec:
  schedule: "0 1 * * 0"  # æ¯å‘¨æ—¥å‡Œæ™¨1ç‚¹æ‰§è¡Œ
  successfulJobsHistoryLimit: 4
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 1800  # 30åˆ†é’Ÿè¶…æ—¶
      template:
        metadata:
          labels:
            app: backup-system
            backup-type: kubernetes-config
        spec:
          serviceAccountName: backup-service
          restartPolicy: OnFailure
          containers:
          - name: k8s-config-backup
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              # å®‰è£…AWS CLI
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip awscliv2.zip
              ./aws/install
              
              # åŠ è½½é…ç½®
              source /etc/backup/backup.conf
              
              # è®¾ç½®AWSå‡­è¯
              export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
              export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
              export AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION"
              
              # æ‰§è¡Œå¤‡ä»½è„šæœ¬
              /scripts/backup-k8s-config.sh
              
              # å‘é€é€šçŸ¥
              if [[ "$?" -eq 0 ]]; then
                /scripts/send-notification.sh "âœ… Kubernetesé…ç½®å¤‡ä»½æˆåŠŸ" "success"
              else
                /scripts/send-notification.sh "âŒ Kubernetesé…ç½®å¤‡ä»½å¤±è´¥" "error"
                exit 1
              fi
            envFrom:
            - secretRef:
                name: aws-credentials
            - configMapRef:
                name: backup-config
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
              readOnly: true
            - name: backup-config-vol
              mountPath: /etc/backup
              readOnly: true
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "300m"
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-config
              defaultMode: 0755
              items:
              - key: backup-k8s-config.sh
                path: backup-k8s-config.sh
              - key: send-notification.sh
                path: send-notification.sh
          - name: backup-config-vol
            configMap:
              name: backup-config
              items:
              - key: backup.conf
                path: backup.conf

---
# ğŸ“± åº”ç”¨æ•°æ®å¤‡ä»½ä»»åŠ¡
apiVersion: batch/v1
kind: CronJob
metadata:
  name: app-data-backup
  namespace: backup
  labels:
    app: backup-system
    backup-type: application-data
spec:
  schedule: "0 3 * * *"  # æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 2400  # 40åˆ†é’Ÿè¶…æ—¶
      template:
        metadata:
          labels:
            app: backup-system
            backup-type: application-data
        spec:
          serviceAccountName: backup-service
          restartPolicy: OnFailure
          containers:
          - name: app-data-backup
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              # å®‰è£…å¿…è¦å·¥å…·
              apt-get update && apt-get install -y curl unzip redis-tools
              
              # å®‰è£…AWS CLI
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip awscliv2.zip
              ./aws/install
              
              # åŠ è½½é…ç½®
              source /etc/backup/backup.conf
              
              # è®¾ç½®AWSå‡­è¯
              export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
              export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
              export AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION"
              
              # æ‰§è¡Œå¤‡ä»½è„šæœ¬
              /scripts/backup-app-data.sh
              
              # å‘é€é€šçŸ¥
              if [[ "$?" -eq 0 ]]; then
                /scripts/send-notification.sh "âœ… åº”ç”¨æ•°æ®å¤‡ä»½æˆåŠŸ" "success"
              else
                /scripts/send-notification.sh "âŒ åº”ç”¨æ•°æ®å¤‡ä»½å¤±è´¥" "error"
                exit 1
              fi
            envFrom:
            - secretRef:
                name: aws-credentials
            - configMapRef:
                name: backup-config
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
              readOnly: true
            - name: backup-config-vol
              mountPath: /etc/backup
              readOnly: true
            resources:
              requests:
                memory: "256Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "300m"
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-config
              defaultMode: 0755
              items:
              - key: backup-app-data.sh
                path: backup-app-data.sh
              - key: send-notification.sh
                path: send-notification.sh
          - name: backup-config-vol
            configMap:
              name: backup-config
              items:
              - key: backup.conf
                path: backup.conf

---
# ğŸ“Š ç›‘æ§æ•°æ®å¤‡ä»½ä»»åŠ¡
apiVersion: batch/v1
kind: CronJob
metadata:
  name: monitoring-backup
  namespace: backup
  labels:
    app: backup-system
    backup-type: monitoring-data
spec:
  schedule: "0 4 * * *"  # æ¯å¤©å‡Œæ™¨4ç‚¹æ‰§è¡Œ
  successfulJobsHistoryLimit: 14
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 3600  # 1å°æ—¶è¶…æ—¶
      template:
        metadata:
          labels:
            app: backup-system
            backup-type: monitoring-data
        spec:
          serviceAccountName: backup-service
          restartPolicy: OnFailure
          containers:
          - name: monitoring-backup
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              # å®‰è£…å¿…è¦å·¥å…·
              apt-get update && apt-get install -y curl unzip
              
              # å®‰è£…AWS CLI
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
              unzip awscliv2.zip
              ./aws/install
              
              # åŠ è½½é…ç½®
              source /etc/backup/backup.conf
              
              # è®¾ç½®AWSå‡­è¯
              export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
              export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
              export AWS_DEFAULT_REGION="$AWS_DEFAULT_REGION"
              
              # æ‰§è¡Œå¤‡ä»½è„šæœ¬
              /scripts/backup-monitoring.sh
              
              # å‘é€é€šçŸ¥
              if [[ "$?" -eq 0 ]]; then
                /scripts/send-notification.sh "âœ… ç›‘æ§æ•°æ®å¤‡ä»½æˆåŠŸ" "success"
              else
                /scripts/send-notification.sh "âŒ ç›‘æ§æ•°æ®å¤‡ä»½å¤±è´¥" "error"
                exit 1
              fi
            envFrom:
            - secretRef:
                name: aws-credentials
            - configMapRef:
                name: backup-config
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
              readOnly: true
            - name: backup-config-vol
              mountPath: /etc/backup
              readOnly: true
            resources:
              requests:
                memory: "512Mi"
                cpu: "200m"
              limits:
                memory: "1Gi"
                cpu: "500m"
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-config
              defaultMode: 0755
              items:
              - key: backup-monitoring.sh
                path: backup-monitoring.sh
              - key: send-notification.sh
                path: send-notification.sh
          - name: backup-config-vol
            configMap:
              name: backup-config
              items:
              - key: backup.conf
                path: backup.conf

---
# ğŸ§¹ å¤‡ä»½æ¸…ç†ä»»åŠ¡
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-cleanup
  namespace: backup
  labels:
    app: backup-system
    backup-type: cleanup
spec:
  schedule: "0 5 * * 0"  # æ¯å‘¨æ—¥å‡Œæ™¨5ç‚¹æ‰§è¡Œæ¸…ç†
  successfulJobsHistoryLimit: 4
  failedJobsHistoryLimit: 2
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      activeDeadlineSeconds: 1800  # 30åˆ†é’Ÿè¶…æ—¶
      template:
        metadata:
          labels:
            app: backup-system
            backup-type: cleanup
        spec:
          serviceAccountName: backup-service
          restartPolicy: OnFailure
          containers:
          - name: backup-cleanup
            image: amazon/aws-cli:latest
            command:
            - /bin/bash
            - -c
            - |
              # åŠ è½½é…ç½®
              source /etc/backup/backup.conf
              
              log() {
                echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
              }
              
              log "å¼€å§‹æ¸…ç†è¿‡æœŸå¤‡ä»½..."
              
              # æ¸…ç†æ•°æ®åº“å¤‡ä»½ (ä¿ç•™7å¤©)
              log "æ¸…ç†æ•°æ®åº“å¤‡ä»½..."
              aws s3 ls "s3://${S3_BUCKET}/database/" --recursive | \
                awk '$1 <= "'$(date -d "${DB_BACKUP_RETENTION} days ago" '+%Y-%m-%d')'" {print $4}' | \
                xargs -I {} aws s3 rm "s3://${S3_BUCKET}/{}"
              
              # æ¸…ç†åº”ç”¨æ•°æ®å¤‡ä»½ (ä¿ç•™7å¤©)
              log "æ¸…ç†åº”ç”¨æ•°æ®å¤‡ä»½..."
              aws s3 ls "s3://${S3_BUCKET}/app-data/" --recursive | \
                awk '$1 <= "'$(date -d "${APP_BACKUP_RETENTION} days ago" '+%Y-%m-%d')'" {print $4}' | \
                xargs -I {} aws s3 rm "s3://${S3_BUCKET}/{}"
              
              # æ¸…ç†ç›‘æ§æ•°æ®å¤‡ä»½ (ä¿ç•™14å¤©)
              log "æ¸…ç†ç›‘æ§æ•°æ®å¤‡ä»½..."
              aws s3 ls "s3://${S3_BUCKET}/monitoring/" --recursive | \
                awk '$1 <= "'$(date -d "${MONITORING_BACKUP_RETENTION} days ago" '+%Y-%m-%d')'" {print $4}' | \
                xargs -I {} aws s3 rm "s3://${S3_BUCKET}/{}"
              
              # æ¸…ç†é…ç½®å¤‡ä»½ (ä¿ç•™30å¤©)
              log "æ¸…ç†é…ç½®å¤‡ä»½..."
              aws s3 ls "s3://${S3_BUCKET}/kubernetes-config/" --recursive | \
                awk '$1 <= "'$(date -d "${CONFIG_BACKUP_RETENTION} days ago" '+%Y-%m-%d')'" {print $4}' | \
                xargs -I {} aws s3 rm "s3://${S3_BUCKET}/{}"
              
              log "å¤‡ä»½æ¸…ç†å®Œæˆ"
              
              # å‘é€é€šçŸ¥
              /scripts/send-notification.sh "ğŸ§¹ å¤‡ä»½æ¸…ç†ä»»åŠ¡å®Œæˆ" "info"
            envFrom:
            - secretRef:
                name: aws-credentials
            - configMapRef:
                name: backup-config
            volumeMounts:
            - name: backup-scripts
              mountPath: /scripts
              readOnly: true
            - name: backup-config-vol
              mountPath: /etc/backup
              readOnly: true
            resources:
              requests:
                memory: "128Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: backup-scripts
            configMap:
              name: backup-config
              defaultMode: 0755
              items:
              - key: send-notification.sh
                path: send-notification.sh
          - name: backup-config-vol
            configMap:
              name: backup-config
              items:
              - key: backup.conf
                path: backup.conf