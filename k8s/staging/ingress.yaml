# ğŸŒ Stagingç¯å¢ƒIngressé…ç½®
# ä¸ºStagingç¯å¢ƒæä¾›HTTP/HTTPSå…¥å£å’ŒåŸŸåè·¯ç”±

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: figma-frame-faithful
  namespace: staging
  labels:
    app: figma-frame-faithful
    environment: staging
    tier: frontend
  annotations:
    # Ingress Controllerç±»å‹
    kubernetes.io/ingress.class: "nginx"
    
    # SSLé‡å®šå‘
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # è¯ä¹¦ç®¡ç†
    cert-manager.io/cluster-issuer: "letsencrypt-staging"
    cert-manager.io/acme-challenge-type: "http01"
    
    # é€Ÿç‡é™åˆ¶
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/rate-limit-rps: "10"
    
    # ç¼“å­˜é…ç½®
    nginx.ingress.kubernetes.io/proxy-cache-valid: "200 1h"
    nginx.ingress.kubernetes.io/cache-control: "public, max-age=3600"
    
    # å®‰å…¨å¤´
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://staging.figma-frame-faithful.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type, Authorization, X-Requested-With"
    
    # è‡ªå®šä¹‰é”™è¯¯é¡µé¢
    nginx.ingress.kubernetes.io/custom-http-errors: "404,500,502,503,504"
    nginx.ingress.kubernetes.io/default-backend: "default-http-backend"
    
    # è¯·æ±‚å¤§å°é™åˆ¶
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    
    # è¶…æ—¶è®¾ç½®
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    
    # ä»£ç†ç¼“å†²
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "4k"
    
    # WebSocketæ”¯æŒ
    nginx.ingress.kubernetes.io/websocket-services: "figma-frame-faithful"
    
    # è‡ªå®šä¹‰é…ç½®ç‰‡æ®µ
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # æ·»åŠ è‡ªå®šä¹‰å¤´éƒ¨
      add_header X-Environment "staging" always;
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      
      # Stagingç¯å¢ƒæ ‡è¯†
      add_header X-Staging-Instance "$hostname" always;
      
      # å¥åº·æ£€æŸ¥ç‰¹æ®Šå¤„ç†
      location /health {
        access_log off;
        add_header Content-Type application/json;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
      }
    
    # æœåŠ¡å™¨é…ç½®ç‰‡æ®µ
    nginx.ingress.kubernetes.io/server-snippet: |
      # é™åˆ¶è¯·æ±‚æ–¹æ³•
      if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$) {
        return 405;
      }
      
      # é˜»æ­¢æ¶æ„æœºå™¨äºº
      if ($http_user_agent ~* (wget|curl|scanner|bot)) {
        return 444;
      }
spec:
  tls:
  - hosts:
    - staging.figma-frame-faithful.com
    - staging-api.figma-frame-faithful.com
    secretName: staging-tls-secret
  rules:
  # ä¸»ç«™ç‚¹
  - host: staging.figma-frame-faithful.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: figma-frame-faithful
            port:
              number: 80
      # APIä»£ç†è·¯å¾„
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 3000
      # WebSocketè·¯å¾„
      - path: /ws
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 3000
      # å¥åº·æ£€æŸ¥è·¯å¾„
      - path: /health
        pathType: Exact
        backend:
          service:
            name: figma-frame-faithful
            port:
              number: 80
      # é™æ€èµ„æºè·¯å¾„ï¼ˆå¯é€‰çš„CDNå›æºï¼‰
      - path: /static
        pathType: Prefix
        backend:
          service:
            name: figma-frame-faithful
            port:
              number: 80
  
  # APIä¸“ç”¨åŸŸåï¼ˆå¯é€‰ï¼‰
  - host: staging-api.figma-frame-faithful.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 3000

---
# ğŸ›¡ï¸ ç½‘ç»œç­–ç•¥ - é™åˆ¶Stagingç¯å¢ƒçš„ç½‘ç»œè®¿é—®
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: figma-frame-faithful-staging-network-policy
  namespace: staging
  labels:
    app: figma-frame-faithful
    environment: staging
spec:
  podSelector:
    matchLabels:
      app: figma-frame-faithful
      environment: staging
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # å…è®¸æ¥è‡ªIngress Controllerçš„æµé‡
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 80
  # å…è®¸æ¥è‡ªåŒå‘½åç©ºé—´çš„Podè®¿é—®
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 80
  # å…è®¸æ¥è‡ªç›‘æ§ç³»ç»Ÿçš„è®¿é—®
  - from:
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 80
  egress:
  # å…è®¸DNSè§£æ
  - to: []
    ports:
    - protocol: UDP
      port: 53
  # å…è®¸è®¿é—®APIæœåŠ¡
  - to:
    - podSelector:
        matchLabels:
          app: api-service
    ports:
    - protocol: TCP
      port: 3000
  # å…è®¸è®¿é—®å¤–éƒ¨HTTPSæœåŠ¡ï¼ˆç”¨äºAPIè°ƒç”¨ï¼‰
  - to: []
    ports:
    - protocol: TCP
      port: 443
  # å…è®¸è®¿é—®å¤–éƒ¨HTTPæœåŠ¡ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰
  - to: []
    ports:
    - protocol: TCP
      port: 80

---
# ğŸ”§ HorizontalPodAutoscaler - Stagingç¯å¢ƒè‡ªåŠ¨æ‰©ç¼©å®¹
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: figma-frame-faithful-hpa
  namespace: staging
  labels:
    app: figma-frame-faithful
    environment: staging
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: figma-frame-faithful
  minReplicas: 1
  maxReplicas: 5
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Pods
        value: 1
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Pods
        value: 2
        periodSeconds: 60

---
# ğŸ“Š PodDisruptionBudget - ç¡®ä¿æœåŠ¡å¯ç”¨æ€§
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: figma-frame-faithful-pdb
  namespace: staging
  labels:
    app: figma-frame-faithful
    environment: staging
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: figma-frame-faithful
      environment: staging