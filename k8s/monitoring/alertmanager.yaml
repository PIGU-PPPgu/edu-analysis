# ğŸš¨ AlertManagerå‘Šè­¦ç®¡ç†ç³»ç»Ÿ
# å¤„ç†Prometheuså‘Šè­¦çš„è·¯ç”±ã€åˆ†ç»„å’Œé€šçŸ¥

apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app: alertmanager
data:
  alertmanager.yml: |
    global:
      # SMTPé…ç½®
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alerts@figma-frame-faithful.com'
      smtp_auth_username: 'alerts@figma-frame-faithful.com'
      smtp_auth_password: 'your-app-password'
      smtp_require_tls: true
      
      # Slacké…ç½®
      slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    
    # å‘Šè­¦æ¨¡æ¿
    templates:
      - '/etc/alertmanager/templates/*.tmpl'
    
    # è·¯ç”±é…ç½®
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'web.hook'
      routes:
        # ä¸¥é‡å‘Šè­¦ç«‹å³é€šçŸ¥
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 5s
          repeat_interval: 5m
        
        # è­¦å‘Šå‘Šè­¦åˆ†ç»„é€šçŸ¥
        - match:
            severity: warning
          receiver: 'warning-alerts'
          group_wait: 30s
          repeat_interval: 30m
        
        # åŸºç¡€è®¾æ–½å‘Šè­¦
        - match_re:
            alertname: 'Node.*|Kubernetes.*'
          receiver: 'infrastructure-alerts'
        
        # åº”ç”¨å‘Šè­¦
        - match_re:
            alertname: 'Pod.*|High.*'
          receiver: 'application-alerts'
    
    # æŠ‘åˆ¶è§„åˆ™
    inhibit_rules:
      # å¦‚æœèŠ‚ç‚¹å®•æœºï¼ŒæŠ‘åˆ¶è¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å…¶ä»–å‘Šè­¦
      - source_match:
          alertname: 'NodeDown'
        target_match_re:
          alertname: 'Node.*|Pod.*'
        equal: ['instance']
      
      # å¦‚æœPodå´©æºƒå¾ªç¯ï¼ŒæŠ‘åˆ¶èµ„æºç›¸å…³å‘Šè­¦
      - source_match:
          alertname: 'PodCrashLooping'
        target_match_re:
          alertname: 'PodHigh.*'
        equal: ['pod', 'namespace']
    
    # æ¥æ”¶å™¨é…ç½®
    receivers:
      # é»˜è®¤æ¥æ”¶å™¨
      - name: 'web.hook'
        webhook_configs:
          - url: 'http://localhost:5001/'
            send_resolved: true
      
      # ä¸¥é‡å‘Šè­¦æ¥æ”¶å™¨
      - name: 'critical-alerts'
        email_configs:
          - to: 'admin@figma-frame-faithful.com'
            subject: 'ğŸš¨ ä¸¥é‡å‘Šè­¦ - {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              æ ‡ç­¾: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
              {{ end }}
            html: |
              <!DOCTYPE html>
              <html>
              <head>
                <style>
                  body { font-family: Arial, sans-serif; }
                  .alert { background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; margin: 10px 0; border-radius: 5px; }
                  .critical { background-color: #dc3545; color: white; }
                </style>
              </head>
              <body>
                <h2>ğŸš¨ ä¸¥é‡å‘Šè­¦é€šçŸ¥</h2>
                {{ range .Alerts }}
                <div class="alert critical">
                  <h3>{{ .Annotations.summary }}</h3>
                  <p><strong>æè¿°:</strong> {{ .Annotations.description }}</p>
                  <p><strong>æ—¶é—´:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
                  <p><strong>æ ‡ç­¾:</strong> {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}</p>
                </div>
                {{ end }}
              </body>
              </html>
        slack_configs:
          - channel: '#alerts-critical'
            title: 'ğŸš¨ ä¸¥é‡å‘Šè­¦'
            text: |
              {{ range .Alerts }}
              *å‘Šè­¦:* {{ .Annotations.summary }}
              *æè¿°:* {{ .Annotations.description }}
              *æ—¶é—´:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
            color: 'danger'
      
      # è­¦å‘Šå‘Šè­¦æ¥æ”¶å™¨
      - name: 'warning-alerts'
        email_configs:
          - to: 'ops@figma-frame-faithful.com'
            subject: 'âš ï¸ è­¦å‘Šå‘Šè­¦ - {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
        slack_configs:
          - channel: '#alerts-warning'
            title: 'âš ï¸ è­¦å‘Šå‘Šè­¦'
            text: |
              {{ range .Alerts }}
              *å‘Šè­¦:* {{ .Annotations.summary }}
              *æè¿°:* {{ .Annotations.description }}
              {{ end }}
            color: 'warning'
      
      # åŸºç¡€è®¾æ–½å‘Šè­¦æ¥æ”¶å™¨
      - name: 'infrastructure-alerts'
        email_configs:
          - to: 'infrastructure@figma-frame-faithful.com'
            subject: 'ğŸ—ï¸ åŸºç¡€è®¾æ–½å‘Šè­¦ - {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              èŠ‚ç‚¹: {{ .Labels.instance }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
        slack_configs:
          - channel: '#infrastructure'
            title: 'ğŸ—ï¸ åŸºç¡€è®¾æ–½å‘Šè­¦'
            text: |
              {{ range .Alerts }}
              *èŠ‚ç‚¹:* {{ .Labels.instance }}
              *å‘Šè­¦:* {{ .Annotations.summary }}
              *æè¿°:* {{ .Annotations.description }}
              {{ end }}
      
      # åº”ç”¨å‘Šè­¦æ¥æ”¶å™¨
      - name: 'application-alerts'
        email_configs:
          - to: 'development@figma-frame-faithful.com'
            subject: 'ğŸ“± åº”ç”¨å‘Šè­¦ - {{ .GroupLabels.alertname }}'
            body: |
              {{ range .Alerts }}
              å‘Šè­¦: {{ .Annotations.summary }}
              æè¿°: {{ .Annotations.description }}
              æœåŠ¡: {{ .Labels.pod }}
              å‘½åç©ºé—´: {{ .Labels.namespace }}
              æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
              {{ end }}
        slack_configs:
          - channel: '#applications'
          title: 'ğŸ“± åº”ç”¨å‘Šè­¦'
          text: |
            {{ range .Alerts }}
            *æœåŠ¡:* {{ .Labels.pod }}
            *å‘½åç©ºé—´:* {{ .Labels.namespace }}
            *å‘Šè­¦:* {{ .Annotations.summary }}
            *æè¿°:* {{ .Annotations.description }}
            {{ end }}

  # å‘Šè­¦æ¨¡æ¿
  email.tmpl: |
    {{ define "email.default.subject" }}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.alertname }}
    {{ end }}
    
    {{ define "email.default.html" }}
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background-color: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .alert { border: 1px solid #dee2e6; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .firing { background-color: #f8d7da; border-color: #f5c6cb; }
        .resolved { background-color: #d4edda; border-color: #c3e6cb; }
        .summary { font-weight: bold; font-size: 16px; margin-bottom: 10px; }
        .description { margin-bottom: 10px; }
        .labels { font-size: 12px; color: #6c757d; }
        .timestamp { font-size: 12px; color: #6c757d; margin-top: 10px; }
      </style>
    </head>
    <body>
      <div class="header">
        <h1>{{ if eq .Status "firing" }}ğŸš¨{{ else }}âœ…{{ end }} å‘Šè­¦é€šçŸ¥</h1>
        <p>é›†ç¾¤: figma-frame-faithful-production</p>
        <p>çŠ¶æ€: {{ .Status | title }}</p>
        <p>æ—¶é—´: {{ .CommonAnnotations.timestamp }}</p>
      </div>
      
      {{ if .Alerts.Firing }}
      <h2>ğŸ”¥ æ´»è·ƒå‘Šè­¦ ({{ .Alerts.Firing | len }})</h2>
      {{ range .Alerts.Firing }}
      <div class="alert firing">
        <div class="summary">{{ .Annotations.summary }}</div>
        <div class="description">{{ .Annotations.description }}</div>
        <div class="labels">
          æ ‡ç­¾: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
        </div>
        <div class="timestamp">å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}</div>
      </div>
      {{ end }}
      {{ end }}
      
      {{ if .Alerts.Resolved }}
      <h2>âœ… å·²è§£å†³å‘Šè­¦ ({{ .Alerts.Resolved | len }})</h2>
      {{ range .Alerts.Resolved }}
      <div class="alert resolved">
        <div class="summary">{{ .Annotations.summary }}</div>
        <div class="description">{{ .Annotations.description }}</div>
        <div class="labels">
          æ ‡ç­¾: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
        </div>
        <div class="timestamp">
          å¼€å§‹æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}<br>
          ç»“æŸæ—¶é—´: {{ .EndsAt.Format "2006-01-02 15:04:05" }}
        </div>
      </div>
      {{ end }}
      {{ end }}
      
      <hr>
      <p style="font-size: 12px; color: #6c757d;">
        æ­¤é‚®ä»¶ç”± Figma Frame Faithful ç›‘æ§ç³»ç»Ÿè‡ªåŠ¨å‘é€<br>
        å¦‚éœ€å¸®åŠ©ï¼Œè¯·è”ç³»è¿ç»´å›¢é˜Ÿ: ops@figma-frame-faithful.com
      </p>
    </body>
    </html>
    {{ end }}

---
# ğŸª PersistentVolumeClaim - AlertManageræ•°æ®å­˜å‚¨
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: alertmanager-pvc
  namespace: monitoring
  labels:
    app: alertmanager
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: fast-ssd

---
# ğŸš€ Deployment - AlertManager
apiVersion: apps/v1
kind: Deployment
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: alertmanager
  template:
    metadata:
      labels:
        app: alertmanager
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9093"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534
        fsGroup: 65534
      containers:
      - name: alertmanager
        image: prom/alertmanager:v0.26.0
        args:
          - '--config.file=/etc/alertmanager/alertmanager.yml'
          - '--storage.path=/alertmanager'
          - '--data.retention=120h'
          - '--web.listen-address=:9093'
          - '--web.external-url=http://localhost:9093'
          - '--log.level=info'
          - '--log.format=logfmt'
        ports:
        - name: web
          containerPort: 9093
          protocol: TCP
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "200m"
        volumeMounts:
        - name: config
          mountPath: /etc/alertmanager
          readOnly: true
        - name: storage
          mountPath: /alertmanager
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9093
          initialDelaySeconds: 30
          timeoutSeconds: 10
          periodSeconds: 30
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9093
          initialDelaySeconds: 30
          timeoutSeconds: 10
          periodSeconds: 10
          failureThreshold: 3
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
      volumes:
      - name: config
        configMap:
          name: alertmanager-config
      - name: storage
        persistentVolumeClaim:
          claimName: alertmanager-pvc

---
# ğŸŒ Service - AlertManager
apiVersion: v1
kind: Service
metadata:
  name: alertmanager
  namespace: monitoring
  labels:
    app: alertmanager
  annotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9093"
spec:
  type: ClusterIP
  ports:
  - name: web
    port: 9093
    targetPort: web
    protocol: TCP
  selector:
    app: alertmanager