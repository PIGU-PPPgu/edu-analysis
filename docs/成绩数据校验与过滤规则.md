# 📊 成绩数据校验与增值计算的数据过滤规则

## 🎯 核心原则

**数据导入**和**增值计算**是两个独立阶段，有不同的数据要求：

```
数据导入阶段（宽松）       增值计算阶段（严格）
      ↓                          ↓
  姓名可以为空              必须有姓名
  成绩可以为空              至少有一门成绩
      ↓                          ↓
  ⚠️ 警告但允许导入        🔍 自动过滤不完整记录
```

---

## 📋 数据导入阶段规则

### ✅ 必填字段（导致校验失败）

| 字段 | 要求 | 失败后果 |
|------|------|----------|
| 学号 | **必须有值** | ❌ 无法导入 |

### ⚠️ 可选字段（只警告，不阻止导入）

| 字段 | 校验规则 | 警告提示 |
|------|----------|----------|
| 姓名 | 可以为空 | "姓名为空，增值计算时将跳过此记录" |
| 科目成绩 | 可以全部为空 | "没有任何科目成绩，增值计算时将跳过此记录" |
| 成绩范围 | 0-150 | "XX成绩(YY)超出常规范围(0-150)" |

### 校验状态说明

```typescript
status: 'passed'   // ✅ 无错误，无警告
status: 'warning'  // ⚠️ 有警告，但可以导入
status: 'failed'   // ❌ 有错误，无法导入
```

**关键点**：
- `warnings` 不会阻止导入！
- 只有 `errors` 才会导致 `status: 'failed'`

---

## 🔍 增值计算阶段规则

### 自动过滤条件

当进行增值计算时，系统会自动过滤掉以下记录：

#### 1. 姓名为空
```typescript
if (!record.name || String(record.name).trim() === '') {
  // 跳过该记录
}
```

**原因**：增值报告需要学生姓名进行标识

#### 2. 所有科目成绩都为空
```typescript
const subjects = ['chinese', 'math', 'english', 'physics',
                 'chemistry', 'biology', 'politics', 'history', 'geography'];

const hasValidScore = subjects.some(subject => {
  const score = record[`${subject}_score`];
  return score !== null && score !== undefined && score !== '' && !isNaN(Number(score));
});

if (!hasValidScore) {
  // 跳过该记录
}
```

**原因**：增值计算需要至少一门科目的成绩数据

### 过滤函数实现

**位置**：`src/components/analysis/services/valueAddedUtils.ts`

```typescript
export function filterCompleteRecordsForValueAdded(records: any[]): {
  validRecords: any[];
  filteredCount: number;
  filteredReasons: { name: number; scores: number };
} {
  const filteredReasons = { name: 0, scores: 0 };

  const validRecords = records.filter(record => {
    // 检查姓名
    if (!record.name || String(record.name).trim() === '') {
      filteredReasons.name++;
      return false;
    }

    // 检查是否有至少一门有效科目成绩
    const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry',
                     'biology', 'politics', 'history', 'geography'];

    const hasValidScore = subjects.some(subject => {
      const score = record[`${subject}_score`];
      return score !== null && score !== undefined && score !== '' && !isNaN(Number(score));
    });

    if (!hasValidScore) {
      filteredReasons.scores++;
      return false;
    }

    return true;
  });

  return {
    validRecords,
    filteredCount: records.length - validRecords.length,
    filteredReasons
  };
}
```

---

## 📊 实际场景示例

### 场景1: 部分学生缺考

**Excel数据**：
| 学号 | 姓名 | 语文 | 数学 | 英语 |
|------|------|------|------|------|
| 001  | 张三 | 85   | 92   | 78   |
| 002  | 李四 | Q    | Q    | Q    |  ← 全部缺考
| 003  | 王五 | 90   | 88   | 95   |

**导入阶段**：
- ✅ 全部导入成功（包括李四）
- ⚠️ 警告：第2行没有任何科目成绩

**增值计算阶段**：
- ✅ 张三：有成绩，参与计算
- ❌ 李四：所有成绩为Q（缺考），**自动跳过**
- ✅ 王五：有成绩，参与计算

**结果**：增值报告只包含张三和王五

---

### 场景2: 姓名缺失

**Excel数据**：
| 学号 | 姓名 | 语文 | 数学 | 英语 |
|------|------|------|------|------|
| 001  | 张三 | 85   | 92   | 78   |
| 002  |      | 90   | 88   | 95   |  ← 姓名为空
| 003  | 王五 | 92   | 90   | 88   |

**导入阶段**：
- ✅ 全部导入成功（包括学号002的记录）
- ⚠️ 警告：第2行姓名为空，增值计算时将跳过

**增值计算阶段**：
- ✅ 张三：完整数据，参与计算
- ❌ 学号002：姓名为空，**自动跳过**
- ✅ 王五：完整数据，参与计算

**结果**：增值报告只包含张三和王五

---

### 场景3: 部分科目缺考（正常情况）

**Excel数据**：
| 学号 | 姓名 | 语文 | 数学 | 英语 | 物理 |
|------|------|------|------|------|------|
| 001  | 张三 | 85   | 92   | 78   | Q    |  ← 物理缺考
| 002  | 李四 | 90   | 88   | 95   | 85   |

**导入阶段**：
- ✅ 全部导入成功

**增值计算阶段**：
- ✅ 张三：有语文、数学、英语成绩，**参与计算**（物理标记为缺考）
- ✅ 李四：全部有成绩，参与计算

**结果**：两人都参与增值计算，张三的物理成绩不参与统计

---

## 🔧 修改内容总结

### 修改文件：`src/services/excelImportService.ts`

**修改前**：
```typescript
// ❌ 姓名为空 → 错误 → 无法导入
if (!row.student_name) errors.push(`第${index + 1}行: 姓名不能为空`);
```

**修改后**：
```typescript
// ✅ 姓名为空 → 警告 → 可以导入
if (!row.student_name || String(row.student_name).trim() === '') {
  warnings.push(`第${index + 1}行: 姓名为空，增值计算时将跳过此记录`);
}

// ✅ 成绩为空 → 警告 → 可以导入
if (scoreCount === 0) {
  warnings.push(`第${index + 1}行: 没有任何科目成绩，增值计算时将跳过此记录`);
}
```

---

## ✅ 用户操作指南

### 导入成绩数据时

1. **看到警告提示不用担心**：
   ```
   ⚠️ 第X行: 姓名为空，增值计算时将跳过此记录
   ⚠️ 第Y行: 没有任何科目成绩，增值计算时将跳过此记录
   ```
   这些是**警告**，不会阻止导入！

2. **可以正常点击"下一步"继续导入**

3. **增值计算时会自动处理**：
   - 系统会自动跳过不完整的记录
   - 只使用完整的记录进行计算
   - 生成的报告会显示实际参与计算的学生数

### 增值计算时

**计算日志示例**：
```
[增值计算] 总记录数: 100
[增值计算] 过滤掉姓名为空: 5 条
[增值计算] 过滤掉成绩为空: 3 条
[增值计算] 有效记录数: 92
[增值计算] 开始计算...
```

---

## 🎯 常见问题

### Q1: 为什么导入时允许姓名为空？
**A**: 某些情况下可能需要先导入学号和成绩，后续再补充姓名。允许导入增加了灵活性。

### Q2: 姓名为空的记录会影响增值计算吗？
**A**: 不会。增值计算时会自动过滤掉姓名为空的记录。

### Q3: 如果一个学生部分科目缺考怎么办？
**A**: 只要有**至少一门**科目成绩，该学生就会参与计算。缺考的科目会被标记为特殊值（Q）。

### Q4: 如何知道哪些记录被过滤了？
**A**:
- 导入阶段：查看警告列表
- 计算阶段：查看控制台日志（显示过滤统计）

---

**文档版本**: v1.0
**创建日期**: 2025-01-30
**适用范围**: 增值评价系统
