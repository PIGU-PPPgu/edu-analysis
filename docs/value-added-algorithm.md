# 增值评价计算引擎算法文档

## 概述

本文档详细说明增值评价系统的核心算法逻辑、统计方法和数据处理规则。

---

## 1. 核心概念

### 1.1 增值评价的定义

**增值（Value Added）**：衡量学生在一段时间内学业水平的变化，排除起点差异，真实反映教学效果。

**公式基础**：
```
增值率 = (出口标准分 - 入口标准分) / 入口标准分
标准分 = 500 + 100 × Z分数
```

### 1.2 为什么使用Z分数

- **消除量纲影响**：不同考试满分不同，原始分无法直接比较
- **体现相对位置**：Z分数表示学生在群体中的相对位置
- **统计学标准**：Z分数服从标准正态分布，便于等级划分

---

## 2. 数据预处理

### 2.1 缺考记录过滤（关键修复）

**问题背景**：初一16班语文增值率异常高（33.67%），根源是13个0分学生参与了计算。

**修复策略**：混合模式缺考判断
```typescript
const isAbsent = (score: number, absentFlag: boolean) => {
  return absentFlag === true || score === 0;
};
```

**理由**：
1. K12教育场景中，真实考0分几乎不存在（主观题总能得分）
2. 0分基本等同于缺考
3. 即使数据库absent字段未正确标记，也能自动过滤

**实施位置**：`valueAddedActivityService.ts:582-599`

**影响**：
- **修复前**：33.67%增值率（38个学生，含13个0分）
- **修复后**：~5-10%增值率（25个有效学生）

### 2.2 异常值检测

**Z-score异常值阈值**：|Z| > 3
- 超过3倍标准差的数据点标记为异常
- 不自动排除，但在结果中标记警告

**实施函数**：`statistics.ts::detectOutliers()`

---

## 3. Z分数标准化

### 3.1 计算方法

**公式**：
```
Z = (X - μ) / σ

其中：
X = 学生原始分数
μ = 全年级平均分
σ = 全年级标准差
```

**实施函数**：`statistics.ts::calculateZScores()`

**关键点**：
- ✅ **全年级标准化**：Z分数基于全年级计算，不是按班级
- ✅ **保留负Z值**：入口成绩低的学生会有负Z值，这是正常现象
- ✅ **标准差为0处理**：如果全部同分，Z分数设为0

### 3.2 标准分转换

**公式**：
```
标准分 = 500 + 100 × Z

标准分范围：
- Z = -3 → 标准分 = 200
- Z = 0  → 标准分 = 500
- Z = +3 → 标准分 = 800
```

**优势**：
- 易于理解（500为平均水平）
- 避免负数（便于展示）
- 符合教育测量惯例

---

## 4. 增值率计算

### 4.1 分数增值率

**公式**：
```typescript
增值率 = (出口标准分 - 入口标准分) / 入口标准分
```

**示例**：
```
学生A：
  入口分60 → Z=-1.0 → 标准分=400
  出口分75 → Z=-0.5 → 标准分=450
  增值率 = (450 - 400) / 400 = 12.5%

学生B：
  入口分0 → Z=-2.5 → 标准分=250（缺考，应排除）
  出口分60 → Z=0 → 标准分=500
  增值率 = (500 - 250) / 250 = 100%（虚高！）
```

**实施函数**：`statistics.ts::calculateScoreValueAddedRate()`

### 4.2 能力增值指标

#### 4.2.1 巩固率（Consolidation Rate）

**定义**：入口即为优秀（A+），且出口保持优秀的学生占比

**公式**：
```
巩固率 = (保持A+的学生数) / (入口为A+的学生总数)
```

**意义**：衡量对优秀学生的保持能力

#### 4.2.2 转化率（Transformation Rate）

**定义**：入口非优秀，出口提升等级的学生占比

**公式**：
```
转化率 = (等级提升的学生数) / (入口非A+的学生总数)
```

**意义**：衡量对后进生的提升能力

#### 4.2.3 贡献率（Contribution Rate）

**定义**：该班/教师对全年级优秀人数增加的贡献

**公式**：
```
贡献率 = (该班优秀净增) / (全年级优秀净增)
```

---

## 5. 等级划分

### 5.1 基于百分位的等级

**默认配置**（参照汇优评）：

| 等级 | 百分位范围 | 描述 | 占比 |
|------|-----------|------|------|
| A+   | 0-5%      | 优秀+ | 前5% |
| A    | 5-25%     | 优秀  | 20% |
| B+   | 25-50%    | 良好+ | 25% |
| B    | 50-75%    | 良好  | 25% |
| C+   | 75-95%    | 合格+ | 20% |
| C    | 95-100%   | 合格  | 后5% |

**实施函数**：`statistics.ts::determineLevel()`

### 5.2 百分位计算

**方法**：降序排名
```typescript
百分位 = (排名 - 1) / 总人数

例：38个学生中排第5名
百分位 = (5-1) / 38 = 10.5% → 等级A
```

---

## 6. 统计有效性验证（新增）

### 6.1 样本量检查

**阈值**：n < 30

**警告信息**：
```
"样本量不足（n=25），置信度较低，建议谨慎解读"
```

**统计学依据**：
- 中心极限定理要求n≥30
- 小样本的统计推断置信度低

### 6.2 增值率合理性检查

**阈值设定**：

| 范围 | 标签 | 说明 |
|------|------|------|
| ±15%以内 | 正常波动 | 合理范围 |
| 15-20% | 显著变化 | 需关注 |
| 20-30% | 偏高 | 超出常见范围 |
| >30% | 严重异常 | 疑似数据问题 |

**警告示例**：
```json
{
  "warnings": [
    "增值率异常高（33.7%），疑似数据异常或样本偏差，请检查原始数据"
  ],
  "is_statistically_significant": false
}
```

### 6.3 异常值检测

**Z-score阈值**：|Z| > 3

**含义**：超过3倍标准差，出现概率<0.3%

**处理**：
- 不自动删除
- 在结果中标记警告
- 提示人工复核

**实施函数**：`valueAddedValidation.ts::detectZScoreOutliers()`

---

## 7. 多维度分析

### 7.1 学生增值

**输入**：单个学生的入口/出口成绩
**输出**：
- Z分数变化
- 标准分变化
- 增值率
- 等级变化（如B→A）

**实施服务**：`studentValueAddedService.ts`

### 7.2 班级增值

**输入**：班级全体学生的成绩
**输出**：
- 班级平均增值率
- 进步学生比例
- 巩固率、转化率
- 优秀人数变化

**关键**：Z分数基于全年级计算，不是班级内部

**实施服务**：`classValueAddedService.ts`

### 7.3 教师增值

**输入**：教师所教学生的成绩
**输出**：
- 教师平均增值率
- 教学班级的进步比例
- 对年级优秀率的贡献

**实施服务**：`teacherValueAddedService.ts`

---

## 8. 常见问题

### Q1: 为什么0分学生的增值率特别高？

**原因**：
- 0分 → Z=-2.5（假设） → 标准分=250
- 任何正常出口分（如60分，Z=0，标准分=500）
- 增值率 = (500-250)/250 = 100%

**解决**：0分等同缺考，在数据预处理阶段过滤

### Q2: 增值率为负数是否正常？

**正常**：
- 负增值表示出口表现低于预期
- 可能原因：学生状态波动、考试难度差异
- 不代表教学失败，需结合具体情况分析

### Q3: 如何解读"样本量不足"警告？

**含义**：
- n<30时，统计推断的置信度降低
- 结果仍有参考价值，但不宜过度解读

**建议**：
- 结合更多维度数据
- 关注趋势而非绝对数值
- 增加观察周期

### Q4: Z分数为0是什么意思？

**含义**：
- 该学生成绩恰好等于全年级平均分
- 标准分 = 500
- 处于中等水平

---

## 9. 算法迭代历史

### v1.0（初始版本）
- 基础Z分数标准化
- 简单增值率计算
- ❌ 问题：未处理缺考数据

### v1.1（当前版本）
- ✅ 强化缺考过滤（混合模式）
- ✅ 新增统计有效性验证
- ✅ 异常值检测和警告
- ✅ 扩展类型定义（warnings、is_statistically_significant）

---

## 10. 参考文献

1. **汇优评增值评价系统**：标准分转换公式、等级划分
2. **教育统计学**：Z分数标准化、百分位计算
3. **测量与评价**：增值评价的理论基础

---

## 附录：核心公式速查表

```typescript
// 1. Z分数
Z = (X - μ) / σ

// 2. 标准分
标准分 = 500 + 100 × Z

// 3. 增值率
增值率 = (出口标准分 - 入口标准分) / 入口标准分

// 4. 百分位（降序）
百分位 = (排名 - 1) / 总人数

// 5. 巩固率
巩固率 = (保持A+的学生数) / (入口为A+的学生总数)

// 6. 转化率
转化率 = (等级提升的学生数) / (入口非A+的学生总数)

// 7. 贡献率
贡献率 = (该班优秀净增) / (全年级优秀净增)
```

---

**文档版本**：v1.1
**最后更新**：2024年12月
**维护者**：计算引擎架构师 (calc-architect)
