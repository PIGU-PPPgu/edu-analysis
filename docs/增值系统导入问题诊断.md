# 🔍 增值系统数据导入问题诊断指南

## 问题现象
点击"下一步：校验数据"后，显示"数据校验失败"，但后台不报错。

---

## 🎯 问题根源分析

### 根源1: 班级名称格式不统一 ❌

**问题**: 模板中使用了 `高一(1)班`（有括号），但系统要求无括号格式

**修复**: 已更新所有模板为统一格式 `高一1班`

### 根源2: 字段映射问题

**DataImportWorkflow.tsx 第232行**的校验逻辑：
```typescript
const hasFatalErrors = results.some(r => r.status === 'failed');
if (hasFatalErrors) {
  toast.error('数据校验失败，请修复错误后重试');  // ❌ 只显示这个
} else {
  setCurrentStep(2);
  toast.success('数据校验通过！');
}
```

**问题**:
- 如果校验失败，只显示通用错误
- **没有显示具体错误内容**
- 控制台可能有详细错误，但用户看不到

---

## 🔧 如何调试

### 步骤1: 打开浏览器控制台

1. 按 `F12` 或 `Cmd+Option+I`（Mac）
2. 点击 `Console` 标签
3. 清空控制台（垃圾桶图标）
4. 重新上传文件并点击"下一步"

### 步骤2: 查看校验结果详情

校验失败时，在 **第二步页面** 会显示详细错误：

```tsx
<StepTwoValidation
  validationResults={validationResults}  // ← 这里有详细错误
  ...
/>
```

**但是**，如果 `hasFatalErrors = true`（第232行），**不会跳转到第二步**，所以看不到错误详情！

### 步骤3: 临时调试修改（可选）

编辑 `DataImportWorkflow.tsx:232-238`，改为：

```typescript
const hasFatalErrors = results.some(r => r.status === 'failed');

// 🔍 调试：总是进入第二步查看详情
console.log('[调试] 校验结果:', results);
setCurrentStep(2);  // 强制进入第二步

if (hasFatalErrors) {
  toast.error('数据校验失败，请在下一步查看详细错误');
} else {
  toast.success('数据校验通过！');
}
```

这样可以看到详细的错误信息。

---

## 📋 常见校验失败原因

### 1. 学生信息表

| 错误提示 | 原因 | 解决方案 |
|----------|------|----------|
| "学号不能为空" | Excel某行学号为空 | 检查每一行的学号列 |
| "姓名不能为空" | Excel某行姓名为空 | 检查姓名列 |
| "班级不能为空" | Excel某行班级名称为空 | 检查班级名称列 |
| "学号XXX重复" | 同一个学号出现多次 | 检查是否有重复学号 |

### 2. 教学编排表

| 错误提示 | 原因 | 解决方案 |
|----------|------|----------|
| "班级不能为空" | 班级名称列为空 | 填写班级名称 |
| "教师姓名不能为空" | 教师姓名列为空 | 填写教师姓名 |
| "科目不能为空" | 科目列为空 | 填写科目 |

### 3. 成绩表

| 错误提示 | 原因 | 解决方案 |
|----------|------|----------|
| "学号XXX在学生信息表中不存在" | 交叉校验失败 | 确保成绩表的学号在学生信息表中存在 |
| "学号不能为空" | 成绩表某行学号为空 | 补充学号 |

---

## ✅ 检查清单

使用最新模板前的准备：

- [ ] 重新下载所有模板（已修复）
- [ ] 打开模板，查看"填写说明"sheet
- [ ] 删除模板中的前3行说明（必填字段、表头、格式说明）
- [ ] 确保班级名称格式为：高一1班（无括号）
- [ ] 学生信息表：检查学号、姓名、班级名称都不为空
- [ ] 教学编排表：不填写教师工号，只填教师姓名
- [ ] 成绩表：学号必须与学生信息表一致

---

## 🛠️ 代码修复建议

### 改进1: 显示详细错误（推荐）

修改 `handleNextToValidation` 函数：

```typescript
const handleNextToValidation = () => {
  // ... 现有校验逻辑 ...

  setValidationResults(results);

  // 改进：即使有错误，也跳转到第二步显示详情
  setCurrentStep(2);

  const hasFatalErrors = results.some(r => r.status === 'failed');
  if (hasFatalErrors) {
    toast.error('数据校验失败，请查看下方错误详情');
  } else {
    toast.success('数据校验通过！');
  }
};
```

### 改进2: 在第一步页面直接显示错误

在第一步页面底部添加即时校验反馈：

```tsx
{validationResults.length > 0 && (
  <Alert variant={hasFatalErrors ? 'destructive' : 'default'}>
    <AlertCircle className="h-4 w-4" />
    <AlertDescription>
      <strong>预检结果：</strong>
      {validationResults.map((result, i) => (
        <div key={i}>
          {result.status === 'failed' && result.errors.length > 0 && (
            <ul className="mt-2">
              {result.errors.slice(0, 3).map((error, j) => (
                <li key={j} className="text-red-600">• {error}</li>
              ))}
            </ul>
          )}
        </div>
      ))}
    </AlertDescription>
  </Alert>
)}
```

---

## 📞 如果问题仍然存在

1. **截图以下内容**：
   - 浏览器控制台的错误信息
   - Excel文件的前5行（脱敏处理）
   - 点击"下一步"后的提示信息

2. **检查以下内容**：
   - 模板是否删除了说明行
   - 班级名称格式是否正确
   - 学号列是否有空值

3. **临时解决方案**：
   - 使用最新下载的模板
   - 确保数据从第4行开始
   - 逐个文件测试（先只上传学生信息表）

---

**文档版本**: v1.0
**创建日期**: 2025-01-30
**适用范围**: 增值评价系统数据导入
