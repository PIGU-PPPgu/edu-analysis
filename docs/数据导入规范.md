# 📋 数据导入规范文档

## 一、成绩导入模板规范

### 1.1 班级名称格式 ✅

**统一格式**: `高[年级][班号]班`

**正确示例**:
```
✅ 高一1班
✅ 高二3班
✅ 高三12班
✅ 初一1班
✅ 初二5班
```

**错误示例**:
```
❌ 高三(1)班     - 禁止使用括号
❌ 一班          - 必须包含年级
❌ 高1班         - 年级必须用汉字
❌ 高一一班      - 班号必须用数字
```

**重要性**: 班级名称是关联学生数据的关键字段，格式不统一会导致：
- 数据匹配失败
- 统计分析错误
- 增值评价无法关联

---

### 1.2 成绩导入的两种模式

系统会根据Excel列名**自动检测**导入模式：

#### ✅ 模式一：完整导入模式
**适用场景**: 导入新学生成绩或首次导入

**必填字段**:
- `学号` (student_id) - 学生唯一标识
- `姓名` (name) - 学生姓名
- `班级` (class_name) - 格式见上文

**可选字段**:
- 各科目成绩 (语文、数学、英语等)
- 总分
- 排名

**效果**: 系统会自动创建不存在的学生

**Excel示例**:
| 学号 | 姓名 | 班级    | 语文 | 数学 | 英语 | 总分 |
|------|------|---------|------|------|------|------|
| 001  | 张三 | 高一1班 | 85   | 92   | 78   | 255  |
| 002  | 李四 | 高一1班 | 78   | 85   | 92   | 255  |

---

#### ✅ 模式二：仅成绩导入模式
**适用场景**: 为已存在的学生补充成绩

**必填字段**:
- `学号` (student_id) - 仅需学号

**可选字段**:
- 各科目成绩
- 总分
- 排名

**效果**:
- 系统只关联已存在的学生
- 学号不存在的记录会被**跳过**（不报错）
- 导入完成后会显示跳过记录的统计

**Excel示例**:
| 学号 | 语文 | 数学 | 英语 | 总分 |
|------|------|------|------|------|
| 001  | 85   | 92   | 78   | 255  |
| 002  | 78   | 85   | 92   | 255  |

**注意**: 不需要姓名和班级列，系统会自动检测为"仅成绩模式"

---

### 1.3 字段说明

#### 核心字段
| 字段名 | Excel列名 | 类型   | 完整模式 | 仅成绩模式 | 说明 |
|--------|-----------|--------|----------|------------|------|
| student_id | 学号 | 文本 | ✅ 必填 | ✅ 必填 | 学生唯一标识，不能为空 |
| name | 姓名 | 文本 | ✅ 必填 | ❌ 不需要 | 学生姓名 |
| class_name | 班级 | 文本 | ✅ 必填 | ❌ 不需要 | 格式：高一1班 |

#### 考试信息字段
| 字段名 | Excel列名 | 类型 | 必填 | 说明 |
|--------|-----------|------|------|------|
| exam_id | 考试ID | 文本 | 可选 | 考试唯一标识 |
| exam_title | 考试名称 | 文本 | 可选 | 如：2024年期中考试 |
| exam_type | 考试类型 | 文本 | 可选 | 如：期中考试、期末考试 |
| exam_date | 考试日期 | 日期 | 可选 | 格式：YYYY-MM-DD |

#### 成绩字段
| 字段名 | Excel列名 | 类型 | 必填 | 说明 |
|--------|-----------|------|------|------|
| [科目]_score | 语文、数学等 | 数字 | 可选 | 单科成绩 |
| total_score | 总分 | 数字 | 可选 | 总分 |
| [科目]_grade | [科目]等级 | 文本 | 可选 | 如：A、B、C |

---

## 二、教师编排表规范（增值评价专用）

### 2.1 当前问题 🚨

**严重设计缺陷**: Excel中的"教师工号"与数据库的`teacher_id`(UUID)不匹配！

**当前字段定义**（有问题）:
```typescript
teacher_id: String(row['教师工号'] || ...)  // ❌ 字符串"T001"
// 但数据库期望:
teacher_id UUID  // ❌ UUID "123e4567-..."
```

**导致后果**:
- ❌ 教师编排表导入会失败
- ❌ 增值评价无法关联教师

---

### 2.2 建议简化方案 ✅

**不再要求填写教师UUID**，改为通过**教师姓名**自动匹配

#### 简化后的必填字段:
| 字段名 | Excel列名 | 类型 | 说明 |
|--------|-----------|------|------|
| class_name | 班级 | 文本 | 格式：高一1班 |
| teacher_name | 教师姓名 | 文本 | 如：张老师 |
| subject | 科目 | 文本 | 如：语文、数学 |

#### 可选字段:
| 字段名 | Excel列名 | 类型 | 说明 |
|--------|-----------|------|------|
| academic_year | 学年 | 文本 | 默认：当前学年 |
| semester | 学期 | 文本 | 默认：当前学期 |
| is_elective | 是否选课 | 布尔 | 默认：否 |

#### 删除的冗余字段:
- ❌ 学校名称（单校部署无需此字段）
- ❌ 学校代码（单校部署无需此字段）
- ❌ 班级代码（可由班级名称推导）
- ❌ 教师工号（改用姓名匹配，或后台配置）

---

### 2.3 教师姓名匹配逻辑

**导入时的处理流程**:
1. 根据`teacher_name`查询`teachers`表
2. 如果找到唯一匹配 → 使用该教师的UUID
3. 如果找到多个同名 → 提示用户选择
4. 如果找不到 → 提示用户先创建教师账号

**SQL查询示例**:
```sql
SELECT id FROM teachers WHERE name = '张老师' LIMIT 1;
```

---

## 三、数据验证规则

### 3.1 完整导入模式验证

```typescript
// 必需字段验证
if (!student_id || !name || !class_name) {
  throw Error("学号、姓名、班级不能为空");
}

// 班级格式验证
const classNameRegex = /^(高|初)[一二三][0-9]{1,2}班$/;
if (!classNameRegex.test(class_name)) {
  throw Error("班级格式错误，应为：高一1班、高二3班");
}

// 分数范围验证
if (score && (score < 0 || score > 150)) {
  throw Warning("分数超出常规范围 (0-150)");
}
```

### 3.2 仅成绩导入模式验证

```typescript
// 仅验证学号
if (!student_id) {
  throw Error("学号不能为空");
}

// 学号存在性检查
const student = await findStudentByIdOnly(student_id);
if (!student) {
  // 跳过该记录（不报错）
  skipRecord(student_id, "学号不存在于系统中");
}
```

### 3.3 增值计算的数据过滤

**过滤规则**: 记录必须同时满足
1. ✅ 有姓名（name不为空）
2. ✅ 至少有一门科目成绩

**过滤代码**:
```typescript
export function filterCompleteRecordsForValueAdded(records: any[]) {
  return records.filter(record => {
    // 1. 必须有姓名
    if (!record.name || record.name.trim() === '') return false;

    // 2. 必须有至少一门有效成绩
    const subjects = ['chinese', 'math', 'english', ...];
    const hasValidScore = subjects.some(subject => {
      const score = record[`${subject}_score`];
      return score != null && score !== '' && !isNaN(Number(score));
    });

    return hasValidScore;
  });
}
```

---

## 四、快速参考

### ✅ 推荐的Excel模板结构

#### 成绩导入（完整模式）:
```
学号 | 姓名 | 班级    | 语文 | 数学 | 英语 | 总分
001  | 张三 | 高一1班 | 85   | 92   | 78   | 255
002  | 李四 | 高一1班 | 78   | 85   | 92   | 255
```

#### 成绩导入（仅成绩模式）:
```
学号 | 语文 | 数学 | 英语 | 总分
001  | 85   | 92   | 78   | 255
002  | 78   | 85   | 92   | 255
```

#### 教师编排表:
```
班级    | 教师姓名 | 科目
高一1班 | 张老师   | 语文
高一1班 | 李老师   | 数学
高一2班 | 王老师   | 语文
```

---

## 五、常见错误和解决方案

| 错误提示 | 原因 | 解决方案 |
|----------|------|----------|
| "姓名不能为空（完整导入模式）" | Excel有姓名列但某行为空 | 补充姓名或使用仅成绩模式 |
| "班级格式错误" | 班级名称使用了括号或缺年级 | 改为：高一1班 |
| "学号不能为空" | 学号列为空 | 学号是唯一必填项 |
| "跳过N条记录（学号不存在）" | 仅成绩模式下学号不在系统中 | 先导入学生信息或检查学号 |
| "教师编排导入失败" | 教师UUID不匹配 | 使用简化方案，只填教师姓名 |

---

## 六、待修复的技术债务

### 🔧 需要立即修复:

1. **教师编排表的teacher_id字段**
   - 文件: `src/services/excelImportService.ts:parseTeachingArrangement()`
   - 问题: Excel的"教师工号"映射到UUID类型的teacher_id
   - 方案: 改为通过teacher_name查询teachers表获取UUID

2. **班级名称格式不统一**
   - 文件: 测试数据、示例代码
   - 问题: "高三(1)班" vs "高三1班"
   - 方案: 全局替换为统一格式

3. **字段映射配置可能为空**
   - 文件: `src/components/analysis/core/grade-importer/components/DataValidator.tsx`
   - 问题: mappingConfig.fieldMappings 为null时报错
   - 方案: 已修复（添加了防御性检查）

---

**文档版本**: v1.0
**更新日期**: 2025-01-30
**维护者**: Claude Code Assistant
