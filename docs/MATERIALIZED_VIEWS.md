# 物化视图使用和维护指南

## 概述

物化视图是数据库中的一种对象，它存储预计算的查询结果，可以显著提高复杂查询的性能。在我们的教学管理系统中，物化视图用于加速各种分析数据的查询，如班级统计、学科分析和趋势报告。

## 系统中的物化视图

本系统包含以下物化视图：

1. **class_statistics**：班级基本统计信息
   - 包含班级ID、名称、年级、学生数量、作业数量、平均分和优秀率

2. **mv_class_subject_stats**：班级学科统计
   - 按班级和学科分组的详细统计信息
   - 包括平均分、中位数、最高分、最低分、及格率和优秀率等

3. **mv_class_exam_trends**：班级考试趋势
   - 按班级、学科、考试类型和日期分组的考试成绩趋势
   - 用于绘制时间序列图表

4. **mv_class_subject_competency**：班级学科能力
   - 学生在特定知识点上的掌握程度
   - 用于生成知识点热力图

5. **mv_class_subject_correlation**：学科相关性
   - 不同学科成绩之间的相关系数
   - 用于分析学科之间的关联性

## 维护方法

### 手动刷新

1. **通过管理界面**：
   - 访问系统设置 > 数据维护 > 物化视图状态
   - 点击"刷新所有物化视图"按钮
   - 注意：此操作需要管理员权限

2. **通过SQL**：
   ```sql
   -- 刷新单个物化视图
   REFRESH MATERIALIZED VIEW class_statistics;
   
   -- 或调用批量刷新存储过程
   CALL refresh_all_materialized_views();
   ```

### 自动刷新策略

系统配置了以下自动刷新机制：

1. **触发器刷新**：
   - 当相关表的数据变更时（如grades、students、homework表有插入、更新或删除操作）
   - 触发器会自动刷新相应的物化视图

2. **定时刷新**：
   - 如果已启用pg_cron扩展，系统会在每天凌晨3点自动刷新所有物化视图
   - 此时间段通常是系统负载较低的时候

## 故障排查

如果发现性能问题或数据不一致，请检查：

1. **物化视图状态**：
   - 使用管理界面查看物化视图的状态和最后刷新时间
   - 如果物化视图不存在或长时间未刷新，请手动刷新

2. **降级机制**：
   - 系统已实现降级机制，即使物化视图不可用，也会通过原始查询获取数据
   - 但性能可能会受到影响

3. **常见错误**：
   - "物化视图不存在"：检查数据库迁移是否正确执行
   - "刷新失败"：检查数据库权限和资源使用情况

## 性能优化建议

1. **定期维护**：
   - 在用户活跃度低的时间段刷新物化视图
   - 定期运行VACUUM和ANALYZE命令优化物化视图

2. **索引优化**：
   - 系统已为物化视图创建了基本索引
   - 如果有特定查询模式，可以添加额外的索引

3. **刷新策略优化**：
   - 对于数据变更不频繁的视图，可以减少刷新频率
   - 对于关键数据，可以增加刷新频率

## 注意事项

1. 刷新物化视图可能是资源密集型操作，在系统负载高峰期应避免手动刷新
2. 物化视图占用额外存储空间，请确保数据库有足够空间
3. 当表结构变更时，可能需要重建物化视图

---

如有任何问题，请联系系统管理员或开发团队。 