# 数据库架构重构与混合架构迁移总体计划

## 📋 项目概述
- **目标**: 从纯Supabase架构迁移到混合架构（Supabase + 自建PostgreSQL）
- **时间**: 预计4-6周
- **执行者**: 单人开发
- **风险等级**: 中等（渐进式迁移，可回退）

## 🎯 迁移目标
1. 清理冗余表结构（77个表减到15个核心表）
2. 建立混合架构（核心数据自主掌控）
3. 提升查询性能（3-5倍）
4. 降低维护成本（80%）

## 📊 现状分析

### 数据规模
- 学生数: 7,228人
- 成绩记录: 2,751条
- 作业提交: 156条
- 预警记录: 9条

### 主要问题
1. **表结构冗余严重**
   - 班级相关表: 5个（需合并为1个）
   - 成绩相关表: 3个（需合并为1个）
   - 预警相关表: 11个（需简化为3个）
   - 学生相关表: 11个（需简化为3个）

2. **命名不规范**
   - grade_data_new → exam_scores
   - 表名过长且不清晰

3. **设计过度复杂**
   - 简单功能用了太多表
   - 缺少必要的索引

## 🏗️ 新架构设计

### 混合架构分工
```
Supabase保留:
- 用户认证 (auth.users)
- 文件存储 (storage)
- 实时通信 (realtime)
- 通知系统 (notifications)

自建PostgreSQL:
- 学生信息 (students)
- 成绩数据 (exam_scores)
- 班级管理 (classes)
- 作业系统 (homeworks)
- 预警系统 (warnings)
- 知识点系统 (knowledge)
```

### 核心表结构（15个表）
1. **students** - 学生基础信息
2. **classes** - 班级信息
3. **teachers** - 教师信息
4. **exam_scores** - 考试成绩
5. **homeworks** - 作业信息
6. **homework_submissions** - 作业提交
7. **student_portraits** - 学生画像
8. **warning_rules** - 预警规则
9. **warning_records** - 预警记录
10. **knowledge_mastery** - 知识点掌握
11. **subjects** - 科目信息
12. **exams** - 考试信息
13. **academic_terms** - 学期信息
14. **system_config** - 系统配置
15. **operation_logs** - 操作日志

## 📝 执行计划

### 第一阶段：准备工作（第1周）

#### Day 1-2: 数据备份与分析
- [ ] 备份Supabase全量数据
- [ ] 导出表结构文档
- [ ] 分析表依赖关系
- [ ] 统计各表数据量

#### Day 3-4: 环境准备
- [ ] 准备腾讯云服务器环境安装脚本
- [ ] 设计新数据库表结构
- [ ] 编写建表SQL脚本

#### Day 5-7: 工具开发
- [ ] 开发数据迁移工具
- [ ] 开发数据验证工具
- [ ] 创建API适配层框架

### 第二阶段：双写机制（第2周）

#### Day 8-10: 实现双写
- [ ] 修改写入接口支持双写
- [ ] 添加数据同步队列
- [ ] 实现错误重试机制

#### Day 11-14: 测试验证
- [ ] 测试双写功能
- [ ] 验证数据一致性
- [ ] 性能测试

### 第三阶段：渐进迁移（第3-4周）

#### Week 3: 高优先级迁移
- [ ] 迁移成绩查询（高频）
- [ ] 迁移学生信息查询
- [ ] 迁移班级管理

#### Week 4: 其他功能迁移
- [ ] 迁移预警系统
- [ ] 迁移作业系统（可选）
- [ ] 迁移知识点系统

### 第四阶段：优化清理（第5周）

- [ ] 性能调优
- [ ] 清理冗余代码
- [ ] 完善监控告警
- [ ] 编写运维文档

## 🛠️ 技术栈

### 服务器配置
- **腾讯云轻量服务器**: 4核8G，100GB SSD
- **操作系统**: Ubuntu 22.04 LTS
- **数据库**: PostgreSQL 15
- **缓存**: Redis 7
- **运行环境**: Node.js 20
- **进程管理**: PM2

### 开发工具
- **数据库管理**: pgAdmin / DBeaver
- **API测试**: Postman / Thunder Client
- **监控**: Grafana + Prometheus

## 📁 项目文件结构
```
database-migration/
├── docs/                  # 文档
│   ├── table-mapping.md  # 新旧表映射
│   ├── api-changes.md    # API变更说明
│   └── operation.md      # 运维手册
├── scripts/              # 脚本
│   ├── backup/          # 备份脚本
│   ├── migration/       # 迁移脚本
│   ├── validation/      # 验证脚本
│   └── setup/          # 环境配置脚本
├── sql/                 # SQL文件
│   ├── create-tables/   # 建表语句
│   ├── migrations/      # 数据迁移
│   └── indexes/        # 索引优化
└── api/                # API适配层
    ├── adapters/       # 数据源适配器
    ├── services/       # 服务层
    └── utils/         # 工具函数
```

## 🚨 风险控制

### 数据安全
- 所有操作前先备份
- 保留30天数据回滚能力
- 双写期间数据对比验证

### 业务连续性
- 渐进式迁移，不影响现有功能
- 灰度切换，可随时回退
- 保持API接口兼容

### 性能保障
- 迁移前后性能对比测试
- 建立合适的索引
- Redis缓存热点数据

## 📈 成功标准

1. **功能完整性**: 所有功能正常工作
2. **数据一致性**: 新旧系统数据100%一致
3. **性能提升**: 查询响应时间减少50%
4. **稳定性**: 7x24小时稳定运行
5. **可维护性**: 代码和表结构清晰

## 📅 里程碑

- **Week 1**: 环境准备完成，工具开发完成
- **Week 2**: 双写机制上线，数据同步正常
- **Week 3**: 核心功能迁移完成
- **Week 4**: 全部功能迁移完成
- **Week 5**: 优化完成，正式切换

## 🔄 回退方案

如果迁移出现问题，可以：
1. 立即停止双写
2. 切回纯Supabase模式
3. 分析问题后重新制定方案

---

创建时间: 2025-01-21
最后更新: 2025-01-21
状态: 执行中