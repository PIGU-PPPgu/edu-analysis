# å¢å€¼è¯„ä»·ç³»ç»Ÿ - æ•°æ®åº“è¿ç§»æ–¹æ¡ˆ

## ğŸ“Š ç°çŠ¶åˆ†æ

### âœ… å·²æœ‰æ•°æ®è¡¨
- `students` - å­¦ç”ŸåŸºç¡€ä¿¡æ¯
- `teachers` - æ•™å¸ˆä¿¡æ¯
- `class_info` - ç­çº§ä¿¡æ¯
- `subjects` - ç§‘ç›®ç®¡ç†
- `course_classes` - è¯¾ç¨‹-ç­çº§-æ•™å¸ˆå…³è”
- `grade_data` - ç»¼åˆæˆç»©è¡¨ï¼ˆå…³é”®ï¼ï¼‰

### âŒ ç¼ºå¤±å…³é”®æ•°æ®
1. **æ•™å¸ˆ-å­¦ç”Ÿ-ç§‘ç›®æ•™å­¦å…³ç³»** - å“ªä¸ªè€å¸ˆæ•™å“ªä¸ªå­¦ç”Ÿçš„å“ªé—¨è¯¾
2. **å¢å€¼æ´»åŠ¨ç®¡ç†** - å…¥å£è€ƒè¯•ã€å‡ºå£è€ƒè¯•é…ç½®
3. **ç­‰çº§åˆ’åˆ†é…ç½®** - A+/A/B+/B/C+/Cçš„ç™¾åˆ†ä½å®šä¹‰
4. **è®¡ç®—ç»“æœç¼“å­˜** - é¿å…é‡å¤è®¡ç®—

---

## ğŸ”§ æ•°æ®åº“è¿ç§»

### è¿ç§» 1: æ•™å¸ˆ-å­¦ç”Ÿ-ç§‘ç›®å…³è”è¡¨

**ç”¨é€”**: è®°å½•æ•™å­¦å…³ç³»ï¼Œæ”¯æŒ"è°æ•™è°"çš„æŸ¥è¯¢

```sql
-- æ•™å¸ˆ-å­¦ç”Ÿ-ç§‘ç›®æ•™å­¦å…³ç³»è¡¨
CREATE TABLE teacher_student_subjects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- æ•™å¸ˆ
  teacher_id UUID NOT NULL REFERENCES teachers(id) ON DELETE CASCADE,
  teacher_name TEXT NOT NULL,

  -- å­¦ç”Ÿ
  student_id TEXT NOT NULL REFERENCES students(student_id) ON DELETE CASCADE,
  student_name TEXT NOT NULL,

  -- ç§‘ç›®
  subject TEXT NOT NULL,

  -- ç­çº§ä¿¡æ¯ï¼ˆå¯èƒ½æ˜¯æ•™å­¦ç­ï¼Œå¯èƒ½æ˜¯è¡Œæ”¿ç­ï¼‰
  class_name TEXT NOT NULL,
  class_type TEXT DEFAULT 'administrative' CHECK (class_type IN ('administrative', 'teaching')),

  -- å­¦å¹´å­¦æœŸ
  academic_year TEXT NOT NULL,
  semester TEXT NOT NULL,

  -- æ˜¯å¦èµ°ç­
  is_elective BOOLEAN DEFAULT false,

  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- ç¡®ä¿åŒä¸€å­¦æœŸå†…ï¼ŒåŒä¸€ä¸ªå­¦ç”Ÿçš„åŒä¸€ç§‘ç›®åªæœ‰ä¸€ä¸ªæ•™å¸ˆ
  UNIQUE(student_id, subject, academic_year, semester)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_tss_teacher ON teacher_student_subjects(teacher_id);
CREATE INDEX idx_tss_student ON teacher_student_subjects(student_id);
CREATE INDEX idx_tss_subject ON teacher_student_subjects(subject);
CREATE INDEX idx_tss_class ON teacher_student_subjects(class_name);
CREATE INDEX idx_tss_year_semester ON teacher_student_subjects(academic_year, semester);

-- RLSç­–ç•¥
ALTER TABLE teacher_student_subjects ENABLE ROW LEVEL SECURITY;

-- æ•™å¸ˆåªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•™å­¦å…³ç³»
CREATE POLICY "æ•™å¸ˆæŸ¥çœ‹è‡ªå·±çš„æ•™å­¦å…³ç³»" ON teacher_student_subjects
  FOR SELECT USING (
    teacher_id = auth.uid()
    OR EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role IN ('admin', 'grade_leader'))
  );
```

---

### è¿ç§» 2: å¢å€¼æ´»åŠ¨ç®¡ç†è¡¨

**ç”¨é€”**: ç®¡ç†å¢å€¼åˆ†ææ´»åŠ¨ï¼ˆå…¥å£è€ƒè¯•â†’å‡ºå£è€ƒè¯•ï¼‰

```sql
-- å¢å€¼æ´»åŠ¨è¡¨
CREATE TABLE value_added_activities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,

  -- å…¥å£å’Œå‡ºå£è€ƒè¯•
  entry_exam_id TEXT NOT NULL,
  entry_exam_title TEXT NOT NULL,
  exit_exam_id TEXT NOT NULL,
  exit_exam_title TEXT NOT NULL,

  -- èŒƒå›´è®¾å®š
  grade_level TEXT NOT NULL,  -- å­¦æ®µï¼šåˆä¸­ã€é«˜ä¸­
  student_year TEXT NOT NULL, -- å­¦çº§ï¼š2025çº§
  academic_year TEXT NOT NULL, -- å­¦å¹´ï¼š2025-2026
  semester TEXT NOT NULL,      -- å­¦æœŸï¼šä¸Šå­¦æœŸ

  -- çŠ¶æ€ç®¡ç†
  status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'analyzing', 'completed', 'failed')),
  error_message TEXT,

  -- é…ç½®å‚æ•°
  grade_level_config_id UUID REFERENCES grade_levels_config(id),

  -- å…ƒæ•°æ®
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  completed_at TIMESTAMPTZ,
  updated_at TIMESTAMPTZ DEFAULT now(),

  -- ç¡®ä¿åŒä¸€å¯¹è€ƒè¯•åªæœ‰ä¸€ä¸ªæ´»åŠ¨
  UNIQUE(entry_exam_id, exit_exam_id, student_year)
);

-- ç´¢å¼•
CREATE INDEX idx_vaa_status ON value_added_activities(status);
CREATE INDEX idx_vaa_year_semester ON value_added_activities(academic_year, semester);
CREATE INDEX idx_vaa_grade_level ON value_added_activities(grade_level, student_year);

-- RLSç­–ç•¥
ALTER TABLE value_added_activities ENABLE ROW LEVEL SECURITY;

CREATE POLICY "æ‰€æœ‰äººå¯æŸ¥çœ‹å¢å€¼æ´»åŠ¨" ON value_added_activities
  FOR SELECT USING (true);

CREATE POLICY "ç®¡ç†å‘˜å¯ç®¡ç†å¢å€¼æ´»åŠ¨" ON value_added_activities
  FOR ALL USING (
    EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role IN ('admin', 'grade_leader'))
  );
```

---

### è¿ç§» 3: ç­‰çº§åˆ’åˆ†é…ç½®è¡¨

**ç”¨é€”**: å®šä¹‰A+/A/B+/B/C+/Cç­‰çº§çš„ç™¾åˆ†ä½æ ‡å‡†

```sql
-- ç­‰çº§åˆ’åˆ†é…ç½®è¡¨
CREATE TABLE grade_levels_config (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,

  -- æ˜¯å¦ä¸ºé»˜è®¤é…ç½®
  is_default BOOLEAN DEFAULT false,

  -- ç­‰çº§å®šä¹‰ï¼ˆJSONBæ•°ç»„ï¼‰
  levels JSONB NOT NULL DEFAULT '[
    {
      "level": "A+",
      "label": "ä¼˜ç§€+",
      "percentile": { "min": 0.00, "max": 0.05 },
      "color": "#10b981",
      "description": "å‰5%"
    },
    {
      "level": "A",
      "label": "ä¼˜ç§€",
      "percentile": { "min": 0.05, "max": 0.25 },
      "color": "#22c55e",
      "description": "5%è‡³25%"
    },
    {
      "level": "B+",
      "label": "è‰¯å¥½+",
      "percentile": { "min": 0.25, "max": 0.50 },
      "color": "#3b82f6",
      "description": "25%è‡³50%"
    },
    {
      "level": "B",
      "label": "è‰¯å¥½",
      "percentile": { "min": 0.50, "max": 0.75 },
      "color": "#6366f1",
      "description": "50%è‡³75%"
    },
    {
      "level": "C+",
      "label": "åŠæ ¼+",
      "percentile": { "min": 0.75, "max": 0.95 },
      "color": "#f59e0b",
      "description": "75%è‡³95%"
    },
    {
      "level": "C",
      "label": "åŠæ ¼",
      "percentile": { "min": 0.95, "max": 1.00 },
      "color": "#ef4444",
      "description": "95%è‡³100%"
    }
  ]'::jsonb,

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ç´¢å¼•
CREATE INDEX idx_glc_default ON grade_levels_config(is_default) WHERE is_default = true;

-- RLSç­–ç•¥
ALTER TABLE grade_levels_config ENABLE ROW LEVEL SECURITY;

CREATE POLICY "æ‰€æœ‰äººå¯æŸ¥çœ‹ç­‰çº§é…ç½®" ON grade_levels_config
  FOR SELECT USING (true);

CREATE POLICY "ç®¡ç†å‘˜å¯ç®¡ç†ç­‰çº§é…ç½®" ON grade_levels_config
  FOR ALL USING (
    EXISTS (SELECT 1 FROM user_roles WHERE user_id = auth.uid() AND role = 'admin')
  );

-- æ’å…¥é»˜è®¤é…ç½®
INSERT INTO grade_levels_config (name, description, is_default)
VALUES (
  'æ ‡å‡†å…­çº§é…ç½®',
  'A+ï¼ˆå‰5%ï¼‰ã€Aï¼ˆ5%-25%ï¼‰ã€B+ï¼ˆ25%-50%ï¼‰ã€Bï¼ˆ50%-75%ï¼‰ã€C+ï¼ˆ75%-95%ï¼‰ã€Cï¼ˆ95%-100%ï¼‰',
  true
);
```

---

### è¿ç§» 4: è®¡ç®—ç»“æœç¼“å­˜è¡¨

**ç”¨é€”**: ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—

```sql
-- å¢å€¼è®¡ç®—ç»“æœç¼“å­˜è¡¨
CREATE TABLE value_added_cache (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- å…³è”çš„æ´»åŠ¨
  activity_id UUID NOT NULL REFERENCES value_added_activities(id) ON DELETE CASCADE,

  -- æŠ¥å‘Šç±»å‹å’Œç»´åº¦
  report_type TEXT NOT NULL, -- 'teacher_score', 'teacher_ability', 'class_score', 'class_ability', 'subject_balance', 'student_detail'
  dimension TEXT NOT NULL,   -- 'teacher', 'class', 'student', 'subject'

  -- ç›®æ ‡IDï¼ˆæ•™å¸ˆIDã€ç­çº§åã€å­¦ç”ŸIDã€ç§‘ç›®åï¼‰
  target_id TEXT NOT NULL,
  target_name TEXT,

  -- è®¡ç®—ç»“æœï¼ˆJSONBï¼‰
  result JSONB NOT NULL,

  -- ç¼“å­˜ç®¡ç†
  created_at TIMESTAMPTZ DEFAULT now(),
  expires_at TIMESTAMPTZ DEFAULT (now() + INTERVAL '7 days'),

  -- ç¡®ä¿åŒä¸€æ´»åŠ¨çš„åŒä¸€æŠ¥å‘Šç±»å‹åªæœ‰ä¸€æ¡è®°å½•
  UNIQUE(activity_id, report_type, dimension, target_id)
);

-- ç´¢å¼•
CREATE INDEX idx_vac_activity ON value_added_cache(activity_id);
CREATE INDEX idx_vac_expires ON value_added_cache(expires_at);
CREATE INDEX idx_vac_type_dimension ON value_added_cache(report_type, dimension);

-- RLSç­–ç•¥
ALTER TABLE value_added_cache ENABLE ROW LEVEL SECURITY;

CREATE POLICY "ç¼“å­˜è·Ÿéšæ´»åŠ¨æƒé™" ON value_added_cache
  FOR SELECT USING (true);

-- å®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜çš„å‡½æ•°
CREATE OR REPLACE FUNCTION clean_expired_cache()
RETURNS void AS $$
BEGIN
  DELETE FROM value_added_cache WHERE expires_at < now();
END;
$$ LANGUAGE plpgsql;
```

---

### è¿ç§» 5: è€ƒè¯•åºåˆ—è¡¨ï¼ˆç”¨äºå†æ¬¡è¿½è¸ªï¼‰

**ç”¨é€”**: å®šä¹‰å¤šæ¬¡è€ƒè¯•çš„æ—¶é—´åºåˆ—å…³ç³»

```sql
-- è€ƒè¯•åºåˆ—è¡¨
CREATE TABLE exam_series (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,

  -- èŒƒå›´
  grade_level TEXT NOT NULL,
  student_year TEXT NOT NULL,
  academic_year TEXT NOT NULL,

  -- è€ƒè¯•åˆ—è¡¨ï¼ˆJSONBæ•°ç»„ï¼‰
  exams JSONB NOT NULL DEFAULT '[]'::jsonb,
  -- ç¤ºä¾‹: [
  --   { "examId": "exam1", "examTitle": "å¼€å­¦è€ƒ", "examDate": "2025-09-01", "sequence": 1 },
  --   { "examId": "exam2", "examTitle": "æœŸä¸­è€ƒ", "examDate": "2025-11-15", "sequence": 2 }
  -- ]

  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ç´¢å¼•
CREATE INDEX idx_es_grade_year ON exam_series(grade_level, student_year, academic_year);

-- RLSç­–ç•¥
ALTER TABLE exam_series ENABLE ROW LEVEL SECURITY;

CREATE POLICY "æ‰€æœ‰äººå¯æŸ¥çœ‹è€ƒè¯•åºåˆ—" ON exam_series
  FOR SELECT USING (true);
```

---

## ğŸ”§ è¾…åŠ©å‡½æ•°

### å‡½æ•°1: æ ¹æ®ç™¾åˆ†ä½åˆ¤å®šç­‰çº§

```sql
CREATE OR REPLACE FUNCTION determine_grade_level(
  score NUMERIC,
  all_scores NUMERIC[],
  config_id UUID DEFAULT NULL
)
RETURNS TEXT AS $$
DECLARE
  percentile NUMERIC;
  config JSONB;
  level_item JSONB;
BEGIN
  -- è·å–é…ç½®
  IF config_id IS NULL THEN
    SELECT levels INTO config
    FROM grade_levels_config
    WHERE is_default = true
    LIMIT 1;
  ELSE
    SELECT levels INTO config
    FROM grade_levels_config
    WHERE id = config_id;
  END IF;

  -- è®¡ç®—ç™¾åˆ†ä½ï¼ˆæ’å / æ€»äººæ•°ï¼‰
  WITH ranked AS (
    SELECT score AS s,
           ROW_NUMBER() OVER (ORDER BY score DESC) AS rank
    FROM unnest(all_scores) AS score
  )
  SELECT (rank::NUMERIC - 1) / (SELECT COUNT(*) FROM unnest(all_scores))
  INTO percentile
  FROM ranked
  WHERE s = score;

  -- åˆ¤å®šç­‰çº§
  FOR level_item IN SELECT * FROM jsonb_array_elements(config)
  LOOP
    IF percentile >= (level_item->>'percentile.min')::NUMERIC
       AND percentile < (level_item->>'percentile.max')::NUMERIC THEN
      RETURN level_item->>'level';
    END IF;
  END LOOP;

  -- é»˜è®¤è¿”å›æœ€ä½ç­‰çº§
  RETURN 'C';
END;
$$ LANGUAGE plpgsql IMMUTABLE;
```

---

## ğŸ“‹ æ•°æ®å‡†å¤‡æ£€æŸ¥æ¸…å•

### 1. ç°æœ‰æ•°æ®éªŒè¯

```sql
-- æ£€æŸ¥1: æ˜¯å¦æœ‰è‡³å°‘2æ¬¡è€ƒè¯•æ•°æ®
SELECT exam_id, exam_title, COUNT(DISTINCT student_id) as student_count
FROM grade_data
GROUP BY exam_id, exam_title
ORDER BY exam_id;

-- æ£€æŸ¥2: æ˜¯å¦æœ‰ç­çº§ä¿¡æ¯
SELECT class_name, COUNT(DISTINCT student_id) as student_count
FROM grade_data
GROUP BY class_name
ORDER BY class_name;

-- æ£€æŸ¥3: æ˜¯å¦æœ‰ç§‘ç›®åˆ†æ•°
SELECT
  COUNT(CASE WHEN chinese_score IS NOT NULL THEN 1 END) as has_chinese,
  COUNT(CASE WHEN math_score IS NOT NULL THEN 1 END) as has_math,
  COUNT(CASE WHEN english_score IS NOT NULL THEN 1 END) as has_english
FROM grade_data;
```

### 2. éœ€è¦è¡¥å……çš„æ•°æ®

#### 2.1 æ•™å¸ˆ-å­¦ç”Ÿ-ç§‘ç›®å…³è”æ•°æ®

**æ–¹æ³•A: ä»course_classesåæ¨**
```sql
-- å¦‚æœcourse_classesè¡¨æœ‰æ•°æ®ï¼Œå¯ä»¥æ‰¹é‡ç”Ÿæˆ
INSERT INTO teacher_student_subjects (
  teacher_id,
  teacher_name,
  student_id,
  student_name,
  subject,
  class_name,
  class_type,
  academic_year,
  semester
)
SELECT
  cc.teacher_id,
  t.name as teacher_name,
  s.student_id,
  s.name as student_name,
  cc.subject_code as subject,
  s.class_name,
  'administrative' as class_type,
  '2025-2026' as academic_year,
  'ä¸Šå­¦æœŸ' as semester
FROM course_classes cc
JOIN teachers t ON t.id = cc.teacher_id
JOIN students s ON s.class_name = cc.class_name
WHERE cc.term_id IN (SELECT id FROM academic_terms WHERE is_current = true);
```

**æ–¹æ³•B: æ‰‹åŠ¨å¯¼å…¥CSV**
```csv
teacher_id,teacher_name,student_id,student_name,subject,class_name,academic_year,semester
uuid1,å¼ è€å¸ˆ,20250001,ç‹å°æ˜,æ•°å­¦,01ç­,2025-2026,ä¸Šå­¦æœŸ
uuid1,å¼ è€å¸ˆ,20250002,æå°çº¢,æ•°å­¦,01ç­,2025-2026,ä¸Šå­¦æœŸ
```

#### 2.2 åˆ›å»ºå¢å€¼æ´»åŠ¨

```sql
-- ç¤ºä¾‹ï¼šåˆ›å»ºä¸€ä¸ªå¢å€¼æ´»åŠ¨
INSERT INTO value_added_activities (
  name,
  entry_exam_id,
  entry_exam_title,
  exit_exam_id,
  exit_exam_title,
  grade_level,
  student_year,
  academic_year,
  semester,
  created_by
)
VALUES (
  '2025çº§åˆä¸­ å¼€å­¦è€ƒâ†’æœŸä¸­è€ƒ å¢å€¼åˆ†æ',
  'entry_exam_001',
  'å¼€å­¦è€ƒ',
  'exit_exam_001',
  'æœŸä¸­è€ƒ',
  'åˆä¸­',
  '2025çº§',
  '2025-2026',
  'ä¸Šå­¦æœŸ',
  (SELECT id FROM auth.users WHERE email = 'admin@school.com')
);
```

---

## ğŸš€ æ‰§è¡Œæ­¥éª¤

### æ­¥éª¤1: åˆ›å»ºæ‰€æœ‰æ–°è¡¨ï¼ˆ5åˆ†é’Ÿï¼‰
```bash
# è¿æ¥Supabaseæ•°æ®åº“
# ä¾æ¬¡æ‰§è¡Œä¸Šè¿°5ä¸ªè¿ç§»SQL
```

### æ­¥éª¤2: æ•°æ®éªŒè¯ï¼ˆ5åˆ†é’Ÿï¼‰
```sql
-- è¿è¡Œæ£€æŸ¥SQLï¼Œç¡®è®¤ç°æœ‰æ•°æ®è´¨é‡
```

### æ­¥éª¤3: è¡¥å……æ•™å¸ˆ-å­¦ç”Ÿå…³è”ï¼ˆ30åˆ†é’Ÿï¼‰
```sql
-- æ ¹æ®å®é™…æƒ…å†µï¼Œé€‰æ‹©æ–¹æ³•Aæˆ–æ–¹æ³•B
-- ç¡®ä¿æ¯ä¸ªå­¦ç”Ÿçš„æ¯é—¨è¯¾éƒ½æœ‰å¯¹åº”çš„æ•™å¸ˆ
```

### æ­¥éª¤4: åˆ›å»ºæµ‹è¯•å¢å€¼æ´»åŠ¨ï¼ˆ5åˆ†é’Ÿï¼‰
```sql
-- åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ´»åŠ¨ï¼Œç”¨äºåç»­å¼€å‘
```

### æ­¥éª¤5: éªŒè¯æ•°æ®å®Œæ•´æ€§ï¼ˆ10åˆ†é’Ÿï¼‰
```sql
-- æ£€æŸ¥æ‰€æœ‰å¿…è¦æ•°æ®éƒ½å·²å°±ç»ª
SELECT
  'students' as table_name, COUNT(*) as count FROM students
UNION ALL
SELECT 'teachers', COUNT(*) FROM teachers
UNION ALL
SELECT 'grade_data', COUNT(*) FROM grade_data
UNION ALL
SELECT 'teacher_student_subjects', COUNT(*) FROM teacher_student_subjects
UNION ALL
SELECT 'value_added_activities', COUNT(*) FROM value_added_activities;
```

---

## âœ… å®Œæˆæ ‡å‡†

æ•°æ®å‡†å¤‡å®Œæˆçš„æ ‡å¿—ï¼š
- [ ] 5å¼ æ–°è¡¨åˆ›å»ºæˆåŠŸ
- [ ] æœ‰è‡³å°‘2æ¬¡è€ƒè¯•çš„æˆç»©æ•°æ®
- [ ] æœ‰æ•™å¸ˆ-å­¦ç”Ÿ-ç§‘ç›®çš„å®Œæ•´å…³è”
- [ ] æœ‰è‡³å°‘1ä¸ªå¢å€¼æ´»åŠ¨è®°å½•
- [ ] ç­‰çº§é…ç½®è¡¨æœ‰é»˜è®¤é…ç½®
- [ ] æ‰€æœ‰ç´¢å¼•å’ŒRLSç­–ç•¥å°±ç»ª

**å®Œæˆåï¼Œå³å¯å¼€å§‹TypeScriptç±»å‹å®šä¹‰å’Œè®¡ç®—é€»è¾‘å¼€å‘ï¼**
