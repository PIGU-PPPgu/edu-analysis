<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æ•°æ®å¤„ç† Workflow æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            background-color: #f8fafc;
        }
        .result {
            background-color: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-color: #10b981; background-color: #f0fdf4; }
        .error { border-color: #ef4444; background-color: #fef2f2; }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #2563eb; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ™ºèƒ½æ•°æ®å¤„ç† Workflow æµ‹è¯•</h1>
        <p>æµ‹è¯•å®Œæ•´çš„ <strong>ä¸Šä¼ â†’è§£æâ†’ä¿å­˜â†’åˆ†æ</strong> æ™ºèƒ½å¤„ç†æµç¨‹</p>

        <div class="step">
            <h3>æ­¥éª¤1: æ™ºèƒ½æ–‡ä»¶è§£ææµ‹è¯•</h3>
            <button onclick="testStep1()" id="btn1">ğŸ§  æµ‹è¯•æ™ºèƒ½æ–‡ä»¶è§£æå™¨</button>
            <div id="result1" class="result" style="display:none;"></div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤2: ä¿å­˜è€ƒè¯•æ•°æ®æµ‹è¯•</h3>
            <button onclick="testStep2()" id="btn2" disabled>ğŸ’¾ æµ‹è¯•ä¿å­˜è€ƒè¯•æ•°æ®</button>
            <div id="result2" class="result" style="display:none;"></div>
        </div>

        <div class="step">
            <h3>æ­¥éª¤3: AIæˆç»©åˆ†ææµ‹è¯•</h3>
            <button onclick="testStep3()" id="btn3" disabled>ğŸ¤– æµ‹è¯•AIæˆç»©åˆ†æ</button>
            <div id="result3" class="result" style="display:none;"></div>
        </div>

        <div class="step">
            <h3>å®Œæ•´æµç¨‹æµ‹è¯•</h3>
            <button onclick="testCompleteWorkflow()" id="btnComplete">ğŸ¯ è¿è¡Œå®Œæ•´workflowæµ‹è¯•</button>
            <div id="resultComplete" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://giluhqotfjpmofowvogn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpbHVocW90ZmpwbW9mb3d2b2duIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMDIwMDQsImV4cCI6MjA2MDg3ODAwNH0.NkVIqDlRM-qh8HoFR-nZMfXKWT0lDMeNSk5EPJiprZQ';

        // æµ‹è¯•æ•°æ®
        const testData = [
            {
                'å­¦å·': '2024001',
                'å§“å': 'å¼ ä¸‰',
                'ç­çº§': 'é«˜ä¸€(1)ç­',
                'è¯­æ–‡': '85',
                'æ•°å­¦': '92',
                'è‹±è¯­': '78',
                'ç‰©ç†': '88',
                'åŒ–å­¦': '90',
                'æ€»åˆ†': '433'
            },
            {
                'å­¦å·': '2024002',
                'å§“å': 'æå››',
                'ç­çº§': 'é«˜ä¸€(1)ç­',
                'è¯­æ–‡': '78',
                'æ•°å­¦': '85',
                'è‹±è¯­': '82',
                'ç‰©ç†': '76',
                'åŒ–å­¦': '81',
                'æ€»åˆ†': '402'
            },
            {
                'å­¦å·': '2024003',
                'å§“å': 'ç‹äº”',
                'ç­çº§': 'é«˜ä¸€(1)ç­',
                'è¯­æ–‡': '90',
                'æ•°å­¦': '88',
                'è‹±è¯­': '85',
                'ç‰©ç†': '92',
                'åŒ–å­¦': '87',
                'æ€»åˆ†': '442'
            }
        ];

        const testHeaders = ['å­¦å·', 'å§“å', 'ç­çº§', 'è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'æ€»åˆ†'];

        let globalParseResult = null;
        let globalSaveResult = null;

        function showLoading(buttonId) {
            const btn = document.getElementById(buttonId);
            btn.innerHTML = '<div class="loading"></div> å¤„ç†ä¸­...';
            btn.disabled = true;
        }

        function hideLoading(buttonId, text) {
            const btn = document.getElementById(buttonId);
            btn.innerHTML = text;
            btn.disabled = false;
        }

        function showResult(resultId, content, isSuccess = true) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            resultDiv.className = 'result ' + (isSuccess ? 'success' : 'error');
            resultDiv.textContent = content;
        }

        async function testStep1() {
            showLoading('btn1');
            const resultDiv = document.getElementById('result1');

            try {
                console.log('ğŸ§  æµ‹è¯•æ™ºèƒ½æ–‡ä»¶è§£æå™¨...');

                const response = await fetch(`${SUPABASE_URL}/functions/v1/intelligent-file-parser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        data: testData,
                        headers: testHeaders,
                        filename: 'é«˜ä¸€(1)ç­æœŸä¸­è€ƒè¯•æˆç»©.xlsx'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                globalParseResult = result;

                const summary = {
                    success: result.success,
                    detectedStructure: result.metadata?.detectedStructure,
                    confidence: result.metadata?.confidence,
                    totalRows: result.metadata?.totalRows,
                    detectedSubjects: result.metadata?.detectedSubjects,
                    examInfo: result.metadata?.examInfo
                };

                showResult('result1',
                    `âœ… æ™ºèƒ½æ–‡ä»¶è§£ææˆåŠŸ!\n\n` +
                    `ğŸ“Š è§£æç»“æœ:\n${JSON.stringify(summary, null, 2)}`,
                    true
                );

                // å¯ç”¨ä¸‹ä¸€æ­¥
                document.getElementById('btn2').disabled = false;

            } catch (error) {
                console.error('âŒ æ™ºèƒ½æ–‡ä»¶è§£æå¤±è´¥:', error);
                showResult('result1', `âŒ æ™ºèƒ½æ–‡ä»¶è§£æå¤±è´¥:\n${error.message}`, false);
            } finally {
                hideLoading('btn1', 'ğŸ§  æµ‹è¯•æ™ºèƒ½æ–‡ä»¶è§£æå™¨');
            }
        }

        async function testStep2() {
            if (!globalParseResult) {
                alert('è¯·å…ˆè¿è¡Œæ­¥éª¤1');
                return;
            }

            showLoading('btn2');

            try {
                console.log('ğŸ’¾ æµ‹è¯•ä¿å­˜è€ƒè¯•æ•°æ®...');

                const examInfo = globalParseResult.metadata.examInfo;

                const response = await fetch(`${SUPABASE_URL}/functions/v1/save-exam-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        records: globalParseResult.data,
                        examInfo: examInfo
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`ä¿å­˜æ•°æ®å¤±è´¥: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                globalSaveResult = result;

                const summary = {
                    success: result.success,
                    errors: result.errors?.length || 0,
                    message: result.message,
                    examId: result.examId
                };

                showResult('result2',
                    `âœ… ä¿å­˜è€ƒè¯•æ•°æ®æˆåŠŸ!\n\n` +
                    `ğŸ“ˆ ä¿å­˜ç»“æœ:\n${JSON.stringify(summary, null, 2)}`,
                    true
                );

                // å¯ç”¨ä¸‹ä¸€æ­¥
                document.getElementById('btn3').disabled = false;

            } catch (error) {
                console.error('âŒ ä¿å­˜è€ƒè¯•æ•°æ®å¤±è´¥:', error);
                showResult('result2', `âŒ ä¿å­˜è€ƒè¯•æ•°æ®å¤±è´¥:\n${error.message}`, false);
            } finally {
                hideLoading('btn2', 'ğŸ’¾ æµ‹è¯•ä¿å­˜è€ƒè¯•æ•°æ®');
            }
        }

        async function testStep3() {
            if (!globalSaveResult) {
                alert('è¯·å…ˆè¿è¡Œæ­¥éª¤1å’Œ2');
                return;
            }

            showLoading('btn3');

            try {
                console.log('ğŸ¤– æµ‹è¯•AIæˆç»©åˆ†æ...');

                const analysisRequest = {
                    exam_title: 'é«˜ä¸€(1)ç­æœŸä¸­è€ƒè¯•æˆç»©',
                    class_name: 'é«˜ä¸€(1)ç­',
                    analysis_type: 'detailed',
                    model: 'deepseek-chat',
                    grade_data: testData,
                    enabled_bots: []
                };

                const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-grades`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(analysisRequest)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`åˆ†æå¤±è´¥: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

                const summary = {
                    success: result.success,
                    analysisLength: result.data?.result?.length || 0,
                    analysisType: result.data?.analysis_type,
                    model: result.data?.model
                };

                let content = `âœ… AIåˆ†ææˆåŠŸ!\n\nğŸ“– åˆ†æç»“æœé¢„è§ˆ:\n${JSON.stringify(summary, null, 2)}`;

                if (result.data?.result) {
                    content += `\n\nğŸ“ åˆ†æå†…å®¹é¢„è§ˆ:\n${result.data.result.substring(0, 500)}...`;
                }

                showResult('result3', content, true);

            } catch (error) {
                console.error('âŒ AIåˆ†æå¤±è´¥:', error);
                showResult('result3', `âŒ AIåˆ†æå¤±è´¥:\n${error.message}`, false);
            } finally {
                hideLoading('btn3', 'ğŸ¤– æµ‹è¯•AIæˆç»©åˆ†æ');
            }
        }

        async function testCompleteWorkflow() {
            showLoading('btnComplete');

            try {
                const startTime = Date.now();
                showResult('resultComplete', 'ğŸš€ å¼€å§‹æµ‹è¯•å®Œæ•´workflow...\n', true);

                // é‡ç½®å…¨å±€å˜é‡
                globalParseResult = null;
                globalSaveResult = null;

                // æ­¥éª¤1
                await testStep1();
                if (!globalParseResult) throw new Error('æ­¥éª¤1å¤±è´¥');

                // æ­¥éª¤2
                await testStep2();
                if (!globalSaveResult) throw new Error('æ­¥éª¤2å¤±è´¥');

                // æ­¥éª¤3
                await testStep3();

                const duration = Date.now() - startTime;

                showResult('resultComplete',
                    `ğŸ‰ å®Œæ•´workflowæµ‹è¯•æˆåŠŸ!\n\n` +
                    `ğŸ“Š æœ€ç»ˆæ€»ç»“:\n` +
                    `âœ… æ–‡ä»¶è§£æ: æˆåŠŸ\n` +
                    `âœ… æ•°æ®ä¿å­˜: æˆåŠŸ\n` +
                    `âœ… AIåˆ†æ: æˆåŠŸ\n` +
                    `âœ… WorkflowçŠ¶æ€: å®Œå…¨æ­£å¸¸\n` +
                    `â±ï¸ æ€»è€—æ—¶: ${duration}ms\n\n` +
                    `ğŸ¯ ç»“è®º: æ™ºèƒ½æ•°æ®å¤„ç†ç³»ç»Ÿå·¥ä½œæ­£å¸¸ï¼Œæ”¯æŒ"å‡è´Ÿå¢æ•ˆ"ç›®æ ‡!`,
                    true
                );

            } catch (error) {
                console.error('âŒ Workflowæµ‹è¯•å¤±è´¥:', error);
                showResult('resultComplete', `âŒ Workflowæµ‹è¯•å¤±è´¥:\n${error.message}`, false);
            } finally {
                hideLoading('btnComplete', 'ğŸ¯ è¿è¡Œå®Œæ•´workflowæµ‹è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        console.log('ğŸš€ æ™ºèƒ½æ•°æ®å¤„ç† Workflow æµ‹è¯•é¡µé¢å·²åŠ è½½');
        console.log('ğŸ’¡ ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•å„ä¸ªæ­¥éª¤æˆ–å®Œæ•´æµç¨‹');
    </script>
</body>
</html>