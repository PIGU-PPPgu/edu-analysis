<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能数据处理 Workflow 测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            background-color: #f8fafc;
        }
        .result {
            background-color: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-color: #10b981; background-color: #f0fdf4; }
        .error { border-color: #ef4444; background-color: #fef2f2; }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #2563eb; }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 智能数据处理 Workflow 测试</h1>
        <p>测试完整的 <strong>上传→解析→保存→分析</strong> 智能处理流程</p>

        <div class="step">
            <h3>步骤1: 智能文件解析测试</h3>
            <button onclick="testStep1()" id="btn1">🧠 测试智能文件解析器</button>
            <div id="result1" class="result" style="display:none;"></div>
        </div>

        <div class="step">
            <h3>步骤2: 保存考试数据测试</h3>
            <button onclick="testStep2()" id="btn2" disabled>💾 测试保存考试数据</button>
            <div id="result2" class="result" style="display:none;"></div>
        </div>

        <div class="step">
            <h3>步骤3: AI成绩分析测试</h3>
            <button onclick="testStep3()" id="btn3" disabled>🤖 测试AI成绩分析</button>
            <div id="result3" class="result" style="display:none;"></div>
        </div>

        <div class="step">
            <h3>完整流程测试</h3>
            <button onclick="testCompleteWorkflow()" id="btnComplete">🎯 运行完整workflow测试</button>
            <div id="resultComplete" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://giluhqotfjpmofowvogn.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpbHVocW90ZmpwbW9mb3d2b2duIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUzMDIwMDQsImV4cCI6MjA2MDg3ODAwNH0.NkVIqDlRM-qh8HoFR-nZMfXKWT0lDMeNSk5EPJiprZQ';

        // 测试数据
        const testData = [
            {
                '学号': '2024001',
                '姓名': '张三',
                '班级': '高一(1)班',
                '语文': '85',
                '数学': '92',
                '英语': '78',
                '物理': '88',
                '化学': '90',
                '总分': '433'
            },
            {
                '学号': '2024002',
                '姓名': '李四',
                '班级': '高一(1)班',
                '语文': '78',
                '数学': '85',
                '英语': '82',
                '物理': '76',
                '化学': '81',
                '总分': '402'
            },
            {
                '学号': '2024003',
                '姓名': '王五',
                '班级': '高一(1)班',
                '语文': '90',
                '数学': '88',
                '英语': '85',
                '物理': '92',
                '化学': '87',
                '总分': '442'
            }
        ];

        const testHeaders = ['学号', '姓名', '班级', '语文', '数学', '英语', '物理', '化学', '总分'];

        let globalParseResult = null;
        let globalSaveResult = null;

        function showLoading(buttonId) {
            const btn = document.getElementById(buttonId);
            btn.innerHTML = '<div class="loading"></div> 处理中...';
            btn.disabled = true;
        }

        function hideLoading(buttonId, text) {
            const btn = document.getElementById(buttonId);
            btn.innerHTML = text;
            btn.disabled = false;
        }

        function showResult(resultId, content, isSuccess = true) {
            const resultDiv = document.getElementById(resultId);
            resultDiv.style.display = 'block';
            resultDiv.className = 'result ' + (isSuccess ? 'success' : 'error');
            resultDiv.textContent = content;
        }

        async function testStep1() {
            showLoading('btn1');
            const resultDiv = document.getElementById('result1');

            try {
                console.log('🧠 测试智能文件解析器...');

                const response = await fetch(`${SUPABASE_URL}/functions/v1/intelligent-file-parser`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        data: testData,
                        headers: testHeaders,
                        filename: '高一(1)班期中考试成绩.xlsx'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API调用失败: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                globalParseResult = result;

                const summary = {
                    success: result.success,
                    detectedStructure: result.metadata?.detectedStructure,
                    confidence: result.metadata?.confidence,
                    totalRows: result.metadata?.totalRows,
                    detectedSubjects: result.metadata?.detectedSubjects,
                    examInfo: result.metadata?.examInfo
                };

                showResult('result1',
                    `✅ 智能文件解析成功!\n\n` +
                    `📊 解析结果:\n${JSON.stringify(summary, null, 2)}`,
                    true
                );

                // 启用下一步
                document.getElementById('btn2').disabled = false;

            } catch (error) {
                console.error('❌ 智能文件解析失败:', error);
                showResult('result1', `❌ 智能文件解析失败:\n${error.message}`, false);
            } finally {
                hideLoading('btn1', '🧠 测试智能文件解析器');
            }
        }

        async function testStep2() {
            if (!globalParseResult) {
                alert('请先运行步骤1');
                return;
            }

            showLoading('btn2');

            try {
                console.log('💾 测试保存考试数据...');

                const examInfo = globalParseResult.metadata.examInfo;

                const response = await fetch(`${SUPABASE_URL}/functions/v1/save-exam-data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        records: globalParseResult.data,
                        examInfo: examInfo
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`保存数据失败: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                globalSaveResult = result;

                const summary = {
                    success: result.success,
                    errors: result.errors?.length || 0,
                    message: result.message,
                    examId: result.examId
                };

                showResult('result2',
                    `✅ 保存考试数据成功!\n\n` +
                    `📈 保存结果:\n${JSON.stringify(summary, null, 2)}`,
                    true
                );

                // 启用下一步
                document.getElementById('btn3').disabled = false;

            } catch (error) {
                console.error('❌ 保存考试数据失败:', error);
                showResult('result2', `❌ 保存考试数据失败:\n${error.message}`, false);
            } finally {
                hideLoading('btn2', '💾 测试保存考试数据');
            }
        }

        async function testStep3() {
            if (!globalSaveResult) {
                alert('请先运行步骤1和2');
                return;
            }

            showLoading('btn3');

            try {
                console.log('🤖 测试AI成绩分析...');

                const analysisRequest = {
                    exam_title: '高一(1)班期中考试成绩',
                    class_name: '高一(1)班',
                    analysis_type: 'detailed',
                    model: 'deepseek-chat',
                    grade_data: testData,
                    enabled_bots: []
                };

                const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-grades`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(analysisRequest)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`分析失败: ${response.status} - ${errorText}`);
                }

                const result = await response.json();

                const summary = {
                    success: result.success,
                    analysisLength: result.data?.result?.length || 0,
                    analysisType: result.data?.analysis_type,
                    model: result.data?.model
                };

                let content = `✅ AI分析成功!\n\n📖 分析结果预览:\n${JSON.stringify(summary, null, 2)}`;

                if (result.data?.result) {
                    content += `\n\n📝 分析内容预览:\n${result.data.result.substring(0, 500)}...`;
                }

                showResult('result3', content, true);

            } catch (error) {
                console.error('❌ AI分析失败:', error);
                showResult('result3', `❌ AI分析失败:\n${error.message}`, false);
            } finally {
                hideLoading('btn3', '🤖 测试AI成绩分析');
            }
        }

        async function testCompleteWorkflow() {
            showLoading('btnComplete');

            try {
                const startTime = Date.now();
                showResult('resultComplete', '🚀 开始测试完整workflow...\n', true);

                // 重置全局变量
                globalParseResult = null;
                globalSaveResult = null;

                // 步骤1
                await testStep1();
                if (!globalParseResult) throw new Error('步骤1失败');

                // 步骤2
                await testStep2();
                if (!globalSaveResult) throw new Error('步骤2失败');

                // 步骤3
                await testStep3();

                const duration = Date.now() - startTime;

                showResult('resultComplete',
                    `🎉 完整workflow测试成功!\n\n` +
                    `📊 最终总结:\n` +
                    `✅ 文件解析: 成功\n` +
                    `✅ 数据保存: 成功\n` +
                    `✅ AI分析: 成功\n` +
                    `✅ Workflow状态: 完全正常\n` +
                    `⏱️ 总耗时: ${duration}ms\n\n` +
                    `🎯 结论: 智能数据处理系统工作正常，支持"减负增效"目标!`,
                    true
                );

            } catch (error) {
                console.error('❌ Workflow测试失败:', error);
                showResult('resultComplete', `❌ Workflow测试失败:\n${error.message}`, false);
            } finally {
                hideLoading('btnComplete', '🎯 运行完整workflow测试');
            }
        }

        // 页面加载时的提示
        console.log('🚀 智能数据处理 Workflow 测试页面已加载');
        console.log('💡 点击按钮开始测试各个步骤或完整流程');
    </script>
</body>
</html>