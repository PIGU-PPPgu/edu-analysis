/**
 * ğŸ¤– AIæ–‡ä»¶è§£æåŠŸèƒ½æ¼”ç¤º
 * 
 * å±•ç¤ºå¦‚ä½•ä½¿ç”¨ä¼˜åŒ–çš„AIæç¤ºè¯æ¥è§£å†³é•¿è¡¨æ ¼vså®½è¡¨æ ¼è¯†åˆ«é—®é¢˜
 */

// æ¨¡æ‹Ÿæ–‡ä»¶æ•°æ® - å®½è¡¨æ ¼å¼ï¼ˆä½ ä¸Šä¼ çš„å…¨å¹´çº§æ•°æ®ï¼‰
const wideFormatExample = {
  filename: "907ä¹ä¸‹æœˆè€ƒæˆç»©.csv",
  headers: ["å­¦å·", "å§“å", "ç­çº§", "è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†", "åŒ–å­¦", "æ”¿æ²»", "å†å²", "æ€»åˆ†"],
  sampleRows: [
    ["108110907001", "å¼ ä¸‰", "åˆä¸‰7ç­", "85", "92", "78", "88", "90", "82", "86", "601"],
    ["108110907002", "æå››", "åˆä¸‰7ç­", "92", "88", "85", "90", "87", "89", "84", "615"],
    ["108110907003", "ç‹äº”", "åˆä¸‰8ç­", "78", "85", "92", "85", "89", "87", "90", "606"],
    ["108110907004", "èµµå…­", "åˆä¸‰8ç­", "88", "90", "87", "92", "85", "86", "88", "616"],
    ["108110907005", "é’±ä¸ƒ", "åˆä¸‰9ç­", "90", "87", "89", "85", "88", "91", "85", "615"]
  ],
  totalRows: 495  // å…¨å¹´çº§495ä¸ªå­¦ç”Ÿ
};

// æ¨¡æ‹Ÿæ–‡ä»¶æ•°æ® - é•¿è¡¨æ ¼å¼
const longFormatExample = {
  filename: "ä¹å¹´çº§æœŸä¸­è€ƒè¯•æˆç»©.csv",
  headers: ["å­¦å·", "å§“å", "ç­çº§", "ç§‘ç›®", "åˆ†æ•°", "ç­‰çº§", "ç­çº§æ’å"],
  sampleRows: [
    ["108110907001", "å¼ ä¸‰", "åˆä¸‰7ç­", "è¯­æ–‡", "85", "B+", "15"],
    ["108110907001", "å¼ ä¸‰", "åˆä¸‰7ç­", "æ•°å­¦", "92", "A", "8"],
    ["108110907001", "å¼ ä¸‰", "åˆä¸‰7ç­", "è‹±è¯­", "78", "B", "22"],
    ["108110907002", "æå››", "åˆä¸‰7ç­", "è¯­æ–‡", "92", "A", "5"],
    ["108110907002", "æå››", "åˆä¸‰7ç­", "æ•°å­¦", "88", "B+", "12"]
  ],
  totalRows: 3465  // 495å­¦ç”Ÿ Ã— 7ç§‘ç›® = 3465è¡Œ
};

/**
 * ğŸ¯ ä¼˜åŒ–çš„AIæç¤ºè¯ - ä¸“é—¨è§£å†³é•¿è¡¨æ ¼vså®½è¡¨æ ¼è¯†åˆ«é—®é¢˜
 */
function buildOptimizedPrompt(data) {
  const { filename, headers, sampleRows, totalRows } = data;
  
  return `
# ğŸ“ æ•™è‚²æ•°æ®æ™ºèƒ½åˆ†æä»»åŠ¡

ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ•™è‚²æ•°æ®åˆ†æä¸“å®¶ï¼Œæ“…é•¿è¯†åˆ«å„ç§æˆç»©æ•°æ®æ ¼å¼ã€‚è¯·ä»”ç»†åˆ†æä»¥ä¸‹å­¦ç”Ÿæˆç»©æ–‡ä»¶å¹¶æä¾›å®Œæ•´çš„è§£ææ–¹æ¡ˆã€‚

## ğŸ“ æ–‡ä»¶åŸºæœ¬ä¿¡æ¯
- **æ–‡ä»¶å**: ${filename}
- **æ•°æ®è§„æ¨¡**: ${totalRows} è¡Œ x ${headers.length} åˆ—
- **å­—æ®µåˆ—è¡¨**: ${headers.join('ã€')}

## ğŸ“Š æ ·æœ¬æ•°æ®åˆ†æ
\`\`\`
${headers.join('\t')}
${'-'.repeat(headers.join('\t').length)}
${sampleRows.map(row => row.join('\t')).join('\n')}
\`\`\`

## ğŸ” å…³é”®åˆ†æä»»åŠ¡

### 1. ğŸ“‹ æ•°æ®ç»“æ„è¯†åˆ«ï¼ˆé‡ç‚¹ï¼‰
**è¯·ä»”ç»†åˆ¤æ–­æ•°æ®ç»„ç»‡æ–¹å¼ï¼Œè¿™ç›´æ¥å½±å“äººæ•°ç»Ÿè®¡çš„å‡†ç¡®æ€§ï¼š**

**ğŸ”¸ å®½è¡¨æ ¼å¼ (Wide Format)**ï¼š
- ç‰¹å¾ï¼šä¸€è¡Œä»£è¡¨ä¸€ä¸ªå­¦ç”Ÿï¼Œå¤šåˆ—ä»£è¡¨ä¸åŒç§‘ç›®æˆ–å±æ€§
- ç¤ºä¾‹ï¼šå­¦å· | å§“å | ç­çº§ | è¯­æ–‡ | æ•°å­¦ | è‹±è¯­ | ç‰©ç†
- äººæ•°è®¡ç®—ï¼šæ€»è¡Œæ•° = å­¦ç”Ÿäººæ•°
- è¯†åˆ«è¦ç‚¹ï¼š
  * ç¬¬ä¸€åˆ—é€šå¸¸æ˜¯å­¦å·/å§“å
  * æœ‰å¤šä¸ªç§‘ç›®åˆ—ï¼ˆè¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ç­‰ï¼‰
  * æ¯è¡Œæ•°æ®ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„å­¦ç”Ÿè®°å½•

**ğŸ”¸ é•¿è¡¨æ ¼å¼ (Long Format)**ï¼š
- ç‰¹å¾ï¼šå¤šè¡Œä»£è¡¨ä¸€ä¸ªå­¦ç”Ÿçš„ä¸åŒç§‘ç›®æˆç»©
- ç¤ºä¾‹ï¼šå­¦å· | å§“å | ç­çº§ | ç§‘ç›® | åˆ†æ•°
- äººæ•°è®¡ç®—ï¼šæ€»è¡Œæ•° Ã· ç§‘ç›®æ•° = å­¦ç”Ÿäººæ•°
- è¯†åˆ«è¦ç‚¹ï¼š
  * æœ‰ä¸“é—¨çš„"ç§‘ç›®"åˆ—
  * åŒä¸€å­¦ç”Ÿçš„å­¦å·/å§“åä¼šé‡å¤å‡ºç°
  * æ¯è¡Œæ•°æ®ä»£è¡¨ä¸€ä¸ªå­¦ç”Ÿçš„å•ç§‘æˆç»©

### 2. ğŸ‘¥ äººæ•°ç»Ÿè®¡éªŒè¯
**æ ¹æ®æ•°æ®ç»“æ„è®¡ç®—å®é™…å­¦ç”Ÿäººæ•°ï¼š**
- å®½è¡¨æ ¼å¼ï¼šå­¦ç”Ÿäººæ•° = æ•°æ®è¡Œæ•°
- é•¿è¡¨æ ¼å¼ï¼šå­¦ç”Ÿäººæ•° = æ•°æ®è¡Œæ•° Ã· ç§‘ç›®æ•°
- æ··åˆæ ¼å¼ï¼šéœ€è¦å»é‡è®¡ç®—å”¯ä¸€å­¦ç”Ÿæ•°

### 3. ğŸ¯ è€ƒè¯•ä¿¡æ¯æ¨æ–­
æ ¹æ®æ–‡ä»¶åå’Œæ•°æ®å†…å®¹ï¼Œæ¨æ–­è€ƒè¯•çš„åŸºæœ¬ä¿¡æ¯ï¼š
- **è€ƒè¯•åç§°**ï¼šä»æ–‡ä»¶åæå–ï¼ˆå¦‚ï¼šä¹å¹´çº§ä¸Šå­¦æœŸæœŸä¸­è€ƒè¯•ã€907ä¹ä¸‹æœˆè€ƒï¼‰
- **è€ƒè¯•ç±»å‹**ï¼šæœˆè€ƒ/æœŸä¸­/æœŸæœ«/æ¨¡æ‹Ÿ/å•å…ƒæµ‹è¯•
- **è€ƒè¯•æ—¥æœŸ**ï¼šYYYY-MM-DDæ ¼å¼ï¼Œå¦‚æ— æ³•ç¡®å®šä½¿ç”¨å½“å‰æ—¥æœŸ
- **å¹´çº§ä¿¡æ¯**ï¼šå¦‚ï¼šä¹å¹´çº§ã€åˆä¸‰ã€é«˜ä¸€ç­‰
- **è€ƒè¯•èŒƒå›´**ï¼š
  * class: ç­çº§å†…è€ƒè¯•ï¼ˆæ–‡ä»¶ååŒ…å«å…·ä½“ç­çº§ï¼‰
  * grade: å¹´çº§è€ƒè¯•ï¼ˆæ–‡ä»¶ååŒ…å«å¹´çº§ä¿¡æ¯ï¼‰
  * school: å…¨æ ¡è€ƒè¯•ï¼ˆæ–‡ä»¶ååŒ…å«"å…¨æ ¡"æˆ–æ¶‰åŠå¤šä¸ªå¹´çº§ï¼‰

### 4. ğŸ—ºï¸ å­—æ®µæ™ºèƒ½æ˜ å°„
åˆ†ææ¯ä¸ªå­—æ®µçš„å«ä¹‰å¹¶æ˜ å°„åˆ°æ ‡å‡†å­—æ®µï¼š

**åŸºç¡€å­—æ®µ**ï¼š
- student_id: å­¦å·/ç¼–å·/è€ƒå·
- name: å­¦ç”Ÿå§“å/å§“å
- class_name: ç­çº§ä¿¡æ¯/ç­çº§

**æˆç»©å­—æ®µ**ï¼š
- [ç§‘ç›®]_score: å„ç§‘åˆ†æ•°ï¼ˆå¦‚ï¼šè¯­æ–‡_score, æ•°å­¦_scoreï¼‰
- [ç§‘ç›®]_grade: å„ç§‘ç­‰çº§ï¼ˆå¦‚ï¼šè¯­æ–‡_gradeï¼‰
- [ç§‘ç›®]_rank_class: ç­çº§æ’åï¼ˆå¦‚ï¼šè¯­æ–‡_rank_classï¼‰
- [ç§‘ç›®]_rank_grade: å¹´çº§æ’åï¼ˆå¦‚ï¼šè¯­æ–‡_rank_gradeï¼‰
- total_score: æ€»åˆ†/åˆè®¡

### 5. ğŸ“š ç§‘ç›®è¯†åˆ«
è¯†åˆ«æ–‡ä»¶ä¸­åŒ…å«çš„æ‰€æœ‰ç§‘ç›®ï¼š
**å¸¸è§ç§‘ç›®**ï¼šè¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€æ”¿æ²»ã€å†å²ã€åœ°ç†ã€é“å¾·ä¸æ³•æ²»ã€æ€»åˆ†

## ğŸ“‹ è¾“å‡ºè¦æ±‚

è¯·ä»¥JSONæ ¼å¼è¿”å›åˆ†æç»“æœï¼Œç‰¹åˆ«æ³¨æ„æ•°æ®ç»“æ„çš„å‡†ç¡®è¯†åˆ«ï¼š

\`\`\`json
{
  "examInfo": {
    "title": "907ä¹ä¸‹æœˆè€ƒæˆç»©",
    "type": "æœˆè€ƒ",
    "date": "2024-11-15",
    "grade": "ä¹å¹´çº§",
    "scope": "grade"
  },
  "fieldMappings": {
    "å­¦å·": "student_id",
    "å§“å": "name",
    "ç­çº§": "class_name",
    "è¯­æ–‡": "è¯­æ–‡_score",
    "æ•°å­¦": "æ•°å­¦_score"
  },
  "subjects": ["è¯­æ–‡", "æ•°å­¦", "è‹±è¯­", "ç‰©ç†"],
  "dataStructure": "wide",
  "confidence": 0.95,
  "processing": {
    "requiresUserInput": false,
    "issues": [],
    "suggestions": [
      "æ£€æµ‹åˆ°å®½è¡¨æ ¼å¼ï¼Œé¢„è®¡å­¦ç”Ÿäººæ•°: ${totalRows}äºº",
      "æ•°æ®è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥ç›´æ¥å¤„ç†"
    ]
  }
}
\`\`\`

## ğŸ” åˆ†æé‡ç‚¹æé†’

1. **æ•°æ®ç»“æ„åˆ¤æ–­æ˜¯å…³é”®**ï¼šä»”ç»†è§‚å¯Ÿæ ·æœ¬æ•°æ®ï¼Œåˆ¤æ–­æ˜¯å®½è¡¨è¿˜æ˜¯é•¿è¡¨
2. **äººæ•°ç»Ÿè®¡è¦å‡†ç¡®**ï¼šæ ¹æ®æ•°æ®ç»“æ„æ­£ç¡®è®¡ç®—å­¦ç”Ÿäººæ•°
3. **è¯­ä¹‰ç†è§£ä¼˜å…ˆ**ï¼šé‡ç‚¹å…³æ³¨å­—æ®µçš„è¯­ä¹‰å«ä¹‰ï¼Œä¸ä»…ä»…æ˜¯å…³é”®è¯åŒ¹é…
4. **ä¸Šä¸‹æ–‡å…³è”**ï¼šç»“åˆæ–‡ä»¶åã€å­—æ®µç»„åˆã€æ•°æ®æ¨¡å¼è¿›è¡Œç»¼åˆåˆ¤æ–­
5. **æ•™è‚²é¢†åŸŸçŸ¥è¯†**ï¼šè¿ç”¨æ•™è‚²æµ‹è¯„å’Œæˆç»©ç®¡ç†çš„ä¸“ä¸šçŸ¥è¯†

è¯·å¼€å§‹åˆ†æå¹¶è¿”å›JSONç»“æœã€‚
`;
}

/**
 * æ¨¡æ‹ŸAIåˆ†æç»“æœ
 */
function simulateAIAnalysis(data) {
  const { filename, headers, sampleRows, totalRows } = data;
  
  // æ£€æµ‹æ•°æ®ç»“æ„
  const hasSubjectColumn = headers.some(h => h.includes('ç§‘ç›®') || h.includes('subject'));
  const hasMultipleScoreColumns = headers.filter(h => 
    ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'å†å²', 'åœ°ç†'].some(subject => h.includes(subject))
  ).length > 1;
  
  let dataStructure, estimatedStudents, subjects;
  
  if (hasSubjectColumn && !hasMultipleScoreColumns) {
    // é•¿è¡¨æ ¼å¼
    dataStructure = 'long';
    const subjectCount = new Set(sampleRows.map(row => row[headers.indexOf('ç§‘ç›®')])).size;
    estimatedStudents = Math.round(totalRows / (subjectCount || 7));
    subjects = [...new Set(sampleRows.map(row => row[headers.indexOf('ç§‘ç›®')]))];
  } else if (hasMultipleScoreColumns && !hasSubjectColumn) {
    // å®½è¡¨æ ¼å¼
    dataStructure = 'wide';
    estimatedStudents = totalRows;
    subjects = headers.filter(h => 
      ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'å†å²', 'åœ°ç†'].some(subject => h.includes(subject))
    );
  } else {
    // æ··åˆæ ¼å¼
    dataStructure = 'mixed';
    estimatedStudents = totalRows; // éœ€è¦æ›´å¤æ‚çš„é€»è¾‘
    subjects = headers.filter(h => 
      ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'å†å²', 'åœ°ç†'].some(subject => h.includes(subject))
    );
  }
  
  return {
    examInfo: {
      title: filename.replace('.csv', '').replace('.xlsx', ''),
      type: filename.includes('æœˆè€ƒ') ? 'æœˆè€ƒ' : filename.includes('æœŸä¸­') ? 'æœŸä¸­è€ƒè¯•' : filename.includes('æœŸæœ«') ? 'æœŸæœ«è€ƒè¯•' : 'è€ƒè¯•',
      date: new Date().toISOString().split('T')[0],
      grade: filename.includes('907') ? 'ä¹å¹´çº§' : 'æœªçŸ¥å¹´çº§',
      scope: filename.includes('907') || filename.includes('ä¹å¹´çº§') ? 'grade' : 'class'
    },
    fieldMappings: {
      [headers[0]]: 'student_id',
      [headers[1]]: 'name',
      [headers[2]]: 'class_name',
      ...Object.fromEntries(subjects.map(subject => [subject, `${subject}_score`]))
    },
    subjects,
    dataStructure,
    confidence: 0.9,
    processing: {
      requiresUserInput: false,
      issues: [],
      suggestions: [
        `æ£€æµ‹åˆ°${dataStructure === 'wide' ? 'å®½è¡¨' : dataStructure === 'long' ? 'é•¿è¡¨' : 'æ··åˆ'}æ ¼å¼`,
        `é¢„è®¡å­¦ç”Ÿäººæ•°: ${estimatedStudents}äºº`,
        `è¯†åˆ«åˆ°${subjects.length}ä¸ªç§‘ç›®: ${subjects.join('ã€')}`,
        'æ•°æ®è´¨é‡è‰¯å¥½ï¼Œå¯ä»¥ç›´æ¥å¤„ç†'
      ]
    }
  };
}

console.log('ğŸ¤– AIæ–‡ä»¶è§£æåŠŸèƒ½æ¼”ç¤º\n');

// æ¼”ç¤ºå®½è¡¨æ ¼å¼åˆ†æ
console.log('ğŸ“Š å®½è¡¨æ ¼å¼åˆ†ææ¼”ç¤ºï¼ˆä½ ä¸Šä¼ çš„å…¨å¹´çº§æ•°æ®ï¼‰:');
console.log('='.repeat(60));
console.log('ğŸ“ æ–‡ä»¶ä¿¡æ¯:');
console.log(`- æ–‡ä»¶å: ${wideFormatExample.filename}`);
console.log(`- æ•°æ®è§„æ¨¡: ${wideFormatExample.totalRows} è¡Œ x ${wideFormatExample.headers.length} åˆ—`);
console.log(`- å­—æ®µåˆ—è¡¨: ${wideFormatExample.headers.join('ã€')}`);

console.log('\nğŸ” AIåˆ†æç»“æœ:');
const wideResult = simulateAIAnalysis(wideFormatExample);
console.log(JSON.stringify(wideResult, null, 2));

console.log('\n' + '='.repeat(60) + '\n');

// æ¼”ç¤ºé•¿è¡¨æ ¼å¼åˆ†æ
console.log('ğŸ“Š é•¿è¡¨æ ¼å¼åˆ†ææ¼”ç¤º:');
console.log('='.repeat(60));
console.log('ğŸ“ æ–‡ä»¶ä¿¡æ¯:');
console.log(`- æ–‡ä»¶å: ${longFormatExample.filename}`);
console.log(`- æ•°æ®è§„æ¨¡: ${longFormatExample.totalRows} è¡Œ x ${longFormatExample.headers.length} åˆ—`);
console.log(`- å­—æ®µåˆ—è¡¨: ${longFormatExample.headers.join('ã€')}`);

console.log('\nğŸ” AIåˆ†æç»“æœ:');
const longResult = simulateAIAnalysis(longFormatExample);
console.log(JSON.stringify(longResult, null, 2));

console.log('\n' + '='.repeat(60) + '\n');

// å±•ç¤ºä¼˜åŒ–çš„æç¤ºè¯
console.log('ğŸ“ ä¼˜åŒ–çš„AIæç¤ºè¯ç¤ºä¾‹:');
console.log('='.repeat(60));
const prompt = buildOptimizedPrompt(wideFormatExample);
console.log(prompt.substring(0, 1000) + '...\n[æç¤ºè¯å·²æˆªæ–­ï¼Œå®Œæ•´ç‰ˆæœ¬åŒ…å«è¯¦ç»†çš„åˆ†ææŒ‡å¯¼]');

console.log('\nğŸ¯ å…³é”®ä¼˜åŒ–ç‚¹:');
console.log('1. âœ… æ˜ç¡®åŒºåˆ†å®½è¡¨æ ¼å¼ vs é•¿è¡¨æ ¼å¼');
console.log('2. âœ… æä¾›å‡†ç¡®çš„äººæ•°è®¡ç®—å…¬å¼');
console.log('3. âœ… å¼ºè°ƒæ•°æ®ç»“æ„è¯†åˆ«çš„é‡è¦æ€§');
console.log('4. âœ… åŒ…å«æ•™è‚²é¢†åŸŸä¸“ä¸šçŸ¥è¯†');
console.log('5. âœ… æä¾›è¯¦ç»†çš„æ ·æœ¬æ•°æ®åˆ†æ');

console.log('\nğŸš€ è§£å†³æ–¹æ¡ˆæ€»ç»“:');
console.log('- é—®é¢˜: ä¸Šä¼ å…¨å¹´çº§æ•°æ®æ—¶äººæ•°è¯†åˆ«ä¸å¯¹');
console.log('- åŸå› : æ²¡æœ‰ä½¿ç”¨AIæ™ºèƒ½è§£æï¼Œæ— æ³•åŒºåˆ†é•¿è¡¨æ ¼å’Œå®½è¡¨æ ¼');
console.log('- è§£å†³: é›†æˆAIå¢å¼ºè§£æï¼Œä½¿ç”¨ä¼˜åŒ–çš„æç¤ºè¯');
console.log('- æ•ˆæœ: å‡†ç¡®è¯†åˆ«æ•°æ®ç»“æ„ï¼Œæ­£ç¡®è®¡ç®—å­¦ç”Ÿäººæ•°');

console.log('\nğŸ‰ æ¼”ç¤ºå®Œæˆï¼'); 