# 增值评价系统数据库迁移指南

## 📌 概述

本指南将帮助你完成增值评价系统的数据库迁移，包括：
- ✅ 创建5张新表
- ✅ 配置RLS安全策略（全开放模式）
- ✅ 所有用户自动获得admin权限

## 🚀 快速开始（2步完成）

### 步骤1：执行迁移 SQL

1. **打开 Supabase Dashboard**
   ```
   https://supabase.com/dashboard/project/zafpqsrwprdkqyenrwpz
   ```

2. **进入 SQL Editor**
   - 左侧菜单点击 `SQL Editor`
   - 点击 `+ New query` 创建新查询

3. **复制并执行迁移脚本**
   - 打开文件：`supabase/migrations/COMPLETE_MIGRATION.sql`
   - 全选复制所有内容（约300行）
   - 粘贴到 SQL Editor
   - 点击 `Run` 执行

4. **查看执行结果**
   - 应该看到类似输出：
     ```
     ✅ 已创建 5 张增值评价表（应为5张）
     ✅ 已创建 20 个RLS策略
     ✅ 系统共有 X 个用户，其中 X 个拥有admin角色
     🎉 迁移成功！所有表已创建，权限已全开。
     ```

### 步骤2：验证迁移结果

1. **在 SQL Editor 中创建新查询**

2. **复制并执行验证脚本**
   - 打开文件：`supabase/migrations/VERIFY_MIGRATION.sql`
   - 全选复制所有内容
   - 粘贴到新查询
   - 点击 `Run` 执行

3. **检查验证结果**
   - 所有项都应显示 ✅
   - 如果有 ❌，请查看错误信息

## ✅ 验证检查清单

完成迁移后，验证脚本会检查以下项：

- [ ] 5张增值评价表已创建
  - `teacher_student_subjects` - 教师学生科目关联
  - `grade_levels_config` - 等级配置
  - `value_added_activities` - 增值活动
  - `value_added_cache` - 计算缓存
  - `exam_series` - 考试序列

- [ ] RLS策略已配置（全开放模式）
- [ ] 当前用户拥有admin角色
- [ ] 默认等级配置已创建
- [ ] 新用户自动分配admin角色的触发器已启用
- [ ] 写入权限测试通过

## 🎯 权限说明

**默认权限配置：全部开放**

- ✅ 所有认证用户都自动获得 `admin` 角色
- ✅ 新注册用户自动获得 `admin` 角色
- ✅ 所有用户可以：
  - 查看所有数据
  - 创建/修改/删除增值活动
  - 导入学生和成绩数据
  - 生成和查看所有报告

如果将来需要收紧权限，可以：
1. 删除自动分配admin的触发器
2. 手动管理用户角色
3. RLS策略会自动生效（已配置好，只是当前全开放）

## 🔧 常见问题

### Q1: 执行迁移时提示"表已存在"
**A**: 这是正常的，脚本使用了 `CREATE TABLE IF NOT EXISTS`，会跳过已存在的表。

### Q2: 验证脚本显示"没有admin角色"
**A**: 刷新页面后重新执行验证脚本。如果仍然没有，手动执行：
```sql
INSERT INTO user_roles (user_id, role)
VALUES (auth.uid(), 'admin')
ON CONFLICT DO NOTHING;
```

### Q3: 迁移完成后无法导入数据
**A**: 检查：
1. 是否已执行完整的迁移脚本
2. 验证脚本是否全部通过
3. 检查浏览器控制台错误信息

### Q4: 如何撤销迁移
**A**: 如果需要重新开始，执行：
```sql
DROP TABLE IF EXISTS exam_series CASCADE;
DROP TABLE IF EXISTS value_added_cache CASCADE;
DROP TABLE IF EXISTS value_added_activities CASCADE;
DROP TABLE IF EXISTS grade_levels_config CASCADE;
DROP TABLE IF EXISTS teacher_student_subjects CASCADE;
DROP FUNCTION IF EXISTS clean_expired_cache();
DROP FUNCTION IF EXISTS auto_assign_admin_role() CASCADE;
```

## 📞 下一步

迁移完成后，你可以：

1. **启动开发服务器**
   ```bash
   npm run dev
   ```

2. **访问增值评价页面**
   ```
   http://localhost:3000/value-added-analysis
   ```

3. **开始测试**
   - 数据导入：下载模板 → 填写数据 → 上传
   - 创建活动：选择入口/出口考试 → 启动计算
   - 查看报告：班级/教师/学生/学科均衡报告
   - 测试功能：分页、排序、导出PDF/Excel

## 📚 相关文件

- `COMPLETE_MIGRATION.sql` - 完整迁移脚本
- `VERIFY_MIGRATION.sql` - 验证脚本
- `001_value_added_tables.sql` - 原始表创建脚本
- `002_fix_value_added_rls.sql` - 原始RLS策略脚本

## ✨ 迁移特点

本迁移脚本的特点：

- ✅ **幂等性**：可以重复执行，不会报错
- ✅ **安全性**：使用 `IF NOT EXISTS` 和 `ON CONFLICT` 避免冲突
- ✅ **完整性**：包含表、索引、策略、触发器、验证
- ✅ **友好性**：带中文注释和验证反馈

---

**准备好了吗？** 打开 Supabase Dashboard，开始迁移吧！🚀
