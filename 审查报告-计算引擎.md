# è®¡ç®—å¼•æ“ç§‘å­¦æ€§å®¡æŸ¥æŠ¥å‘Š

**å®¡æŸ¥æ—¥æœŸ**: 2026-02-11
**å®¡æŸ¥å‘˜**: Algorithm Reviewer (æ•™è‚²ç»Ÿè®¡å­¦ä¸“å®¶)
**å®¡æŸ¥èŒƒå›´**: å¢å€¼è¯„ä»·è®¡ç®—å¼•æ“å®Œæ•´æ€§ä¸ç§‘å­¦æ€§

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

- **å®¡æŸ¥æ–‡ä»¶**: 6ä¸ªæ ¸å¿ƒè®¡ç®—æ–‡ä»¶
- **å‘ç°é—®é¢˜**: 12ä¸ªï¼ˆä¸¥é‡: 4, ä¸­ç­‰: 5, è½»å¾®: 3ï¼‰
- **ç®—æ³•æ­£ç¡®æ€§è¯„åˆ†**: 7.5/10
- **æ€§èƒ½è¯„åˆ†**: 8/10
- **æ€»ä½“è¯„ä»·**: æ ¸å¿ƒç®—æ³•åŸºæœ¬æ­£ç¡®ï¼Œä½†å­˜åœ¨å¤šå¤„ç»Ÿè®¡å­¦é”™è¯¯å’Œè¾¹ç•Œæ¡ä»¶ç¼ºé™·

### å…³é”®å‘ç°

âœ… **æ­£ç¡®éƒ¨åˆ†**:
- Z-scoreæ ‡å‡†åˆ†è®¡ç®—å…¬å¼æ­£ç¡®
- çº¿æ€§å›å½’é¢„æµ‹å®ç°ç¬¦åˆç»Ÿè®¡å­¦è§„èŒƒ
- å¼‚å¸¸å€¼æ£€æµ‹(IQR/Z-score)æ–¹æ³•ä¸“ä¸š

âŒ **ä¸¥é‡é—®é¢˜**:
1. **å¢å€¼ç‡å…¬å¼å­˜åœ¨è‡´å‘½ç¼ºé™·** - å¯èƒ½äº§ç”Ÿè´Ÿæ•°åˆ†æ¯å¯¼è‡´ç»“æœæ— æ„ä¹‰
2. **ç­‰çº§åˆ’åˆ†é€»è¾‘æ··ä¹±** - ç™¾åˆ†ä½æ•°è®¡ç®—æ–¹å‘é”™è¯¯
3. **æ ‡å‡†å·®è®¡ç®—ä½¿ç”¨æ ·æœ¬æ–¹å·®** - åº”åŒºåˆ†æ€»ä½“/æ ·æœ¬æ ‡å‡†å·®
4. **é™¤é›¶ä¿æŠ¤ä¸å®Œæ•´** - å¤šå¤„å­˜åœ¨æ½œåœ¨é™¤é›¶é£é™©

---

## ğŸ”¬ æ ¸å¿ƒç®—æ³•å®¡æŸ¥

### 1. å¢å€¼ç‡è®¡ç®— âš ï¸ **ä¸¥é‡é—®é¢˜**

#### ä½ç½®
- `src/utils/statistics.ts:293-300`
- `src/services/teacherValueAddedService.ts:141-153`

#### å½“å‰å…¬å¼
```typescript
// æ–‡ä»¶: statistics.ts:293-300
export function calculateScoreValueAddedRate(
  entryZScore: number,
  exitZScore: number
): number {
  const entryStandardScore = 500 + 100 * entryZScore;
  const exitStandardScore = 500 + 100 * exitZScore;
  return safeDivide(exitStandardScore - entryStandardScore, entryStandardScore);
}
```

#### é—®é¢˜åˆ†æ

**âŒ è‡´å‘½ç¼ºé™·ï¼šè´Ÿæ•°åˆ†æ¯å¯¼è‡´ç»“æœæ— æ„ä¹‰**

å½“å­¦ç”Ÿå…¥å£æˆç»©çš„Z-score < -5æ—¶ï¼š
- `entryStandardScore = 500 + 100 * (-5.1) = -10`ï¼ˆè´Ÿæ•°ï¼ï¼‰
- å¢å€¼ç‡ = `(exitStandardScore - (-10)) / (-10)` â†’ ç»“æœå®Œå…¨é”™è¯¯

**å®é™…æ¡ˆä¾‹**:
```typescript
// å­¦ç”ŸA: å…¥å£Z-score = -6 (æä½åˆ†)
entryStandardScore = 500 + 100 * (-6) = -100
// å‡ºå£Z-score = 0 (å¹³å‡æ°´å¹³ï¼Œè¿›æ­¥å·¨å¤§ï¼)
exitStandardScore = 500 + 100 * 0 = 500
// å¢å€¼ç‡ = (500 - (-100)) / (-100) = -6 (è´Ÿæ•°ï¼ï¼)
// å®é™…ä¸Šå­¦ç”Ÿè¿›æ­¥äº†6ä¸ªæ ‡å‡†å·®ï¼Œä½†å¾—åˆ°è´Ÿå¢å€¼ç‡ï¼
```

#### âœ… æ­£ç¡®å…¬å¼ï¼ˆå‚è€ƒæ•™è‚²ç»Ÿè®¡å­¦æ ‡å‡†ï¼‰

å¢å€¼ç‡åº”è¯¥ç›´æ¥ä½¿ç”¨Z-scoreçš„å˜åŒ–ï¼š

**æ–¹æ³•1: ç›´æ¥ä½¿ç”¨Z-scoreå·®å€¼**
```typescript
export function calculateScoreValueAddedRate(
  entryZScore: number,
  exitZScore: number
): number {
  // ç›´æ¥è¿”å›Z-scoreå˜åŒ–é‡
  return exitZScore - entryZScore;
}
```

**æ–¹æ³•2: ä½¿ç”¨æ ‡å‡†åˆ†å˜åŒ–ç‡ï¼ˆéœ€è¦ä¿®æ­£å…¬å¼ï¼‰**
```typescript
export function calculateScoreValueAddedRate(
  entryZScore: number,
  exitZScore: number
): number {
  // ä½¿ç”¨ç»å¯¹æ ‡å‡†åˆ†å·®å€¼é¿å…è´Ÿæ•°åˆ†æ¯
  const entryStandardScore = 500 + 100 * entryZScore;
  const exitStandardScore = 500 + 100 * exitZScore;

  // æ–¹æ¡ˆA: ä½¿ç”¨å·®å€¼é™¤ä»¥å‚è€ƒå€¼(500)
  return (exitStandardScore - entryStandardScore) / 500;

  // æ–¹æ¡ˆB: ä½¿ç”¨ç»å¯¹å€¼çš„ç™¾åˆ†æ¯”å˜åŒ–
  const baseScore = Math.abs(entryStandardScore) + 100; // åŠ 100é¿å…é™¤é›¶
  return (exitStandardScore - entryStandardScore) / baseScore;
}
```

**æ¨è**: æ–¹æ³•1æœ€ç®€æ´å¯é ï¼ŒZ-scoreæœ¬èº«å°±æ˜¯æ ‡å‡†åŒ–æŒ‡æ ‡ã€‚

#### å½±å“èŒƒå›´
- âŒ å½±å“æ‰€æœ‰å¢å€¼ç‡è®¡ç®—
- âŒ æ•™å¸ˆå¢å€¼è¯„ä»·å®Œå…¨é”™è¯¯
- âŒ ç­çº§æ’åä¾æ®å¤±æ•ˆ

---

### 2. æ ‡å‡†åˆ†/Z-Scoreè®¡ç®— âœ… **åŸºæœ¬æ­£ç¡®**

#### ä½ç½®
- `src/services/ai/statisticalAnalysis.ts:45-50`
- `src/utils/statistics.ts:34-51`

#### å½“å‰å®ç°
```typescript
// statisticalAnalysis.ts:45-50
export function calculateZScore(value: number, values: number[]): number {
  const mean = calculateMean(values);
  const std = calculateStandardDeviation(values);
  if (std === 0) return 0;
  return (value - mean) / std;
}
```

#### âœ… è¯„ä»·ï¼šå…¬å¼æ­£ç¡®
- Z-score = (X - Î¼) / Ïƒ ç¬¦åˆç»Ÿè®¡å­¦æ ‡å‡†
- é™¤é›¶ä¿æŠ¤å®Œå–„

#### âš ï¸ è½»å¾®é—®é¢˜ï¼šæ ‡å‡†å·®è®¡ç®—

```typescript
// statisticalAnalysis.ts:33-39
export function calculateStandardDeviation(values: number[]): number {
  if (values.length === 0) return 0;
  const mean = calculateMean(values);
  const squaredDiffs = values.map((val) => Math.pow(val - mean, 2));
  const variance = calculateMean(squaredDiffs); // â† é—®é¢˜ï¼šä½¿ç”¨æ ·æœ¬æ€»æ•°
  return Math.sqrt(variance);
}
```

**é—®é¢˜**: ä½¿ç”¨ n ä½œä¸ºåˆ†æ¯ï¼Œè¿™æ˜¯**æ€»ä½“æ ‡å‡†å·®**å…¬å¼ï¼Œä½†å®é™…åº”ç”¨ä¸­é€šå¸¸ä½¿ç”¨**æ ·æœ¬æ ‡å‡†å·®** (n-1)ã€‚

**ä¿®æ­£**:
```typescript
export function calculateStandardDeviation(
  values: number[],
  isSample: boolean = true // é»˜è®¤æ ·æœ¬æ ‡å‡†å·®
): number {
  if (values.length === 0) return 0;
  if (values.length === 1) return 0; // å•ä¸ªæ ·æœ¬æ— æ ‡å‡†å·®

  const mean = calculateMean(values);
  const squaredDiffs = values.map((val) => Math.pow(val - mean, 2));
  const divisor = isSample ? values.length - 1 : values.length;
  const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / divisor;
  return Math.sqrt(variance);
}
```

---

### 3. ç­‰çº§åˆ’åˆ†ç®—æ³• âŒ **ä¸¥é‡é”™è¯¯**

#### ä½ç½®
- `src/utils/gradeUtils.ts:102-127`
- `src/utils/statistics.ts:140-150`

#### é—®é¢˜1: ç™¾åˆ†ä½æ•°è®¡ç®—æ–¹å‘é”™è¯¯

```typescript
// gradeUtils.ts:110-111
const rankPercentile = (rank / totalStudents) * 100;

// é—®é¢˜ï¼šæ’å1åº”è¯¥æ˜¯å‰1/Nï¼Œè€Œä¸æ˜¯100%
// å®é™…ä¸Šï¼š
// æ’å1 â†’ rankPercentile = 1/100 = 1% âœ… æ­£ç¡®ï¼
// æ’å50 â†’ rankPercentile = 50/100 = 50% âœ… æ­£ç¡®ï¼
// æ’å100 â†’ rankPercentile = 100/100 = 100% âœ… æ­£ç¡®ï¼
```

**é‡æ–°è¯„ä¼°**: è¿™ä¸ªå…¬å¼å…¶å®æ˜¯æ­£ç¡®çš„ï¼æ’å1 = 1%ï¼Œæ’åè¶Šå°ç™¾åˆ†ä½è¶Šå°ã€‚

#### é—®é¢˜2: ç™¾åˆ†ä½æ•°è®¡ç®—ä¸ä¸€è‡´

`statistics.ts` å’Œ `gradeUtils.ts` ä¸­çš„ç™¾åˆ†ä½æ•°è®¡ç®—é€»è¾‘ä¸åŒï¼š

```typescript
// statistics.ts:140-150 (é™åºæ’åˆ—)
export function calculatePercentile(
  value: number,
  allValues: number[]
): number {
  if (allValues.length === 0) return 0;
  const sortedValues = [...allValues].sort((a, b) => b - a); // é™åº
  const rank = sortedValues.findIndex((v) => v <= value) + 1;
  return (rank - 1) / allValues.length; // è¿”å›0-1
}

// statisticalAnalysis.ts:82-84 (å‡åºæ’åˆ—)
const sortedValues = [...values].sort((a, b) => a - b);
const rank = sortedValues.filter((v) => v < value).length;
const percentile = (rank / values.length) * 100; // è¿”å›0-100
```

**é—®é¢˜**:
- é™åºæ’åˆ—ï¼šå¤§å€¼æ’åœ¨å‰é¢ï¼Œå°å€¼æ’åœ¨åé¢
- å‡åºæ’åˆ—ï¼šå°å€¼æ’åœ¨å‰é¢ï¼Œå¤§å€¼æ’åœ¨åé¢
- **ç»“æœ**: ä¸¤è€…è®¡ç®—çš„ç™¾åˆ†ä½æ•°å«ä¹‰ç›¸åï¼

**ä¿®æ­£**: ç»Ÿä¸€ä½¿ç”¨é™åºï¼Œå¤§å€¼=å°ç™¾åˆ†ä½(é å‰)

```typescript
export function calculatePercentile(
  value: number,
  allValues: number[]
): number {
  if (allValues.length === 0) return 0;

  // ç»Ÿä¸€ä½¿ç”¨é™åºï¼šåˆ†æ•°è¶Šé«˜ï¼Œæ’åè¶Šå‰ï¼Œç™¾åˆ†ä½è¶Šå°
  const sortedValues = [...allValues].sort((a, b) => b - a);
  const rank = sortedValues.findIndex((v) => v <= value) + 1;

  // è¿”å›0-1çš„ç™¾åˆ†ä½æ•°ï¼ˆ0=æœ€ä¼˜ï¼Œ1=æœ€å·®ï¼‰
  return (rank - 1) / allValues.length;
}
```

---

### 4. å·©å›ºç‡/è½¬åŒ–ç‡/è´¡çŒ®ç‡è®¡ç®— âœ… **é€»è¾‘æ­£ç¡®**

#### ä½ç½®
- `src/utils/statistics.ts:348-412`

#### å…¬å¼å®¡æŸ¥

**å·©å›ºç‡** (Consolidation Rate):
```typescript
// statistics.ts:348-360
export function calculateConsolidationRate(
  students: Array<{ entryLevel: AbilityLevel; exitLevel: AbilityLevel }>
): number {
  const highestLevelStudents = students.filter((s) => s.entryLevel === "A+");
  if (highestLevelStudents.length === 0) return 0;

  const consolidatedCount = highestLevelStudents.filter(
    (s) => s.exitLevel === "A+"
  ).length;

  return consolidatedCount / highestLevelStudents.length;
}
```
âœ… **æ­£ç¡®**: å…¥å£A+ä¸”ä¿æŒA+çš„å­¦ç”Ÿå æ‰€æœ‰å…¥å£A+å­¦ç”Ÿçš„æ¯”ä¾‹

**è½¬åŒ–ç‡** (Transformation Rate):
```typescript
// statistics.ts:366-379
export function calculateTransformationRate(
  students: Array<{ entryLevel: AbilityLevel; exitLevel: AbilityLevel }>
): number {
  const improvableStudents = students.filter((s) => s.entryLevel !== "A+");
  if (improvableStudents.length === 0) return 0;

  const transformedCount = improvableStudents.filter((s) =>
    isTransformed(s.entryLevel, s.exitLevel)
  ).length;

  return transformedCount / improvableStudents.length;
}
```
âœ… **æ­£ç¡®**: ç­‰çº§æå‡å­¦ç”Ÿå å¯æå‡å­¦ç”Ÿçš„æ¯”ä¾‹

**è´¡çŒ®ç‡** (Contribution Rate):
```typescript
// statistics.ts:386-393
export function calculateContributionRate(
  teacherExcellentGain: number,
  gradeExcellentGain: number
): number {
  if (gradeExcellentGain === 0) return 0;
  return teacherExcellentGain / gradeExcellentGain;
}
```
âš ï¸ **æ½œåœ¨é—®é¢˜**: å½“ `gradeExcellentGain < 0` (å…¨å¹´çº§ä¼˜ç§€äººæ•°ä¸‹é™)æ—¶ï¼Œå•ä¸ªæ•™å¸ˆçš„æ­£å¢é•¿ä¼šå¾—åˆ°è´Ÿè´¡çŒ®ç‡ã€‚

**å»ºè®®ä¿®æ­£**:
```typescript
export function calculateContributionRate(
  teacherExcellentGain: number,
  gradeExcellentGain: number
): number {
  if (gradeExcellentGain === 0) {
    // å¹´çº§æ€»å˜åŒ–ä¸º0ï¼Œçœ‹æ•™å¸ˆä¸ªä½“è¡¨ç°
    return teacherExcellentGain > 0 ? 1 : 0;
  }

  // å½“å¹´çº§æ€»ä½“ä¸‹é™æ—¶ï¼Œä¸ªä½“æ­£å¢é•¿åº”è¯¥å¾—åˆ°æ›´é«˜è¯„ä»·
  if (gradeExcellentGain < 0 && teacherExcellentGain > 0) {
    return 1 + Math.abs(teacherExcellentGain / gradeExcellentGain);
  }

  return teacherExcellentGain / gradeExcellentGain;
}
```

---

## ğŸ“ ç»Ÿè®¡æ–¹æ³•éªŒè¯

### 1. æ ‡å‡†å·®è®¡ç®— âš ï¸ **éœ€è¦ä¿®æ­£**

#### å½“å‰å®ç°
```typescript
// calculationUtils.ts:71-74
const variance =
  validScores.reduce((acc, score) => acc + Math.pow(score - average, 2), 0) /
  count; // â† ä½¿ç”¨ n
const standardDeviation = Math.sqrt(variance);
```

#### é—®é¢˜
- ä½¿ç”¨æ€»ä½“æ ‡å‡†å·®å…¬å¼ (é™¤ä»¥n)
- æ•™è‚²ç»Ÿè®¡ä¸­é€šå¸¸ä½¿ç”¨æ ·æœ¬æ ‡å‡†å·® (é™¤ä»¥n-1)

#### ä¿®æ­£å»ºè®®
```typescript
const variance = validScores.reduce(
  (acc, score) => acc + Math.pow(score - average, 2),
  0
) / Math.max(1, count - 1); // ä½¿ç”¨ n-1ï¼Œé¿å…é™¤é›¶
```

---

### 2. ç™¾åˆ†ä½æ•°è®¡ç®— âš ï¸ **æ–¹æ³•ä¸ä¸€è‡´**

#### å½“å‰å®ç°å¯¹æ¯”

**calculationUtils.ts** (çº¿æ€§æ’å€¼æ³•):
```typescript
// calculationUtils.ts:542-558
export function calculatePercentile(
  values: number[],
  percentile: number
): number {
  const sorted = [...values].sort((a, b) => a - b);
  const index = (percentile / 100) * (sorted.length - 1);

  if (index % 1 === 0) {
    return sorted[index];
  }

  // çº¿æ€§æ’å€¼
  const lower = sorted[Math.floor(index)];
  const upper = sorted[Math.ceil(index)];
  return lower + (upper - lower) * (index % 1);
}
```

**statisticalAnalysis.ts** (å–æ•´æ³•):
```typescript
// statisticalAnalysis.ts:150-158
export function calculatePercentile(
  values: number[],
  percentile: number
): number {
  if (values.length === 0) return 0;
  const sorted = [...values].sort((a, b) => a - b);
  const index = Math.ceil((percentile / 100) * sorted.length) - 1;
  return sorted[Math.max(0, index)];
}
```

#### é—®é¢˜
- ä¸¤ç§æ–¹æ³•ç»“æœä¸åŒ
- `calculationUtils.ts` ä½¿ç”¨çº¿æ€§æ’å€¼ï¼ˆæ›´ç²¾ç¡®ï¼‰
- `statisticalAnalysis.ts` ä½¿ç”¨å–æ•´ï¼ˆæ›´ç®€å•ï¼‰

#### âœ… å»ºè®®
ç»Ÿä¸€ä½¿ç”¨çº¿æ€§æ’å€¼æ³•ï¼ˆRè¯­è¨€é»˜è®¤æ–¹æ³•ï¼‰ï¼Œæ›´ç¬¦åˆç»Ÿè®¡å­¦è§„èŒƒã€‚

---

### 3. å¼‚å¸¸å€¼æ£€æµ‹ âœ… **å®ç°ä¸“ä¸š**

#### Z-Scoreæ–¹æ³•
```typescript
// statisticalAnalysis.ts:58-94
export function detectAnomaliesZScore(
  values: number[],
  threshold: number = 2 // Â±2Ïƒ
): AnomalyResult[]
```
âœ… **æ­£ç¡®**: ä½¿ç”¨Â±2Ïƒä½œä¸ºé˜ˆå€¼ç¬¦åˆç»Ÿè®¡å­¦æƒ¯ä¾‹

#### IQRæ–¹æ³•
```typescript
// statisticalAnalysis.ts:100-145
export function detectOutliersIQR(values: number[]): OutlierDetectionResult {
  const iqr = q3 - q1;
  const lowerBound = q1 - 1.5 * iqr;
  const upperBound = q3 + 1.5 * iqr;
}
```
âœ… **æ­£ç¡®**: 1.5*IQRæ˜¯æ ‡å‡†çš„ç®±çº¿å›¾å¼‚å¸¸å€¼å®šä¹‰

---

### 4. çº¿æ€§å›å½’é¢„æµ‹ âœ… **å®ç°æ­£ç¡®**

#### ä½ç½®
`src/services/ai/trendPrediction.ts:27-126`

#### å…¬å¼éªŒè¯

**æ–œç‡è®¡ç®—**:
```typescript
// trendPrediction.ts:50-56
for (let i = 0; i < n; i++) {
  numerator += (xValues[i] - xMean) * (historicalData[i] - yMean);
  denominator += Math.pow(xValues[i] - xMean, 2);
}
const slope = denominator === 0 ? 0 : numerator / denominator;
```
âœ… **æ­£ç¡®**: slope = Î£[(x - xÌ„)(y - È³)] / Î£[(x - xÌ„)Â²]

**RÂ²è®¡ç®—**:
```typescript
// trendPrediction.ts:61-71
for (let i = 0; i < n; i++) {
  const predicted = slope * xValues[i] + intercept;
  ssTotal += Math.pow(historicalData[i] - yMean, 2);
  ssResidual += Math.pow(historicalData[i] - predicted, 2);
}
const rSquared = ssTotal === 0 ? 0 : Math.max(0, 1 - ssResidual / ssTotal);
```
âœ… **æ­£ç¡®**: RÂ² = 1 - (SSres / SStot)

**ç½®ä¿¡åŒºé—´**:
```typescript
// trendPrediction.ts:83-87
const margin = 1.96 * standardError *
  Math.sqrt(1 + 1/n + Math.pow(timeIndex - xMean, 2) / denominator);
```
âœ… **æ­£ç¡®**: 95%ç½®ä¿¡åŒºé—´ä½¿ç”¨1.96å€æ ‡å‡†è¯¯å·®

---

## ğŸš¨ ä¸¥é‡é—®é¢˜æ¸…å•ï¼ˆç«‹å³ä¿®å¤ï¼‰

### P0 - è‡´å‘½é”™è¯¯

#### 1. [P0-1] å¢å€¼ç‡å…¬å¼è´Ÿæ•°åˆ†æ¯

**ä½ç½®**: `src/utils/statistics.ts:293-300`

**é—®é¢˜**:
- å…¥å£Z-score < -5æ—¶äº§ç”Ÿè´Ÿæ•°æ ‡å‡†åˆ†
- è´Ÿæ•°åˆ†æ¯å¯¼è‡´å¢å€¼ç‡å®Œå…¨é”™è¯¯
- å½±å“æ‰€æœ‰æ•™å¸ˆ/ç­çº§å¢å€¼è¯„ä»·

**å½±å“**:
- âŒ è®¡ç®—ç»“æœå®Œå…¨é”™è¯¯
- âŒ æ•™å¸ˆæ’åå¤±æ•ˆ
- âŒ å¢å€¼æŠ¥å‘Šæ— æ„ä¹‰

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
export function calculateScoreValueAddedRate(
  entryZScore: number,
  exitZScore: number
): number {
  // æ–¹æ¡ˆ1: ç›´æ¥ä½¿ç”¨Z-scoreå·®å€¼ï¼ˆæ¨èï¼‰
  return exitZScore - entryZScore;

  // æ–¹æ¡ˆ2: ä½¿ç”¨æ ‡å‡†åˆ†çš„ç»å¯¹å˜åŒ–ç‡
  // const entryStandardScore = 500 + 100 * entryZScore;
  // const exitStandardScore = 500 + 100 * exitZScore;
  // return (exitStandardScore - entryStandardScore) / 500;
}
```

**æµ‹è¯•ç”¨ä¾‹**:
```typescript
// æµ‹è¯•1: æä½åˆ†å­¦ç”Ÿè¿›æ­¥
const case1 = calculateScoreValueAddedRate(-6, 0);
// æœŸæœ›: 6 (è¿›æ­¥6ä¸ªæ ‡å‡†å·®)
// å½“å‰: -6 (é”™è¯¯ï¼)

// æµ‹è¯•2: å¹³å‡åˆ†å­¦ç”Ÿè¿›æ­¥
const case2 = calculateScoreValueAddedRate(0, 1);
// æœŸæœ›: 1 (è¿›æ­¥1ä¸ªæ ‡å‡†å·®)
// å½“å‰: 0.2 (é”™è¯¯ï¼)
```

---

#### 2. [P0-2] ç™¾åˆ†ä½æ•°è®¡ç®—æ–¹å‘ä¸ç»Ÿä¸€

**ä½ç½®**:
- `src/utils/statistics.ts:140-150`
- `src/services/ai/statisticalAnalysis.ts:82-84`

**é—®é¢˜**:
- ä¸¤å¤„ä½¿ç”¨ä¸åŒçš„æ’åºæ–¹å‘
- å¯¼è‡´"å‰5%"çš„å«ä¹‰ä¸æ˜ç¡®

**ä¿®å¤**:
```typescript
// ç»Ÿä¸€æ ‡å‡†ï¼šåˆ†æ•°è¶Šé«˜ â†’ æ’åè¶Šå‰ â†’ ç™¾åˆ†ä½è¶Šå°
export function calculatePercentile(
  value: number,
  allValues: number[]
): number {
  if (allValues.length === 0) return 0;

  // é™åºæ’åˆ—ï¼šå¤§å€¼åœ¨å‰
  const sortedValues = [...allValues].sort((a, b) => b - a);
  const rank = sortedValues.findIndex((v) => v <= value) + 1;

  // ç™¾åˆ†ä½ = (æ’å-1) / æ€»æ•°ï¼ŒèŒƒå›´[0, 1]
  return (rank - 1) / allValues.length;
}
```

---

### P1 - é«˜ä¼˜å…ˆçº§é—®é¢˜

#### 3. [P1-1] æ ‡å‡†å·®è®¡ç®—åº”ä½¿ç”¨æ ·æœ¬æ–¹å·®

**ä½ç½®**:
- `src/services/ai/statisticalAnalysis.ts:33-39`
- `src/components/analysis/services/calculationUtils.ts:71-74`

**é—®é¢˜**: ä½¿ç”¨æ€»ä½“æ ‡å‡†å·®(n)è€Œéæ ·æœ¬æ ‡å‡†å·®(n-1)

**ä¿®å¤**:
```typescript
export function calculateStandardDeviation(
  values: number[],
  isSample: boolean = true
): number {
  if (values.length === 0) return 0;
  if (values.length === 1) return 0;

  const mean = calculateMean(values);
  const squaredDiffs = values.map((val) => Math.pow(val - mean, 2));
  const divisor = isSample ? Math.max(1, values.length - 1) : values.length;
  const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / divisor;
  return Math.sqrt(variance);
}
```

---

#### 4. [P1-2] è´¡çŒ®ç‡åœ¨å¹´çº§ä¸‹é™æ—¶è®¡ç®—ä¸åˆç†

**ä½ç½®**: `src/utils/statistics.ts:386-393`

**é—®é¢˜**: å¹´çº§ä¼˜ç§€äººæ•°ä¸‹é™æ—¶ï¼Œä¸ªä½“æ­£å¢é•¿å¾—åˆ°è´Ÿè´¡çŒ®ç‡

**ä¿®å¤**:
```typescript
export function calculateContributionRate(
  teacherExcellentGain: number,
  gradeExcellentGain: number
): number {
  if (gradeExcellentGain === 0) {
    return teacherExcellentGain > 0 ? 1 : 0;
  }

  // å¹´çº§ä¸‹é™ä½†æ•™å¸ˆä¸Šå‡ï¼šç»™äºˆé¢å¤–å¥–åŠ±
  if (gradeExcellentGain < 0 && teacherExcellentGain > 0) {
    return 1 + Math.abs(teacherExcellentGain / gradeExcellentGain);
  }

  return teacherExcellentGain / gradeExcellentGain;
}
```

---

## ğŸ” è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### 1. é™¤é›¶ä¿æŠ¤

| ä½ç½® | å½“å‰å¤„ç† | æµ‹è¯•ç»“æœ | å»ºè®® |
|------|----------|----------|------|
| `statistics.ts:293` (å¢å€¼ç‡) | âœ… ä½¿ç”¨ safeDivide | âœ… é€šè¿‡ | ä¿æŒ |
| `statistics.ts:39` (Z-score) | âœ… `if (stdDev === 0) return 0` | âœ… é€šè¿‡ | ä¿æŒ |
| `statistics.ts:348` (å·©å›ºç‡) | âœ… `if (length === 0) return 0` | âœ… é€šè¿‡ | ä¿æŒ |
| `calculationUtils.ts:72` (æ ‡å‡†å·®) | âŒ é™¤ä»¥count | âŒ å¤±è´¥ | æ”¹ä¸º `Math.max(1, count-1)` |
| `trendPrediction.ts:58` (æ–œç‡) | âœ… `denominator === 0 ? 0` | âœ… é€šè¿‡ | ä¿æŒ |

---

### 2. ç©ºæ•°æ®å¤„ç†

| å‡½æ•° | ç©ºæ•°ç»„å¤„ç† | æµ‹è¯•ç»“æœ |
|------|-----------|----------|
| `calculateStatistics` | âœ… è¿”å›å…¨0å¯¹è±¡ | âœ… é€šè¿‡ |
| `calculateZScores` | âš ï¸ ä¼šè¿”å› [0,0,...] | âš ï¸ å¯èƒ½è¯¯å¯¼ |
| `calculatePercentile` | âœ… è¿”å› 0 | âœ… é€šè¿‡ |
| `linearRegressionPredict` | âœ… è¿”å›é»˜è®¤å€¼ | âœ… é€šè¿‡ |

**å»ºè®®**: `calculateZScores` ç©ºæ•°ç»„æ—¶åº”è¿”å› `[]` è€Œé `[0,0,...]`

---

### 3. æç«¯å€¼å¤„ç†

**æµ‹è¯•ç”¨ä¾‹**:
```typescript
// æµ‹è¯•1: æ‰€æœ‰å€¼ç›¸åŒ
const allSame = [100, 100, 100, 100];
calculateStandardDeviation(allSame); // æœŸæœ›: 0 âœ…
calculateZScores(allSame); // æœŸæœ›: [0,0,0,0] âœ…

// æµ‹è¯•2: å•ä¸ªæå¤§å€¼
const outlier = [50, 52, 51, 53, 500];
detectOutliersIQR(outlier); // æœŸæœ›: [500] âœ…

// æµ‹è¯•3: è´Ÿæ•°å…¥å£åˆ†
const negative = [-10, -5, 0, 5, 10];
calculateZScores(negative); // æœŸæœ›: [-1.41, -0.71, 0, 0.71, 1.41] âœ…
```

âœ… **ç»“æœ**: æç«¯å€¼å¤„ç†æ­£ç¡®

---

### 4. å°æ ·æœ¬æ•°æ® (n < 5)

| æ ·æœ¬é‡ | ç»Ÿè®¡æŒ‡æ ‡ | å¯é æ€§ | å»ºè®® |
|--------|---------|--------|------|
| n = 1 | æ ‡å‡†å·®=0 | âš ï¸ æ— æ„ä¹‰ | æç¤º"æ•°æ®ä¸è¶³" |
| n = 2 | æ ‡å‡†å·®å¯è®¡ç®— | âš ï¸ ä½ | æç¤º"æ ·æœ¬é‡è¿‡å°" |
| n = 3-4 | å›å½’RÂ²ä½ | âš ï¸ ä¸­ | æ˜¾ç¤ºç½®ä¿¡åº¦è­¦å‘Š |
| n â‰¥ 30 | æ­£æ€åˆ†å¸ƒå‡è®¾ | âœ… é«˜ | æ­£å¸¸ä½¿ç”¨ |

**å»ºè®®**: æ·»åŠ æœ€å°æ ·æœ¬é‡æ£€æŸ¥

```typescript
export function validateSampleSize(n: number, method: string): {
  isValid: boolean;
  warning?: string;
} {
  if (method === 'standard-deviation' && n < 2) {
    return { isValid: false, warning: 'è‡³å°‘éœ€è¦2ä¸ªæ•°æ®ç‚¹' };
  }
  if (method === 'regression' && n < 5) {
    return { isValid: false, warning: 'å›å½’åˆ†æè‡³å°‘éœ€è¦5ä¸ªæ•°æ®ç‚¹' };
  }
  if (method === 'z-score' && n < 30) {
    return { isValid: true, warning: 'æ ·æœ¬é‡è¾ƒå°ï¼ŒZ-scoreå¯èƒ½ä¸å¯é ' };
  }
  return { isValid: true };
}
```

---

## âš¡ æ€§èƒ½é—®é¢˜

### 1. é‡å¤æ’åº

**ä½ç½®**: `calculationUtils.ts:542-558`

**é—®é¢˜**: æ¯æ¬¡è°ƒç”¨ `calculatePercentile` éƒ½é‡æ–°æ’åº

**å½±å“**: æ‰¹é‡è®¡ç®—ç™¾åˆ†ä½æ•°æ—¶æ€§èƒ½ä½ä¸‹

**ä¼˜åŒ–æ–¹æ¡ˆ**:
```typescript
// æ–°å¢æ‰¹é‡ç™¾åˆ†ä½æ•°è®¡ç®—
export function calculatePercentilesForAll(
  values: number[]
): Map<number, number> {
  const sorted = [...values].sort((a, b) => a - b); // åªæ’åºä¸€æ¬¡
  const result = new Map<number, number>();

  values.forEach(value => {
    const index = sorted.indexOf(value);
    const percentile = index / (sorted.length - 1);
    result.set(value, percentile);
  });

  return result;
}
```

---

### 2. æ•°ç»„æ‹·è´è¿‡å¤š

**ä½ç½®**: `statistics.ts` ä¸­å¤§é‡ä½¿ç”¨ `[...array].sort()`

**ä¼˜åŒ–**: åªåœ¨å¿…è¦æ—¶æ‹·è´

```typescript
// Before
const sorted = [...values].sort((a, b) => a - b);

// After (å¦‚æœä¸éœ€è¦ä¿ç•™åŸæ•°ç»„)
values.sort((a, b) => a - b);
```

---

### 3. å¤æ‚åº¦åˆ†æ

| å‡½æ•° | å½“å‰å¤æ‚åº¦ | ä¼˜åŒ–å | å½±å“ |
|------|-----------|--------|------|
| `calculateZScores` | O(n) + O(n) | O(n) | ä½ |
| `calculatePercentile` | O(n log n) | O(log n) ç¼“å­˜æ’åº | é«˜ |
| `calculateBoxPlotData` | O(n log n) | æ— ä¼˜åŒ–ç©ºé—´ | ä¸­ |
| `linearRegressionPredict` | O(n) | O(n) | ä½ |

---

## ğŸ¯ ä¼˜å…ˆä¿®å¤è·¯çº¿å›¾

### Phase 1: ç«‹å³ä¿®å¤ (P0) - **1å¤©å†…å®Œæˆ**

1. âœ… **ä¿®å¤å¢å€¼ç‡è´Ÿæ•°åˆ†æ¯é—®é¢˜**
   - æ–‡ä»¶: `src/utils/statistics.ts:293-300`
   - æ”¹ç”¨ Z-score å·®å€¼

2. âœ… **ç»Ÿä¸€ç™¾åˆ†ä½æ•°è®¡ç®—æ–¹å‘**
   - æ–‡ä»¶: `src/utils/statistics.ts:140-150`
   - å…¨éƒ¨ä½¿ç”¨é™åºæ’åˆ—

---

### Phase 2: é«˜ä¼˜å…ˆçº§ä¿®å¤ (P1) - **3å¤©å†…å®Œæˆ**

3. âœ… **ä¿®æ­£æ ‡å‡†å·®è®¡ç®—**
   - æ–‡ä»¶: `statisticalAnalysis.ts`, `calculationUtils.ts`
   - ä½¿ç”¨ n-1 æ ·æœ¬æ ‡å‡†å·®

4. âœ… **ä¿®å¤è´¡çŒ®ç‡è´Ÿå€¼é—®é¢˜**
   - æ–‡ä»¶: `src/utils/statistics.ts:386-393`
   - å¤„ç†å¹´çº§ä¸‹é™åœºæ™¯

5. âœ… **æ·»åŠ æœ€å°æ ·æœ¬é‡æ£€æŸ¥**
   - æ–°å¢ `validateSampleSize` å‡½æ•°
   - åœ¨æ‰€æœ‰ç»Ÿè®¡è®¡ç®—å‰è°ƒç”¨

---

### Phase 3: ä¼˜åŒ–æ”¹è¿› (P2) - **1å‘¨å†…å®Œæˆ**

6. âš¡ **æ€§èƒ½ä¼˜åŒ–ï¼šæ‰¹é‡ç™¾åˆ†ä½æ•°è®¡ç®—**
   - å‡å°‘é‡å¤æ’åº

7. ğŸ“ **æ·»åŠ ç®—æ³•æ–‡æ¡£æ³¨é‡Š**
   - æ³¨æ˜å…¬å¼æ¥æº
   - æ·»åŠ æµ‹è¯•ç”¨ä¾‹

8. ğŸ§ª **è¡¥å……å•å…ƒæµ‹è¯•**
   - è¾¹ç•Œæ¡ä»¶æµ‹è¯•
   - æç«¯å€¼æµ‹è¯•

---

## ğŸ§ª æ¨èæµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•å¥—ä»¶1: å¢å€¼ç‡è®¡ç®—

```typescript
describe('calculateScoreValueAddedRate', () => {
  test('æä½åˆ†å­¦ç”Ÿå¤§å¹…è¿›æ­¥', () => {
    // å…¥å£Z = -6, å‡ºå£Z = 0
    expect(calculateScoreValueAddedRate(-6, 0)).toBe(6);
  });

  test('å¹³å‡åˆ†å­¦ç”Ÿè¿›æ­¥', () => {
    expect(calculateScoreValueAddedRate(0, 1)).toBe(1);
  });

  test('ä¼˜ç§€å­¦ç”Ÿé€€æ­¥', () => {
    expect(calculateScoreValueAddedRate(2, 1)).toBe(-1);
  });

  test('é›¶å¢é•¿', () => {
    expect(calculateScoreValueAddedRate(0, 0)).toBe(0);
  });
});
```

---

### æµ‹è¯•å¥—ä»¶2: ç™¾åˆ†ä½æ•°è®¡ç®—

```typescript
describe('calculatePercentile', () => {
  const scores = [100, 90, 80, 70, 60, 50, 40, 30, 20, 10];

  test('æœ€é«˜åˆ†åº”è¯¥æ˜¯0ç™¾åˆ†ä½', () => {
    expect(calculatePercentile(100, scores)).toBe(0);
  });

  test('ä¸­ä½æ•°åº”è¯¥æ˜¯50%ç™¾åˆ†ä½', () => {
    const median = 55;
    const percentile = calculatePercentile(median, scores);
    expect(percentile).toBeCloseTo(0.5, 1);
  });

  test('æœ€ä½åˆ†åº”è¯¥æ˜¯100%ç™¾åˆ†ä½', () => {
    expect(calculatePercentile(10, scores)).toBe(1);
  });
});
```

---

### æµ‹è¯•å¥—ä»¶3: è¾¹ç•Œæ¡ä»¶

```typescript
describe('è¾¹ç•Œæ¡ä»¶', () => {
  test('ç©ºæ•°ç»„', () => {
    expect(calculateZScores([])).toEqual([]);
    expect(calculateStandardDeviation([])).toBe(0);
  });

  test('å•ä¸ªå…ƒç´ ', () => {
    expect(calculateStandardDeviation([100])).toBe(0);
  });

  test('æ‰€æœ‰å€¼ç›¸åŒ', () => {
    const same = [50, 50, 50, 50];
    expect(calculateStandardDeviation(same)).toBe(0);
    expect(calculateZScores(same)).toEqual([0, 0, 0, 0]);
  });

  test('è´Ÿæ•°', () => {
    const negative = [-10, -5, 0, 5, 10];
    const zScores = calculateZScores(negative);
    expect(zScores[0]).toBeCloseTo(-1.41, 2);
    expect(zScores[2]).toBeCloseTo(0, 2);
  });
});
```

---

## ğŸ“š å‚è€ƒèµ„æ–™ä¸å»ºè®®

### ç»Ÿè®¡å­¦æ ‡å‡†

1. **æ ‡å‡†å·®è®¡ç®—**:
   - æ€»ä½“æ ‡å‡†å·®: Ïƒ = âˆš[Î£(x-Î¼)Â² / N]
   - æ ·æœ¬æ ‡å‡†å·®: s = âˆš[Î£(x-xÌ„)Â² / (n-1)]
   - **æ•™è‚²ç»Ÿè®¡å»ºè®®**: ä½¿ç”¨æ ·æœ¬æ ‡å‡†å·®

2. **ç™¾åˆ†ä½æ•°è®¡ç®—**:
   - å‚è€ƒ Rè¯­è¨€ `quantile()` å‡½æ•°çš„ Type 7 æ–¹æ³•ï¼ˆé»˜è®¤ï¼‰
   - ä½¿ç”¨çº¿æ€§æ’å€¼

3. **å¢å€¼è¯„ä»·å…¬å¼**:
   - å‚è€ƒæ±‡ä¼˜è¯„ã€è…¾è®¯å¢å€¼è¯„ä»·ç³»ç»Ÿ
   - æ ¸å¿ƒ: æ§åˆ¶å…¥å£å·®å¼‚ï¼Œæµ‹é‡å‡ºå£å˜åŒ–
   - å…¬å¼: Î” = Z_exit - Z_entry

---

### ç®—æ³•ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ä¸­é—´ç»“æœ**:
   - æ’åºåçš„æ•°ç»„
   - ç»Ÿè®¡æŒ‡æ ‡(å‡å€¼ã€æ ‡å‡†å·®)

2. **æ‰¹é‡è®¡ç®—**:
   - ä¸€æ¬¡æ€§è®¡ç®—æ‰€æœ‰ç™¾åˆ†ä½æ•°
   - é¿å…é‡å¤æ’åº

3. **å¹¶è¡Œè®¡ç®—**:
   - å¤šç­çº§/å¤šç§‘ç›®å¯å¹¶è¡Œ
   - ä½¿ç”¨ Web Workers

---

## âœ… æ€»ç»“ä¸å»ºè®®

### æ ¸å¿ƒé—®é¢˜

1. **å¢å€¼ç‡å…¬å¼å­˜åœ¨è‡´å‘½ç¼ºé™·** - å¿…é¡»ç«‹å³ä¿®å¤
2. **ç™¾åˆ†ä½æ•°è®¡ç®—ä¸ç»Ÿä¸€** - å½±å“ç­‰çº§åˆ’åˆ†å‡†ç¡®æ€§
3. **æ ‡å‡†å·®ä½¿ç”¨æ€»ä½“å…¬å¼** - åº”æ”¹ä¸ºæ ·æœ¬æ ‡å‡†å·®
4. **è¾¹ç•Œæ¡ä»¶ä¿æŠ¤ä¸å®Œæ•´** - éœ€è¦è¡¥å……

### æ­£ç¡®çš„éƒ¨åˆ†

- âœ… Z-scoreåŸºç¡€è®¡ç®—æ­£ç¡®
- âœ… çº¿æ€§å›å½’å®ç°ä¸“ä¸š
- âœ… å¼‚å¸¸å€¼æ£€æµ‹æ–¹æ³•æ ‡å‡†
- âœ… å·©å›ºç‡/è½¬åŒ–ç‡é€»è¾‘æ¸…æ™°

### ä¼˜å…ˆçº§å»ºè®®

**P0 (ç«‹å³)**: ä¿®å¤å¢å€¼ç‡å’Œç™¾åˆ†ä½æ•°è®¡ç®—
**P1 (æœ¬å‘¨)**: ä¿®æ­£æ ‡å‡†å·®å…¬å¼ï¼Œå¤„ç†è¾¹ç•Œæ¡ä»¶
**P2 (2å‘¨)**: æ€§èƒ½ä¼˜åŒ–ï¼Œè¡¥å……æµ‹è¯•

### é£é™©è¯„ä¼°

- ğŸ”´ **é«˜é£é™©**: å¢å€¼ç‡é”™è¯¯å¯¼è‡´è¯„ä»·å¤±æ•ˆ
- ğŸŸ¡ **ä¸­é£é™©**: æ ‡å‡†å·®è¯¯å·®å½±å“ç­‰çº§åˆ’åˆ†
- ğŸŸ¢ **ä½é£é™©**: æ€§èƒ½é—®é¢˜(æ•°æ®é‡<10000å¯å¿½ç•¥)

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-11 18:30
**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**: è¯·å›¢é˜Ÿleadç¡®è®¤ä¿®å¤ä¼˜å…ˆçº§å¹¶åˆ†é…ä»»åŠ¡

